<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>

<!-- PWA / Home-screen meta -->
<meta name="theme-color" content="#2f4a3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Book Club">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link id="app-manifest" rel="manifest">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAADYCAQAAAAzSx0mAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE="/>

<style>
  :root{
    --pine:#1f3b31;
    --spruce:#2e5648;
    --sage:#9aaea0;
    --silver:#c2c7c9;
    --mist:#f0e2d7;
    --accent:#c68663;
    --ink:#233a33;
    --muted:#4a5550;
    --line:#d7dfdb;
    --gold:#b8860b;
    --glass:rgba(255,255,255,.18);
    --glass-2:rgba(255,255,255,.28);
    --shadow:0 14px 28px rgba(0,0,0,.10);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
    background:
      radial-gradient(1200px 600px at 50% -200px, var(--mist) 0%, transparent 60%),
      linear-gradient(135deg,var(--spruce) 0%,var(--pine) 45%,var(--sage) 100%);
    min-height:100vh;padding:14px;color:var(--ink)
  }
  .container{max-width:1100px;margin:0 auto}
  .header{color:#fff;text-align:center;margin-bottom:14px}
  .header h1{font-size:1.8rem;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,.25)}
  .header p{opacity:.95;font-size:.95rem}

  .user-bar{display:none;justify-content:space-between;align-items:center;background:var(--glass);padding:6px 12px;border-radius:14px;color:#fff;margin:10px 0;backdrop-filter:blur(10px);border:1px solid var(--glass-2)}
  .toolbar{display:flex;gap:6px}
  .pill-btn{
    background:var(--pine);
    border:2px solid #0d1b16;
    color:#fff;
    padding:6px 12px;
    border-radius:999px;
    cursor:pointer;font-size:12px;font-weight:700
  }
  .pill-btn:hover{filter:brightness(1.08)}
  .pill-btn:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}
  .status-chip{margin-left:8px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.6);opacity:.9}

  .top-row{display:grid;grid-template-columns:1.1fr 1fr;gap:10px;margin:8px 0 14px}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .stat{background:var(--glass);padding:8px 10px;border-radius:12px;color:#fff;border:1px solid var(--glass-2);backdrop-filter:blur(12px);font-size:12px;display:flex;align-items:center;gap:8px;cursor:pointer}
  .stat strong{font-size:18px;line-height:1}
  .users-pop{position:absolute;background:#fff;border:1px solid #e6ece8;border-radius:8px;box-shadow:0 10px 22px rgba(0,0,0,.12);padding:8px 10px;display:none;z-index:40}
  .leaderboard{background:#faf9f6;border-radius:12px;padding:10px;box-shadow:var(--shadow);display:grid;grid-template-columns:repeat(3,1fr);gap:10px;border:1px solid var(--line)}
  .lb-card{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f7f9f8}
  .lb-card h3{font-size:14px;color:#1b2a23;margin-bottom:6px}
  .lb-list{display:grid;gap:6px}
  .lb-row{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#20362c}
  .lb-count{background:#e8efe9;border:1px solid #b9c9bf;color:#1b2a23;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}

  .content{background:#fbfbf7;border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--line)}

  .prelogin-row{display:none;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
  .activity{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:0;background:#f9fbfa}
  .activity-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .activity-head h3{font-size:14px;color:#1b2a23}
  .activity-body{max-height:180px;overflow:auto}
  .activity.compact .activity-body{max-height:120px}
  .a-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid #edf3ef;font-size:13px;color:#233a33}
  .a-item:last-child{border-bottom:none}
  .a-badge{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff6e6;font-size:14px}
  .a-meta{font-size:11px;color:#6b7771;margin-top:2px}
  .pill{border:1px solid #b9c9bf;background:#f1f6f3;color:#1b2a23;padding:0 6px;border-radius:999px;font-size:11px;margin-left:6px}

  .nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .nav-btn{
    background:var(--pine);
    color:#fff;
    border:2px solid #0d1b16;
    padding:8px 14px;border-radius:22px;cursor:pointer;transition:.2s;font-size:13px;font-weight:800
  }
  .nav-btn:hover,.nav-btn.active{filter:brightness(1.1)}
  .nav-btn:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}

  .search{display:grid;grid-template-columns:2fr 1fr repeat(3,1fr);gap:8px;margin:8px 0}
  .chip{background:#e8efe9;border:1px solid #b9c9bf;color:#13211b;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700}

  .section{display:none}.section.active{display:block}

  .feed{display:flex;flex-direction:column;gap:12px}
  .post{border:1px solid var(--line);border-left:6px solid var(--pine);border-radius:12px;padding:14px;box-shadow:0 8px 16px rgba(0,0,0,.06);background:#fffefb}
  .head{display:flex;gap:12px;align-items:flex-start}
  .cover{width:78px;height:116px;object-fit:cover;border-radius:8px;border:1px solid #e6ece8;flex-shrink:0}
  .cover-ph{width:78px;height:116px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#2d3436;flex-shrink:0}
  .info{flex:1}
  .genre{background:var(--pine);color:#fff;padding:2px 8px;border-radius:14px;font-size:11px;font-weight:800;display:inline-block;margin-bottom:6px;border:2px solid #0d1b16}
  .title{font-size:1.12rem;font-weight:900;color:var(--ink);line-height:1.2}
  .author{color:#2a3a33;font-style:italic;margin:2px 0 4px;font-size:13px}
  .recommender{font-size:.95rem;color:#234338;font-weight:800;margin-bottom:4px}
  .rating-line{display:flex;align-items:center;gap:8px;font-size:12px;margin:2px 0 6px;color:#2a3a33}
  .stars{display:flex;gap:2px}
  .star{font-size:16px;color:#d0d5cf;background:none;border:none;cursor:pointer;padding:0 2px}
  .star.filled{color:var(--gold)}
  .tags{display:flex;flex-wrap:wrap;gap:4px}
  .tag{background:#eef4ef;border:1px solid #b9c9bf;color:#1b2a23;padding:1px 6px;border-radius:999px;font-size:11px;font-weight:700}

  .reason-title{font-weight:900;color:#1b2a23;margin:6px 0 2px}
  .syn,.why{color:#2a3a33;line-height:1.4;font-size:14px}

  .actions{display:flex;gap:8px;align-items:center;padding:8px 0;border-top:1px solid #e5ece8;border-bottom:1px solid #e5ece8;margin:8px 0 6px;flex-wrap:wrap}
  .action{background:#fff;border:2px solid var(--pine);color:#var(--pine);padding:6px 10px;border-radius:18px;cursor:pointer;transition:.2s;font-size:13px;display:flex;align-items:center;gap:6px;font-weight:800}
  .action:hover,.action.active{background:var(--pine);color:#fff}
  .action:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}

  .status-note{font-size:12px;color:#27443a;margin-top:4px}

  .comments{margin-top:6px}
  .c-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  .c-title{font-weight:900;color:#27443a;font-size:13px}
  .c-toggle{background:#fff;border:2px solid var(--pine);border-radius:999px;font-size:11px;padding:4px 10px;cursor:pointer;color:#2f4a3e;font-weight:800}
  .c-toggle:hover{background:#2f4a3e;color:#fff}
  .c-list{display:grid;gap:6px;max-height:260px;overflow:auto}
  .c-item{background:#f5f8f6;border:1px solid #dbe5de;border-radius:8px;padding:8px}
  .c-headline{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:13px}
  .c-name{font-weight:900;color:#27443a}
  .c-like{background:none;border:none;color:#355e4e;font-size:12px;cursor:pointer;font-weight:800}
  .c-like.liked{color:#173328}
  .c-text{color:#2a3a33;font-size:13px}
  .c-form{display:grid;grid-template-columns:140px 1fr 120px;gap:6px;margin-top:6px}
  .c-input,.c-textarea{padding:8px;border:2px solid var(--line);border-radius:8px;font-size:13px;background:#fffefb}
  .c-btn{background:var(--pine);color:#fff;border:2px solid #0d1b16;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900}

  .login{padding:40px 12px;text-align:center}
  .login-card{background:#faf9f6;padding:28px;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.12);max-width:420px;margin:0 auto;border:1px solid var(--line)}
  .input,.select,.textarea{width:100%;padding:10px;border:2px solid var(--line);border-radius:8px;font-size:15px;transition:.2s border-color;color:var(--ink);background:#fffefb}
  .textarea{resize:vertical;min-height:90px}
  .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--pine)}
  .select{background:#fffefb}

  .small{font-size:12px;color:#2b3832}

  .toast{position:fixed;bottom:18px;right:18px;background:#1d1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#b74a4a}
  .loading{opacity:.6;pointer-events:none}

  #finish-modal{ right:auto; left:50%; pointer-events:auto; }
  #finish-modal.show{ transform:translate(-50%,0); }
  #finish-modal .small{ color:#e8ecef; }
  #finish-modal { pointer-events: auto; }
  #finish-modal.show { transform: translate(-50%, 0); }

  .spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-radius:50%;border-top-color:#666;animation:spin .8s linear infinite;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}

  .results-bar{display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px;gap:8px;flex-wrap:nowrap}
  .results-right{display:flex;gap:6px;align-items:center;white-space:nowrap}

  /* Book-card activity block */
  .b-activity{margin:6px 0}
  .b-activity .c-item{background:#fff;border:1px solid #e6ece8}

  @media(max-width:840px){
    .top-row{grid-template-columns:1fr}
    .leaderboard{grid-template-columns:1fr}
    .search{grid-template-columns:1fr 1fr 1fr}
    .c-form{grid-template-columns:1fr}
    .prelogin-row{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .search{ grid-template-columns:1fr !important; }
    .results-bar{ flex-wrap:wrap; gap:6px; }
    .results-right{ width:100%; justify-content:space-between; }
    .users-pop{ max-width:calc(100vw - 24px); left:12px !important; right:12px !important; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Book Club</h1>
      <p>Find your next favorite book</p>
    </div>

    <div id="user-bar" class="user-bar">
      <span>Welcome, <strong id="current-user-name"></strong>!</span>
      <div class="toolbar">
        <button class="pill-btn" id="logout-btn" type="button">Switch User</button>
      </div>
    </div>

    <div class="top-row">
      <div class="stats" id="stats">
        <div class="stat" id="stat-books" title="Jump to feed">
          <strong id="total-books">0</strong> books
        </div>
        <div class="stat"><strong id="total-reviews">0</strong> comments</div>
        <div class="stat"><strong id="avg-rating">0.0</strong> avg ★</div>
        <div class="stat" title="Total finished books"><strong id="books-read">0</strong> read</div>
        <div class="stat" id="users-chip">
          <strong id="total-users">0</strong> users
        </div>
        <div id="users-pop" class="users-pop"></div>
      </div>

      <div class="leaderboard" id="leaderboard">
        <div class="lb-card">
          <h3>Top Recommenders</h3>
          <div id="lb-recommenders" class="lb-list"></div>
        </div>
        <div class="lb-card">
          <h3>Top Readers</h3>
          <div id="lb-readers" class="lb-list"></div>
        </div>
        <div class="lb-card">
          <h3>Most Active</h3>
          <div id="lb-active" class="lb-list"></div>
        </div>
      </div>
    </div>

    <main class="content">
      <div id="prelogin-row" class="prelogin-row">
        <section class="activity compact" id="activity-block">
          <div class="activity-head">
            <h3>Activity</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="activity-filter" class="select" style="padding:4px 8px;font-size:12px;min-width:auto">
                <option value="">All</option>
                <option value="share">New Books</option>
                <option value="list">List Actions</option>
                <option value="finish">Finished</option>
                <option value="five">5★ Ratings</option>
                <option value="like">Likes</option>
                <option value="comment">Comments</option>
              </select>
              <button id="activity-toggle" class="pill-btn" type="button">More</button>
            </div>
          </div>
          <div id="activity-list" class="activity-body"></div>
        </section>

        <section class="activity compact" id="trending-wrap">
          <div class="activity-head">
            <h3>Trending</h3>
          </div>
          <div id="trending-prelogin" class="activity-body"></div>
        </section>
      </div>

      <nav class="nav" id="main-nav">
        <button class="nav-btn active" id="feed-btn" type="button">Book Feed</button>
        <button class="nav-btn" id="add-btn" type="button">Add Book</button>
        <button class="nav-btn" id="my-books-btn" type="button">My Lists</button>
        <button class="nav-btn" id="prefs-btn" type="button">Preferences</button>
      </nav>

      <section id="login-section" class="login">
        <form class="login-card" id="login-form">
          <h2>Welcome to Book Club</h2>
          <p class="small" style="margin:6px 0 12px">Enter your first name to use your lists</p>
          <div style="margin-bottom:10px;background:#f7f8f8;padding:8px;border-radius:8px;color:#1b2a23;font-size:12px;border:1px solid var(--line)">
            This site doesn’t auto-log you in on refresh. Type the same name again to see your lists.
          </div>
          <input class="input" type="text" id="username-input" placeholder="Your first name" required style="text-align:center"/>
          <div style="height:8px"></div>
          <button class="nav-btn" type="submit">Enter</button>
        </form>
      </section>

      <section id="main-app" style="display:none">
        <section id="feed" class="section active">
          <div class="search">
            <input type="text" class="input" placeholder="Search title, author, recommender…" id="search-input"/>
            <select class="select" id="tag-filter">
              <option value="">All Tags</option>
            </select>
            <select class="select" id="category-filter">
              <option value="">All Categories</option>
            </select>
            <select class="select" id="recommender-filter">
              <option value="">All Recommenders</option>
            </select>
            <select class="select" id="min-rating">
              <option value="0">Min ★ (Any)</option>
              <option value="5">5★</option>
              <option value="4">4★+</option>
              <option value="3">3★+</option>
            </select>
          </div>

          <div class="results-bar">
            <span class="chip" id="result-count"></span>
            <div class="results-right">
              <label class="small"><input type="checkbox" id="collapse-all"> Collapse all comments</label>
              <select class="select" id="sort-by" style="max-width:180px">
                <option value="new">Newest</option>
                <option value="likes">Most Likes</option>
                <option value="rating">Highest Rated</option>
                <option value="title">Title A–Z</option>
              </select>
            </div>
          </div>

          <div id="books-feed" class="feed"></div>
        </section>

        <section id="add" class="section">
          <div class="lb-card" style="margin-bottom:10px">
            <h3>Share a Book Recommendation</h3>

            <div class="search" style="grid-template-columns:2fr 1fr">
              <div class="dropdown" style="position:relative">
                <input id="book-search" class="input" type="text" placeholder="Search Google Books to auto-fill…"/>
                <div id="book-results" class="users-pop" style="left:0;right:0;max-height:280px;overflow:auto"></div>
              </div>
              <div>
                <label class="small">Rating (click stars below)</label>
                <div class="stars" id="rating-stars" aria-label="rating stars">
                  <button class="star" type="button" data-rating="1">★</button>
                  <button class="star" type="button" data-rating="2">★</button>
                  <button class="star" type="button" data-rating="3">★</button>
                  <button class="star" type="button" data-rating="4">★</button>
                  <button class="star" type="button" data-rating="5">★</button>
                </div>
                <div id="rating-feedback" class="small">Click stars to rate (required)</div>
              </div>
            </div>

            <form id="book-form">
              <div class="search" style="grid-template-columns:1fr 1fr 1fr">
                <div><label class="small">Title *</label><input class="input" type="text" id="title" required/></div>
                <div><label class="small">Author *</label><input class="input" type="text" id="author" required/></div>
                <div>
                  <label class="small">Category</label>
                  <select class="select" id="genre"></select>
                </div>
              </div>

              <div class="search" style="grid-template-columns:1fr 1fr">
                <div><label class="small">Your Name *</label><input class="input" type="text" id="recommender" required/></div>
                <div><label class="small">Cover Image (URL)</label><input class="input" type="url" id="book-image" placeholder="https://…"/></div>
              </div>

              <div><label class="small">Synopsis</label><textarea class="textarea" id="synopsis" placeholder="Book description (auto-filled when available)…"></textarea></div>

              <div>
                <label class="small">Why I recommend this * <span class="small" style="opacity:.8">(Choose a style below and click “Suggest Reason” to auto-generate text, then edit)</span></label>
                <div class="search" style="grid-template-columns:1fr auto">
                  <select id="reason-tone" class="select" aria-label="Style for auto-generate">
                    <option value="personal">Style: Personal</option>
                    <option value="hook">Style: Hook/Catchy</option>
                    <option value="professional">Style: Professional</option>
                    <option value="concise">Style: Concise</option>
                  </select>
                  <button id="reason-suggest" type="button" class="nav-btn" title="Auto-generate reason text">Suggest Reason (auto)</button>
                </div>
                <textarea class="textarea" id="reason" placeholder="Your reason (you can auto-generate above)"></textarea>
              </div>

              <div>
                <label class="small">Tags</label>
                <div class="tags-input-container" id="tags-container" style="border:2px solid var(--line);border-radius:8px;padding:6px;background:#fffefb">
                  <div id="tags-display" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px"></div>
                  <input type="text" class="input" id="tag-input" placeholder="Add tags…" enterkeyhint="done" autocomplete="off" style="border:0;padding:6px;background:transparent"/>
                  <div class="users-pop" id="tag-suggestions" style="display:none"></div>
                </div>
              </div>

              <div style="height:6px"></div>
              <button type="submit" class="nav-btn">Share Book</button>
            </form>
          </div>
        </section>

        <section id="my-books" class="section">
          <h3 style="margin-bottom:8px">My Reading Lists</h3>
          <div class="lb-card" style="margin-bottom:8px">
            <h4>Want to Read</h4>
            <div id="wish-list"></div>
          </div>
          <div class="lb-card" style="margin-bottom:8px">
            <h4>Currently Reading</h4>
            <div id="current-reading"></div>
          </div>
          <div class="lb-card">
            <h4>Read</h4>
            <div id="read-list"></div>
          </div>
        </section>

        <section id="prefs" class="section">
          <h2 style="margin-bottom:8px;color:var(--ink);font-size:1.1rem">Preferences</h2>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Posting & Feed</h3>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <label><input id="pref-post-new" type="checkbox" checked/> Post on <strong>new book</strong></label>
              <label><input id="pref-post-finish" type="checkbox" checked/> Post when someone <strong>finishes a book</strong></label>
              <label><input id="pref-post-5" type="checkbox" checked/> Post for <strong>new 5★ ratings</strong></label>
              <button id="prefs-save" class="nav-btn" type="button">Save</button>
            </div>
          </div>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Install on Your Phone</h3>
            <p class="small">Add Book Club to your home screen so it opens like an app.</p>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button id="install-app-btn" class="nav-btn" type="button">Install App</button>
              <span id="install-status" class="chip">Not installed</span>
            </div>
            <details id="ios-steps" style="margin-top:6px">
              <summary>iPhone / iPad steps</summary>
              <ol style="margin:6px 0 0 18px">
                <li>Open this page in <strong>Safari</strong>.</li>
                <li>Tap <strong>Share</strong> → <strong>Add to Home Screen</strong>.</li>
                <li>Tap <strong>Add</strong>.</li>
              </ol>
              <p class="small">On iOS Chrome: Share → “Add to Home Screen”.</p>
            </details>
          </div>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Writing Assistant</h3>
            <p class="small">Use built-in suggestions, or paste an OpenAI API key to upgrade results. The key is stored only on this device.</p>
            <div class="search" style="grid-template-columns:1fr auto auto">
              <input id="openai-key" class="input" placeholder="sk-… (optional)"/>
              <button id="save-openai-key" class="nav-btn" type="button">Save Key</button>
              <button id="clear-openai-key" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear</button>
            </div>
          </div>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Export / Backup</h3>
            <p class="small">Downloads Excel-friendly CSV files (books.csv and comments.csv) + JSON.</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="export-csv-btn" class="nav-btn" type="button">Download CSVs</button>
              <button id="export-json-btn" class="nav-btn" type="button">Download JSON</button>
              <label class="nav-btn" style="cursor:pointer">
                Import JSON<input type="file" id="import-json" accept="application/json" style="display:none">
              </label>
            </div>
          </div>

          <div class="lb-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Admin Options</h3>
              <button id="toggle-danger" class="pill-btn" type="button">Open Admin Options</button>
            </div>
            <div id="data-management" style="display:none;margin-top:8px">
              <div style="display:grid;gap:8px">
                <button id="clear-data-btn" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear ALL Data</button>

                <div class="search" style="grid-template-columns:1fr 1fr auto">
                  <input id="rename-from" class="input" placeholder="Rename / merge: From name">
                  <input id="rename-to" class="input" placeholder="To name">
                  <button id="rename-user-btn" class="nav-btn" type="button">Rename / Merge</button>
                </div>

                <div class="search" style="grid-template-columns:1fr auto">
                  <input id="delete-book-id" class="input" placeholder="Delete book by ID">
                  <button id="delete-book-btn" class="nav-btn" type="button">Delete Book</button>
                </div>
                <div class="search" style="grid-template-columns:1fr auto auto">
                  <input id="activity-days" class="input" placeholder="Purge activity older than N days">
                  <button id="purge-activity-btn" class="nav-btn" type="button">Purge Activity</button>
                  <button id="delete-last-activity-btn" class="nav-btn" type="button">Delete Most Recent Activity</button>
                </div>

                <div class="search" style="grid-template-columns:1fr auto">
                  <input id="pref-teams-url" class="input" type="url" placeholder="Teams Incoming Webhook URL"/>
                  <button id="save-teams-btn" class="nav-btn" type="button">Save Teams URL</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <div id="finish-modal" class="toast" style="left:50%;transform:translate(-50%,0);bottom:auto;top:20%;max-width:520px">
    <div>
      <h3 id="finish-heading" style="margin-bottom:6px">Rate this book</h3>
      <p id="finish-title" class="small" style="margin-bottom:6px"></p>
      <div class="stars" id="finish-stars" style="margin:6px 0 4px">
        <button class="star" data-rating="1" type="button">★</button>
        <button class="star" data-rating="2" type="button">★</button>
        <button class="star" data-rating="3" type="button">★</button>
        <button class="star" data-rating="4" type="button">★</button>
        <button class="star" data-rating="5" type="button">★</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="nav-btn" id="finish-save" type="button">Save</button>
        <button class="nav-btn" id="finish-cancel" type="button" style="background:#b74a4a;border-color:#5c1f1f">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ===== Helpers with old-browser safety ===== */
function rAll(str, search, replacement){ return String(str).split(search).join(replacement); }
function escapeHtml(s){ s=String(s==null?'':s); s=rAll(s,'&','&amp;'); s=rAll(s,'<','&lt;'); s=rAll(s,'>','&gt;'); return s; }
function escapeAttr(s){ return rAll(escapeHtml(s),'\"','&quot;'); }

/* ========= JSONBin Storage & State ========= */
const JSONBIN_API = 'https://api.jsonbin.io/v3';
const BIN_ID = '68b3dae843b1c97be931c000';
const API_KEY = '$2a$10$1k.Aw1WU5YTjSlKmSLGQ3eK6gaEhRB/j.FzTEtMp7Ardqd7vI4i4C';
const ADMIN_PASSWORD = 'Prob1234';

let currentUser='';
let books=[]; 
let userData={}; 
let activity=[]; 
let sitePrefs={teamsWebhook:'',postNew:true,postFinish:true,postFive:true,openaiKey:''};

let isLoading=false;
let currentTags = [];
let currentRating=0;
let finishContext=null; 
let activityExpanded=false;
let lastSearchItems=[];
let deferredPrompt=null;

/* ========= Utilities ========= */
var $  = function(sel, root){ return (root||document).querySelector(sel); };
var $$ = function(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); };
var now=function(){ return new Date().toISOString(); };
var timeAgo=function(iso){
  var d=new Date(iso); var s=(Date.now()-d)/1000;
  if(s<60)return String(Math.floor(s))+'s';
  var m=s/60; if(m<60)return String(Math.floor(m))+'m';
  var h=m/60; if(h<24)return String(Math.floor(h))+'h';
  return String(Math.floor(h/24))+'d';
};
var truncate=function(s,n){ s=String(s||''); n=n||300; return s.length>n? s.slice(0,n-1)+'…' : s; };
var setLoading=function(el,loading){
  if(!el)return;
  el.classList.toggle('loading',!!loading);
  var sp=el.querySelector('.spinner');
  if(loading && !sp){ var span=document.createElement('span'); span.className='spinner'; el.prepend(span); }
  else if(!loading && sp){ sp.parentNode.removeChild(sp); }
};
var showToast=function(msg,isError){
  var t=$('#toast'); t.textContent=msg;
  t.classList.toggle('error',!!isError); t.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t=setTimeout(function(){ t.classList.remove('show'); }, isError?3200:1800);
};
var formatDate=function(v){ var n=Number(v); var d=new Date(isFinite(n)?n:v); return d.toLocaleDateString(); };

/* ========= Local & Remote ========= */
async function loadAll(){
  if(isLoading) return; 
  isLoading = true;
  try{
    var cached = JSON.parse(localStorage.getItem('bookclub_payload')||'{}');
    if(cached.books) books = cached.books;
    if(cached.userData) userData = cached.userData;
    if(cached.activity) activity = cached.activity;
    if(cached.sitePrefs) for(var k in cached.sitePrefs){ sitePrefs[k]=cached.sitePrefs[k]; }
  }catch(_e){}

  try{
    const r = await fetch(JSONBIN_API+'/b/'+BIN_ID+'/latest',{headers:{'X-Master-Key':API_KEY}});
    if(!r.ok) throw new Error(await r.text());
    const data=await r.json();
    const record=data.record||{};
    books=record.books||books||[];
    userData=record.userData||userData||{};
    activity=record.activity||activity||[];
    for(var k2 in (record.sitePrefs||{})){ sitePrefs[k2]=record.sitePrefs[k2]; }
    localStorage.setItem('bookclub_payload', JSON.stringify({books,userData,activity,sitePrefs}));
  }catch(e){
    console.warn('Using local data; sync failed.', e);
  }
  isLoading=false;
}
async function saveAll(){
  try{ localStorage.setItem('bookclub_payload', JSON.stringify({books,userData,activity,sitePrefs})); }catch(_e){}
  try{
    const payload={books,userData,activity,sitePrefs};
    await fetch(JSONBIN_API+'/b/'+BIN_ID,{
      method:'PUT',
      headers:{'Content-Type':'application/json','X-Master-Key':API_KEY},
      body:JSON.stringify(payload)
    });
  }catch(e){
    console.warn('Remote save failed',e);
  }
}

function defaultUser(){ return {readList:[],wishList:[],currentReading:[]}; }
function ensureUser(name){ if(!userData[name]) userData[name]=defaultUser(); }
function me(){ return userData[currentUser]||defaultUser(); }

/* ========= PWA ========= */
function setupPWA(){
  try{
    const manifest={name:"Book Club",short_name:"Book Club",start_url:".",display:"standalone",background_color:"#ffffff",theme_color:"#2f4a3e",icons:[{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAAAAABQFZ1hAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE=",sizes:"192x192",type:"image/png"}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const url=URL.createObjectURL(blob);
    const link=$('#app-manifest'); if(link) link.href=url;

    if('serviceWorker' in navigator && (location.protocol==='https:' || location.hostname==='localhost')){
      const sw="self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('bc-v1').then(c=>c.addAll(['./'])))});self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))})";
      const swUrl=URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
      navigator.serviceWorker.register(swUrl).catch(function(){});
    }
    const status=$('#install-status');
    const standalone=window.matchMedia && window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true;
    if(status) status.textContent=standalone?'Installed':'Not installed';
    window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();deferredPrompt=e; if(status) status.textContent='Install available';});
  }catch(_e){}
}

/* ========= Teams ========= */
async function postToTeams(type,text){
  const url=(sitePrefs.teamsWebhook||'').trim(); if(!url) return;
  const allow=(type==='share'&&sitePrefs.postNew)||(type==='finish'&&sitePrefs.postFinish)||(type==='five'&&sitePrefs.postFive);
  if(!allow) return;
  try{ await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})}); }catch(_e){}
}

/* ========= Activity ========= */
function mergeOrPostActivity(entry){
  const last=activity[0];
  if(last && last.payload && entry.payload
      && last.payload.user===entry.payload.user
      && last.payload.title===entry.payload.title
      && (Date.now()-new Date(last.at).getTime())<120000){
    last.type='multi';
    // merge action types
    var acts = (last.payload.actions||[]).concat([entry.type]);
    var dedup = {}; last.payload.actions = acts.filter(function(x){ if(dedup[x])return false; dedup[x]=1; return true; });
    // keep/merge list action labels
    if(entry.type==='list' && entry.payload && entry.payload.action){
      last.payload.listActions = (last.payload.listActions||[]);
      last.payload.listActions.push(entry.payload.action);
      var seen={}; last.payload.listActions = last.payload.listActions.filter(function(x){ if(seen[x]) return false; seen[x]=1; return true; });
    }
    // keep strongest rating if present
    if(typeof entry.payload.rating!=='undefined'){ last.payload.rating = entry.payload.rating; }
    // keep bookId for precise linking
    if(entry.payload.bookId!=null){ last.payload.bookId = entry.payload.bookId; }
    last.at=now();
  }else{
    activity.unshift({type:entry.type,payload:entry.payload,id:Date.now()+Math.random(),likes:0,likedBy:[],at:now()});
    if(activity.length>300) activity.length=300;
  }
  renderActivity(); saveAll();
}
function postActivity(type,payload){ mergeOrPostActivity({type:type,payload:payload}); }
function activityIcon(type){
  var map={share:'📣',finish:'🏁','five':'🏆','list':'🗂️','like':'👍',comment:'💬',multi:'✨'};
  return map[type]||'📝';
}

/* ========= Ratings ========= */
function ratingCount(book){
  var base = typeof book.rating === 'number' ? 1 : 0;
  var extra = (book.userRatings && book.userRatings.length) || 0;
  return base + extra;
}
function averageRatingForBook(book){
  var vals=[];
  if(typeof book.rating==='number') vals.push(book.rating);
  (book.userRatings||[]).forEach(function(r){ if(typeof r.rating==='number') vals.push(r.rating); });
  if(!vals.length) return 0;
  return vals.reduce(function(a,b){return a+b;},0)/vals.length;
}

/* ========= Tags ========= */
var tagSuggestions = [
  'sci-fi','fantasy','romance','mystery','thriller','horror','historical-fiction',
  'young-adult','contemporary','classic','literary-fiction','dystopian',
  'leadership','business','productivity','entrepreneurship','marketing',
  'personal-development','psychology','philosophy','history','science',
  'technology','health','fitness','cooking','travel','memoir',
  'comedy','drama','adventure','coming-of-age','family',
  'friendship','war','politics','economics','environment','social-justice',
  'quick-read','page-turner','thought-provoking','emotional','inspiring',
  'educational','practical','reference','beginner-friendly','advanced',
  'true-crime','faith','christian','catholic','prayer','neuroscience','time-travel','space','post-apocalyptic'
];
function renderTagsDisplay(){
  var c=$('#tags-display');
  c.innerHTML=currentTags.map(function(t){return '<span class="tag" data-tag="'+escapeAttr(t)+'">'+escapeHtml(t)+' ×</span>';}).join('');
}
function addTag(t){
  var x=(t||'').trim().toLowerCase(); if(!x||currentTags.indexOf(x)>-1) return;
  currentTags.push(x); renderTagsDisplay();
  var ti=$('#tag-input'); if(ti) ti.value='';
  var sug=$('#tag-suggestions'); if(sug) sug.style.display='none';
}
function autoTagsFrom(book){
  var list=new Set(book.categories||[]);
  var s=String(book.synopsis||'').toLowerCase();
  var map = [
    [/science[\s-]?fiction|spaceship|space\s|alien|astrophysics/, 'sci-fi'],
    [/fantasy|dragon|magic|sorcer|wizard|fae/, 'fantasy'],
    [/mystery|detective|whodunnit|whodunit|sleuth/, 'mystery'],
    [/thriller|conspiracy|chase|assassin/, 'thriller'],
    [/romance|love\sstory|enemies to lovers/, 'romance'],
    [/horror|haunted|possession|demon|ghost/, 'horror'],
    [/young adult|ya\b/, 'young-adult'],
    [/dystopian|post[-\s]?apocalyptic|apocalypse/, 'dystopian'],
    [/time[-\s]?travel/, 'time-travel'],
    [/space|cosmos/, 'space'],
    [/history|historical/, 'history'],
    [/memoir|autobiograph/, 'memoir'],
    [/true\s?crime/, 'true-crime'],
    [/leadership|manager|team/, 'leadership'],
    [/business|startup|founder|marketing|sales/, 'business'],
    [/productivity|habits|workflow|time management/, 'productivity'],
    [/psychology|behavior|cognitive|neuroscience/, 'psychology'],
    [/neuroscience/, 'neuroscience'],
    [/philosophy|ethic|stoic/, 'philosophy'],
    [/faith|prayer|catholic|christian|saint/, 'faith']
  ];
  map.forEach(function(pair){ if(pair[0].test(s)) list.add(pair[1]); });
  if(book.genre) list.add(book.genre);
  currentTags=Array.from(new Set(currentTags.concat(Array.from(list).map(function(x){return String(x).toLowerCase();})))).slice(0,8);
  renderTagsDisplay();
}

/* ========= Rendering helpers for activity on cards ========= */
function eventsForBook(book){
  var idStr = String(book.id);
  var arr = (activity||[]).filter(function(a){
    if(!a || !a.payload) return false;
    return (String(a.payload.bookId||'')===idStr) || (a.payload.title===book.title);
  }).sort(function(a,b){ return new Date(b.at)-new Date(a.at); });
  return arr;
}
function describeActivity(a){
  var user = escapeHtml((a.payload&&a.payload.user)||'Someone');
  var la = (a.payload&&a.payload.listActions)||[];
  var actsSet={}; (a.payload&&a.payload.actions||[]).forEach(function(x){actsSet[x]=1;});
  var rating = (a.payload&&a.payload.rating);

  if(a.type==='share')  return user+' recommended this'+(rating?(' ('+rating+'★)'):'');
  if(a.type==='finish') return user+' finished this'+(rating?(' — '+rating+'★'):'');
  if(a.type==='five')   return user+' rated this 5★';
  if(a.type==='list')   return user+' '+escapeHtml((a.payload&&a.payload.action)||'updated list');
  if(a.type==='comment')return user+' commented';
  if(a.type==='like')   return user+' liked this';

  // multi
  if(actsSet.share && (actsSet.finish || actsSet.five || rating!=null)){
    return user+' recommended this and rated it '+(rating||5)+'★';
  }
  if(actsSet.like && !actsSet.list && !actsSet.share && !actsSet.finish && !actsSet.comment && !actsSet.five){
    return user+' liked this';
  }
  if(actsSet.list && !actsSet.like && !actsSet.share && !actsSet.finish && !actsSet.comment && !actsSet.five){
    return user+' '+escapeHtml(la.join(' and '));
  }
  if(actsSet.like && actsSet.list && !actsSet.share && !actsSet.finish && !actsSet.comment && !actsSet.five){
    return user+' liked and '+escapeHtml(la.join(' and '));
  }
  if(actsSet.comment && !actsSet.like && !actsSet.list && !actsSet.share && !actsSet.finish && !actsSet.five){
    return user+' commented';
  }
  return user+' updated this';
}

/* ========= Rendering ========= */
function goodreadsUrl(book){
  var q = ((book.title||'')+' '+(book.author||'')).trim();
  return 'https://www.goodreads.com/search?q='+encodeURIComponent(q)+'&search_type=books';
}
function bookCoverBlock(book){
  var link = goodreadsUrl(book);
  if(book.image){
    return '<a href="'+link+'" target="_blank" rel="noopener noreferrer"><img class="cover" loading="lazy" alt="Cover of '+escapeHtml(book.title)+'" src="'+escapeAttr(book.image)+'"/></a>';
  }
  return '<a href="'+link+'" target="_blank" rel="noopener noreferrer" class="cover-ph">No Cover</a>';
}
function youStatus(book){
  if(!currentUser) return '';
  var mine=me();
  var r=mine.readList.find(function(x){return x.id===book.id;});
  var cr=mine.currentReading.find(function(x){return x.id===book.id;});
  var w=mine.wishList.find(function(x){return x.id===book.id;});
  if(r){
    var urObj=(book.userRatings||[]).find(function(x){return x.user===currentUser;});
    var stars= (urObj?urObj.rating:undefined);
    if(stars==null) stars = (r._rating||0);
    return '<div class="status-note"><strong>You</strong> marked this read '+(stars?('— '+stars+'★'):'')+'</div>';
  }
  if(cr) return '<div class="status-note"><strong>You</strong> are reading this</div>';
  if(w)  return '<div class="status-note"><strong>You</strong> want to read this</div>';
  return '';
}
function likedByLine(arr){ arr=arr||[]; if(!arr.length) return ''; return '<div class="small"><em>Liked by:</em> '+escapeHtml(arr.join(', '))+'</div>'; }
function tagChips(tags){ if(!tags||!tags.length) return ''; return '<div class="tags">'+tags.map(function(t){return '<span class="tag">'+escapeHtml(t)+'</span>';}).join('')+'</div>'; }

function synBlock(book){
  if(!book.synopsis) return '';
  var long = book.synopsis.length>280;
  var short = truncate(book.synopsis, 280);
  return [
    '<div class="syn" data-syn="'+book.id+'">',
      '<span class="syn-text" data-expanded="false">'+escapeHtml(short)+'</span>',
      long?(' <button class="c-toggle" type="button" data-action="toggle-synopsis" data-id="'+book.id+'" data-full="'+escapeAttr(book.synopsis)+'">Read more</button>'):'',
    '</div>'
  ].join('');
}

function bookCard(book){
  var liked=currentUser && (book.postLikedBy||[]).indexOf(currentUser)>-1;
  var avg=averageRatingForBook(book);
  var rounded=Math.round(avg||0);
  var count=ratingCount(book);
  var sysCollapsed = ($('#collapse-all') && $('#collapse-all').checked) ? 'style="display:none"' : '';

  // build per-book activity list
  var evts = eventsForBook(book);
  var activityHtml = evts.length ? (
    '<div class="b-activity">'+
      '<div class="c-head"><span class="c-title">Recent Activity</span></div>'+
      '<div class="c-list">'+
        evts.map(function(a){
          return '<div class="c-item"><div class="c-headline"><span class="small">'+escapeHtml(describeActivity(a))+'</span><span class="small">'+timeAgo(a.at)+' ago</span></div></div>';
        }).join('')+
      '</div>'+
    '</div>'
  ) : '';

  return [
  '<article class="post" id="book-'+book.id+'" data-id="'+book.id+'">',
    '<div class="head">',
      bookCoverBlock(book),
      '<div class="info">',
        '<div class="genre">'+escapeHtml(book.genre)+'</div>',
        '<div class="title">'+escapeHtml(book.title)+'</div>',
        '<div class="author">by '+escapeHtml(book.author)+'</div>',
        '<div class="recommender">Recommended by '+escapeHtml(book.recommender)+'</div>',
        '<div class="small" style="color:#20362c">Recommended on '+formatDate(book.id)+'</div>',
        '<div class="rating-line">',
          '<div class="stars">'+Array(rounded+1).join('★')+Array(5-rounded+1).join('☆')+'</div>',
          '<span class="small">('+avg.toFixed(1)+'/5 • '+count+' rating'+(count===1?'':'s')+')</span>',
        '</div>',
        tagChips(book.tags),
        youStatus(book),
      '</div>',
    '</div>',

    synBlock(book),
    (book.reason?('<div class="why"><div class="reason-title">Why '+escapeHtml(book.recommender)+' recommends it</div>'+
