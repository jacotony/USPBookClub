<!DOCTYPE html>  
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>

<!-- PWA / Home-screen meta -->
<meta name="theme-color" content="#2f4a3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Book Club">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link id="app-manifest" rel="manifest">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAADYCAQAAAAzSx0mAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE="/>

<style>
  /* Seal-inspired palette (Idaho USPPS) */
  :root{
    --pine:#1f3b31;          /* darker for contrast */
    --spruce:#2e5648;        /* mid green */
    --sage:#9aaea0;          
    --silver:#c2c7c9;        
    --mist:#f0e2d7;          
    --accent:#c68663;        
    --ink:#233a33;           /* softened from near-black */
    --muted:#4a5550;         /* softened text for long blocks */
    --line:#d7dfdb;          /* softer borders */
    --gold:#b8860b; 
    --glass:rgba(255,255,255,.18);
    --glass-2:rgba(255,255,255,.28); 
    --shadow:0 14px 28px rgba(0,0,0,.10)
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
    background:
      radial-gradient(1200px 600px at 50% -200px, var(--mist) 0%, transparent 60%),
      linear-gradient(135deg,var(--spruce) 0%,var(--pine) 45%,var(--sage) 100%);
    min-height:100vh;padding:14px;color:var(--ink)
  }
  .container{max-width:1100px;margin:0 auto}
  .header{color:#fff;text-align:center;margin-bottom:14px}
  .header h1{font-size:1.8rem;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,.25)}
  .header p{opacity:.95;font-size:.95rem}

  .user-bar{display:none;justify-content:space-between;align-items:center;background:var(--glass);padding:6px 12px;border-radius:14px;color:#fff;margin:10px 0;backdrop-filter:blur(10px);border:1px solid var(--glass-2)}
  .toolbar{display:flex;gap:6px}
  .pill-btn{
    background:var(--pine);
    border:2px solid #0d1b16;
    color:#fff;
    padding:6px 12px;
    border-radius:999px;
    cursor:pointer;font-size:12px;font-weight:700
  }
  .pill-btn:hover{filter:brightness(1.08)}
  .pill-btn:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}
  .status-chip{margin-left:8px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.6);opacity:.9}

  /* top row: tiny stats & compact leaderboard */
  .top-row{display:grid;grid-template-columns:1.1fr 1fr;gap:10px;margin:8px 0 14px}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .stat{background:var(--glass);padding:8px 10px;border-radius:12px;color:#fff;border:1px solid var(--glass-2);backdrop-filter:blur(12px);font-size:12px;display:flex;align-items:center;gap:8px;cursor:pointer}
  .stat strong{font-size:18px;line-height:1}
  .users-pop{position:absolute;background:#fff;border:1px solid #e6ece8;border-radius:8px;box-shadow:0 10px 22px rgba(0,0,0,.12);padding:8px 10px;display:none;z-index:40}
  .leaderboard{background:#faf9f6;border-radius:12px;padding:10px;box-shadow:var(--shadow);display:grid;grid-template-columns:repeat(3,1fr);gap:10px;border:1px solid var(--line)}
  .lb-card{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f7f9f8}
  .lb-card h3{font-size:14px;color:#1b2a23;margin-bottom:6px}
  .lb-list{display:grid;gap:6px}
  .lb-row{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#20362c}
  .lb-count{background:#e8efe9;border:1px solid #b9c9bf;color:#1b2a23;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}

  .content{background:#fbfbf7;border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--line)}

  /* row under stats: Activity + Trending (HIDDEN until login) */
  .prelogin-row{display:none;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
  .activity{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:0;background:#f9fbfa}
  .activity-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .activity-head h3{font-size:14px;color:#1b2a23}
  .activity-body{max-height:180px;overflow:auto}
  .activity.compact .activity-body{max-height:120px}
  .a-item{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid #edf3ef;font-size:13px;color:#233a33}
  .a-item:last-child{border-bottom:none}
  .a-badge{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff6e6;font-size:14px}
  .a-meta{font-size:11px;color:#6b7771;margin-top:2px}
  .pill{border:1px solid #b9c9bf;background:#f1f6f3;color:#1b2a23;padding:0 6px;border-radius:999px;font-size:11px;margin-left:6px}

  /* toolbar/nav (hidden until login) */
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .nav-btn{
    background:var(--pine);
    color:#fff;
    border:2px solid #0d1b16;
    padding:8px 14px;border-radius:22px;cursor:pointer;transition:.2s;font-size:13px;font-weight:800
  }
  .nav-btn:hover,.nav-btn.active{filter:brightness(1.1)}
  .nav-btn:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}

  /* search row smaller */
  .search{display:grid;grid-template-columns:2fr 1fr repeat(3,1fr);gap:8px;margin:8px 0}
  .chip{background:#e8efe9;border:1px solid #b9c9bf;color:#13211b;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700}

  .section{display:none}.section.active{display:block}

  /* cards smaller */
  .feed{display:flex;flex-direction:column;gap:12px}
  .post{border:1px solid var(--line);border-left:6px solid var(--pine);border-radius:12px;padding:14px;box-shadow:0 8px 16px rgba(0,0,0,.06);background:#fffefb}
  .head{display:flex;gap:12px;align-items:flex-start}
  .cover{width:78px;height:116px;object-fit:cover;border-radius:8px;border:1px solid #e6ece8;flex-shrink:0}
  .cover-ph{width:78px;height:116px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#2d3436;flex-shrink:0}
  .info{flex:1}
  .genre{background:var(--pine);color:#fff;padding:2px 8px;border-radius:14px;font-size:11px;font-weight:800;display:inline-block;margin-bottom:6px;border:2px solid #0d1b16}
  .title{font-size:1.12rem;font-weight:900;color:var(--ink);line-height:1.2}
  .author{color:#2a3a33;font-style:italic;margin:2px 0 4px;font-size:13px}
  .recommender{font-size:.95rem;color:#234338;font-weight:800;margin-bottom:4px}
  .rating-line{display:flex;align-items:center;gap:8px;font-size:12px;margin:2px 0 6px;color:#2a3a33}
  .stars{display:flex;gap:2px}
  .star{font-size:16px;color:#d0d5cf;background:none;border:none;cursor:pointer;padding:0 2px}
  .star.filled{color:var(--gold)}
  .tags{display:flex;flex-wrap:wrap;gap:4px}
  .tag{background:#eef4ef;border:1px solid #b9c9bf;color:#1b2a23;padding:1px 6px;border-radius:999px;font-size:11px;font-weight:700}

  .reason-title{font-weight:900;color:#1b2a23;margin:6px 0 2px}
  .syn,.why{color:#2a3a33;line-height:1.4;font-size:14px}

  .actions{display:flex;gap:8px;align-items:center;padding:8px 0;border-top:1px solid #e5ece8;border-bottom:1px solid #e5ece8;margin:8px 0 6px;flex-wrap:wrap}
  .action{background:#fff;border:2px solid var(--pine);color:var(--pine);padding:6px 10px;border-radius:18px;cursor:pointer;transition:.2s;font-size:13px;display:flex;align-items:center;gap:6px;font-weight:800}
  .action:hover,.action.active{background:var(--pine);color:#fff}
  .action:focus-visible{outline:3px solid #ffe08a;outline-offset:2px}

  .status-note{font-size:12px;color:#27443a;margin-top:4px}

  /* comments smaller + collapsible */
  .comments{margin-top:6px}
  .c-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  .c-title{font-weight:900;color:#27443a;font-size:13px}
  .c-toggle{background:#fff;border:2px solid var(--pine);border-radius:999px;font-size:11px;padding:4px 10px;cursor:pointer;color:var(--pine);font-weight:800}
  .c-toggle:hover{background:var(--pine);color:#fff}
  .c-list{display:grid;gap:6px;max-height:260px;overflow:auto}
  .c-item{background:#f5f8f6;border:1px solid #dbe5de;border-radius:8px;padding:8px}
  .c-headline{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:13px}
  .c-name{font-weight:900;color:#27443a}
  .c-like{background:none;border:none;color:#355e4e;font-size:12px;cursor:pointer;font-weight:800}
  .c-like.liked{color:#173328}
  .c-text{color:#2a3a33;font-size:13px}
  .c-form{display:grid;grid-template-columns:140px 1fr 120px;gap:6px;margin-top:6px}
  .c-input,.c-textarea{padding:8px;border:2px solid var(--line);border-radius:8px;font-size:13px;background:#fffefb}
  .c-btn{background:var(--pine);color:#fff;border:2px solid #0d1b16;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:900}

  .login{padding:40px 12px;text-align:center}
  .login-card{background:#faf9f6;padding:28px;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.12);max-width:420px;margin:0 auto;border:1px solid var(--line)}
  .input,.select,.textarea{width:100%;padding:10px;border:2px solid var(--line);border-radius:8px;font-size:15px;transition:.2s border-color;color:var(--ink);background:#fffefb}
  .textarea{resize:vertical;min-height:90px}
  .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--pine)}
  .select{background:#fffefb}

  .small{font-size:12px;color:#2b3832}

  .toast{position:fixed;bottom:18px;right:18px;background:#1d1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#b74a4a}
  .loading{opacity:.6;pointer-events:none}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-radius:50%;border-top-color:#666;animation:spin .8s linear infinite;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* keep wide controls in one line */
  .results-bar{display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px;gap:8px;flex-wrap:nowrap}
  .results-right{display:flex;gap:6px;align-items:center;white-space:nowrap}

  @media(max-width:840px){
    .top-row{grid-template-columns:1fr}
    .leaderboard{grid-template-columns:1fr}
    .search{grid-template-columns:1fr 1fr 1fr}
    .c-form{grid-template-columns:1fr}
    .prelogin-row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Book Club</h1>
      <p>Find your next favorite book</p>
    </div>

    <div id="user-bar" class="user-bar">
      <span>Welcome, <strong id="current-user-name"></strong>!</span>
      <div class="toolbar">
        <button class="pill-btn" id="logout-btn" type="button">Switch User</button>
      </div>
    </div>

    <!-- Compact top row: stats + leaderboard -->
    <div class="top-row">
      <div class="stats" id="stats">
        <div class="stat" id="stat-books" title="Jump to feed">
          <strong id="total-books">0</strong> books
        </div>
        <div class="stat"><strong id="total-reviews">0</strong> comments</div>
        <div class="stat"><strong id="avg-rating">0.0</strong> avg ★</div>
        <!-- renamed label per request -->
        <div class="stat" title="Total finished books"><strong id="books-read">0</strong> read</div>
        <div class="stat" id="users-chip">
          <strong id="total-users">0</strong> users
        </div>
        <div id="users-pop" class="users-pop"></div>
      </div>

      <div class="leaderboard" id="leaderboard">
        <div class="lb-card">
          <h3>Top Recommenders</h3>
          <div id="lb-recommenders" class="lb-list"></div>
        </div>
        <div class="lb-card">
          <h3>Top Readers</h3>
          <div id="lb-readers" class="lb-list"></div>
        </div>
        <div class="lb-card">
          <h3>Most Active</h3>
          <div id="lb-active" class="lb-list"></div>
        </div>
      </div>
    </div>

    <main class="content">
      <!-- Activity + Trending (hidden until login) -->
      <div id="prelogin-row" class="prelogin-row">
        <!-- Activity (compact) -->
        <section class="activity compact" id="activity-block">
          <div class="activity-head">
            <h3>Activity</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="activity-filter" class="select" style="padding:4px 8px;font-size:12px;min-width:auto">
                <option value="">All</option>
                <option value="share">New Books</option>
                <option value="list">List Actions</option>
                <option value="finish">Finished</option>
                <option value="five">5★ Ratings</option>
                <option value="like">Likes</option>
                <option value="comment">Comments</option>
              </select>
              <button id="activity-toggle" class="pill-btn" type="button">More</button>
            </div>
          </div>
          <div id="activity-list" class="activity-body"></div>
        </section>

        <!-- Trending -->
        <section class="activity compact" id="trending-wrap">
          <div class="activity-head">
            <h3>Trending</h3>
          </div>
          <div id="trending-prelogin" class="activity-body"></div>
        </section>
      </div>

      <!-- Toolbar under activity/trending (hidden until login) -->
      <nav class="nav" id="main-nav">
        <button class="nav-btn active" id="feed-btn" type="button">Book Feed</button>
        <button class="nav-btn" id="add-btn" type="button">Add Book</button>
        <button class="nav-btn" id="my-books-btn" type="button">My Lists</button>
        <button class="nav-btn" id="prefs-btn" type="button">Preferences</button>
      </nav>

      <!-- LOGIN -->
      <section id="login-section" class="login">
        <form class="login-card" id="login-form">
          <h2>Welcome to Book Club</h2>
          <p class="small" style="margin:6px 0 12px">Enter your first name to use your lists</p>
          <div style="margin-bottom:10px;background:#f7f8f8;padding:8px;border-radius:8px;color:#1b2a23;font-size:12px;border:1px solid var(--line)">
            This site doesn’t auto-log you in on refresh. Type the same name again to see your lists.
          </div>
          <input class="input" type="text" id="username-input" placeholder="Your first name" required style="text-align:center"/>
          <div style="height:8px"></div>
          <button class="nav-btn" type="submit">Enter</button>
        </form>
      </section>

      <!-- APP -->
      <section id="main-app" style="display:none">
        <!-- FEED -->
        <section id="feed" class="section active">
          <div class="search">
            <input type="text" class="input" placeholder="Search title, author, recommender…" id="search-input"/>
            <!-- tag filter changed to dropdown -->
            <select class="select" id="tag-filter">
              <option value="">All Tags</option>
            </select>
            <select class="select" id="category-filter">
              <option value="">All Categories</option>
            </select>
            <select class="select" id="recommender-filter">
              <option value="">All Recommenders</option>
            </select>
            <select class="select" id="min-rating">
              <option value="0">Min ★ (Any)</option>
              <option value="5">5★</option>
              <option value="4">4★+</option>
              <option value="3">3★+</option>
            </select>
          </div>

          <div class="results-bar">
            <span class="chip" id="result-count"></span>
            <div class="results-right">
              <label class="small"><input type="checkbox" id="collapse-all"> Collapse all comments</label>
              <select class="select" id="sort-by" style="max-width:180px">
                <option value="new">Newest</option>
                <option value="likes">Most Likes</option>
                <option value="rating">Highest Rated</option>
                <option value="title">Title A–Z</option>
              </select>
            </div>
          </div>

          <div id="books-feed" class="feed"></div>
        </section>

        <!-- ADD -->
        <section id="add" class="section">
          <div class="lb-card" style="margin-bottom:10px">
            <h3>Share a Book Recommendation</h3>

            <!-- Google Books Search -->
            <div class="search" style="grid-template-columns:2fr 1fr">
              <div class="dropdown" style="position:relative">
                <input id="book-search" class="input" type="text" placeholder="Search Google Books to auto-fill…"/>
                <div id="book-results" class="users-pop" style="left:0;right:0;max-height:280px;overflow:auto"></div>
              </div>
              <div>
                <label class="small">Rating (click stars below)</label>
                <div class="stars" id="rating-stars" aria-label="rating stars">
                  <button class="star" type="button" data-rating="1">★</button>
                  <button class="star" type="button" data-rating="2">★</button>
                  <button class="star" type="button" data-rating="3">★</button>
                  <button class="star" type="button" data-rating="4">★</button>
                  <button class="star" type="button" data-rating="5">★</button>
                </div>
                <div id="rating-feedback" class="small">Click stars to rate (required)</div>
              </div>
            </div>

            <form id="book-form">
              <div class="search" style="grid-template-columns:1fr 1fr 1fr">
                <div><label class="small">Title *</label><input class="input" type="text" id="title" required/></div>
                <div><label class="small">Author *</label><input class="input" type="text" id="author" required/></div>
                <div>
                  <label class="small">Category</label>
                  <select class="select" id="genre"></select>
                </div>
              </div>

              <div class="search" style="grid-template-columns:1fr 1fr">
                <div><label class="small">Your Name *</label><input class="input" type="text" id="recommender" required/></div>
                <div><label class="small">Cover Image (URL)</label><input class="input" type="url" id="book-image" placeholder="https://…"/></div>
              </div>

              <div><label class="small">Synopsis</label><textarea class="textarea" id="synopsis" placeholder="Book description (auto-filled when available)…"></textarea></div>

              <div>
                <label class="small">Why I recommend this * <span class="small" style="opacity:.8">(Choose a style below and click “Suggest Reason” to auto-generate text, then edit)</span></label>
                <div class="search" style="grid-template-columns:1fr auto">
                  <select id="reason-tone" class="select" aria-label="Style for auto-generate">
                    <option value="personal">Style: Personal</option>
                    <option value="hook">Style: Hook/Catchy</option>
                    <option value="professional">Style: Professional</option>
                    <option value="concise">Style: Concise</option>
                  </select>
                  <button id="reason-suggest" type="button" class="nav-btn" title="Auto-generate reason text">Suggest Reason (auto)</button>
                </div>
                <textarea class="textarea" id="reason" placeholder="Your reason (you can auto-generate above)"></textarea>
              </div>

              <div>
                <label class="small">Tags</label>
                <div class="tags-input-container" id="tags-container" style="border:2px solid var(--line);border-radius:8px;padding:6px;background:#fffefb">
                  <div id="tags-display" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px"></div>
                  <input type="text" class="input" id="tag-input" placeholder="Add tags…" style="border:0;padding:6px;background:transparent"/>
                  <div class="users-pop" id="tag-suggestions" style="display:none"></div>
                </div>
              </div>

              <div style="height:6px"></div>
              <button type="submit" class="nav-btn">Share Book</button>
            </form>
          </div>
        </section>

        <!-- MY LISTS -->
        <section id="my-books" class="section">
          <h3 style="margin-bottom:8px">My Reading Lists</h3>
          <div class="lb-card" style="margin-bottom:8px">
            <h4>Want to Read</h4>
            <div id="wish-list"></div>
          </div>
          <div class="lb-card" style="margin-bottom:8px">
            <h4>Currently Reading</h4>
            <div id="current-reading"></div>
          </div>
          <div class="lb-card">
            <h4>Read</h4>
            <div id="read-list"></div>
          </div>
        </section>

        <!-- PREFS -->
        <section id="prefs" class="section">
          <h2 style="margin-bottom:8px;color:var(--ink);font-size:1.1rem">Preferences</h2>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Posting & Feed</h3>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <label><input id="pref-post-new" type="checkbox" checked/> Post on <strong>new book</strong></label>
              <label><input id="pref-post-finish" type="checkbox" checked/> Post when someone <strong>finishes a book</strong></label>
              <label><input id="pref-post-5" type="checkbox" checked/> Post for <strong>new 5★ ratings</strong></label>
              <button id="prefs-save" class="nav-btn" type="button">Save</button>
            </div>
          </div>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Install on Your Phone</h3>
            <p class="small">Add Book Club to your home screen so it opens like an app.</p>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button id="install-app-btn" class="nav-btn" type="button">Install App</button>
              <span id="install-status" class="chip">Not installed</span>
            </div>
            <details id="ios-steps" style="margin-top:6px">
              <summary>iPhone / iPad steps</summary>
              <ol style="margin:6px 0 0 18px">
                <li>Open this page in <strong>Safari</strong>.</li>
                <li>Tap <strong>Share</strong> → <strong>Add to Home Screen</strong>.</li>
                <li>Tap <strong>Add</strong>.</li>
              </ol>
              <p class="small">On iOS Chrome: Share → “Add to Home Screen”.</p>
            </details>
          </div>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Writing Assistant</h3>
            <p class="small">Use built-in suggestions, or paste an OpenAI API key to upgrade results. The key is stored only on this device.</p>
            <div class="search" style="grid-template-columns:1fr auto auto">
              <input id="openai-key" class="input" placeholder="sk-… (optional)"/>
              <button id="save-openai-key" class="nav-btn" type="button">Save Key</button>
              <button id="clear-openai-key" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear</button>
            </div>
          </div>

          <div class="lb-card" style="margin-bottom:10px">
            <h3>Export / Backup</h3>
            <p class="small">Downloads Excel-friendly CSV files (books.csv and comments.csv) + JSON.</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="export-csv-btn" class="nav-btn" type="button">Download CSVs</button>
              <button id="export-json-btn" class="nav-btn" type="button">Download JSON</button>
              <label class="nav-btn" style="cursor:pointer">
                Import JSON<input type="file" id="import-json" accept="application/json" style="display:none">
              </label>
            </div>
          </div>

          <div class="lb-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Admin Options</h3>
              <button id="toggle-danger" class="pill-btn" type="button">Open Admin Options</button>
            </div>
            <div id="data-management" style="display:none;margin-top:8px">
              <div style="display:grid;gap:8px">
                <button id="clear-data-btn" class="nav-btn" type="button" style="background:#b74a4a;border-color:#5c1f1f">Clear ALL Data</button>

                <div class="search" style="grid-template-columns:1fr 1fr auto">
                  <input id="rename-from" class="input" placeholder="Rename / merge: From name">
                  <input id="rename-to" class="input" placeholder="To name">
                  <button id="rename-user-btn" class="nav-btn" type="button">Rename / Merge</button>
                </div>

                <!-- Minimal Admin edit controls -->
                <div class="search" style="grid-template-columns:1fr auto">
                  <input id="delete-book-id" class="input" placeholder="Delete book by ID">
                  <button id="delete-book-btn" class="nav-btn" type="button">Delete Book</button>
                </div>
                <div class="search" style="grid-template-columns:1fr auto auto">
                  <input id="activity-days" class="input" placeholder="Purge activity older than N days">
                  <button id="purge-activity-btn" class="nav-btn" type="button">Purge Activity</button>
                  <button id="delete-last-activity-btn" class="nav-btn" type="button">Delete Most Recent Activity</button>
                </div>

                <div class="search" style="grid-template-columns:1fr auto">
                  <input id="pref-teams-url" class="input" type="url" placeholder="Teams Incoming Webhook URL"/>
                  <button id="save-teams-btn" class="nav-btn" type="button">Save Teams URL</button>
                </div>
                <!-- Removed visible password text for security -->
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Finish / Rate Modal -->
  <div id="finish-modal" class="toast" style="left:50%;transform:translate(-50%,0);bottom:auto;top:20%;max-width:520px">
    <div>
      <h3 id="finish-heading" style="margin-bottom:6px">Rate this book</h3>
      <p id="finish-title" class="small" style="margin-bottom:6px"></p>
      <div class="stars" id="finish-stars" style="margin:6px 0 4px">
        <button class="star" data-rating="1" type="button">★</button>
        <button class="star" data-rating="2" type="button">★</button>
        <button class="star" data-rating="3" type="button">★</button>
        <button class="star" data-rating="4" type="button">★</button>
        <button class="star" data-rating="5" type="button">★</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="nav-btn" id="finish-save" type="button">Save</button>
        <button class="nav-btn" id="finish-cancel" type="button" style="background:#b74a4a;border-color:#5c1f1f">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ========= JSONBin Storage & State ========= */
const JSONBIN_API = 'https://api.jsonbin.io/v3';
const BIN_ID = '68b1dc30ae596e708fdb3ff1';   // Your actual bin ID
const API_KEY = '$2a$10$LYh6e0ns1sOKv23ek6kbD.7UJoIW.UclGVfzMvSeDzeSLfshEvQZi'; // Your X-MASTER-KEY
const ADMIN_PASSWORD = 'Prob1234'; // updated per your note

let currentUser='';
let books=[]; 
let userData={}; 
let activity=[]; 
let sitePrefs={teamsWebhook:'',postNew:true,postFinish:true,postFive:true,openaiKey:''};

let isLoading=false;
let currentTags = [];
let currentRating=0;
let finishContext=null; 
let activityExpanded=false;
let lastSearchItems=[]; // Google books search cache
let deferredPrompt=null; // PWA

/* ========= Utilities ========= */
const $  = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const now=()=>new Date().toISOString();
const timeAgo=(iso)=>{const d=new Date(iso);const s=(Date.now()-d)/1000;if(s<60)return`${Math.floor(s)}s`;const m=s/60;if(m<60)return`${Math.floor(m)}m`;const h=m/60;if(h<24)return`${Math.floor(h)}h`;return`${Math.floor(h/24)}d`};
const escapeHtml=(s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const escapeAttr=(s='')=>escapeHtml(s).replaceAll('"','&quot;');
const truncate=(s,n=300)=> s && s.length>n ? s.slice(0,n-1)+'…' : s;
const setLoading=(el,loading)=>{if(!el)return;el.classList.toggle('loading',loading);if(loading&&!el.querySelector('.spinner')){const span=document.createElement('span');span.className='spinner';el.prepend(span);}else if(!loading){const sp=el.querySelector('.spinner');sp&&sp.remove();}};
const showToast=(msg,isError=false)=>{const t=$('#toast');t.textContent=msg;t.classList.toggle('error',isError);t.classList.add('show');clearTimeout(showToast._t);showToast._t=setTimeout(()=>t.classList.remove('show'),isError?3200:1800);};
const formatDate=(v)=>{const n=Number(v);const d=new Date(Number.isFinite(n)?n:v);return d.toLocaleDateString();};

/* ========= Local & Remote Persistence ========= */
async function loadAll(){
  if(isLoading) return; 
  isLoading = true;
  // no auto-login: do NOT restore currentUser
  try{
    const cached = JSON.parse(localStorage.getItem('bookclub_payload')||'{}');
    if(cached.books) books = cached.books;
    if(cached.userData) userData = cached.userData;
    if(cached.activity) activity = cached.activity;
    if(cached.sitePrefs) sitePrefs = Object.assign(sitePrefs, cached.sitePrefs);
  }catch{}

  try{
    const r = await fetch(`${JSONBIN_API}/b/${BIN_ID}/latest`,{headers:{'X-Master-Key':API_KEY}});
    if(!r.ok) throw new Error(await r.text());
    const data=await r.json();
    const record=data.record||{};
    books=record.books||books||[];
    userData=record.userData||userData||{};
    activity=record.activity||activity||[];
    sitePrefs=Object.assign(sitePrefs,record.sitePrefs||{});
    localStorage.setItem('bookclub_payload', JSON.stringify({books,userData,activity,sitePrefs}));
  }catch(e){
    console.warn('Using local data; sync failed.', e);
  }
  isLoading=false;
}
async function saveAll(){
  try{ localStorage.setItem('bookclub_payload', JSON.stringify({books,userData,activity,sitePrefs})); }catch{}
  try{
    const payload={books,userData,activity,sitePrefs};
    await fetch(`${JSONBIN_API}/b/${BIN_ID}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json','X-Master-Key':API_KEY},
      body:JSON.stringify(payload)
    });
  }catch(e){
    console.warn('Remote save failed',e);
  }
}

const defaultUser=()=>({readList:[],wishList:[],currentReading:[]});
function ensureUser(name){ if(!userData[name]) userData[name]=defaultUser(); }
const me=()=>userData[currentUser]||defaultUser();

/* ========= PWA setup ========= */
function setupPWA(){
  const manifest={name:"Book Club",short_name:"Book Club",start_url:".",display:"standalone",background_color:"#ffffff",theme_color:"#2f4a3e",icons:[{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAAAAABQFZ1hAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE=",sizes:"192x192",type:"image/png"}]};
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const url=URL.createObjectURL(blob);
  const link=$('#app-manifest'); if(link) link.href=url;

  if('serviceWorker' in navigator){
    const sw=`self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('bc-v1').then(c=>c.addAll(['./'])))});self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))})`;
    const swUrl=URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
  const status=$('#install-status');
  const standalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone===true;
  if(status) status.textContent=standalone?'Installed':'Not installed';
  window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;status&&(status.textContent='Install available');});
}

/* ========= Teams ========= */
async function postToTeams(type,text){
  const url=sitePrefs.teamsWebhook?.trim(); if(!url) return;
  const allow=(type==='share'&&sitePrefs.postNew)||(type==='finish'&&sitePrefs.postFinish)||(type==='five'&&sitePrefs.postFive);
  if(!allow) return;
  try{ await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})}); }catch{}
}

/* ========= Activity ========= */
function mergeOrPostActivity(entry){
  // if last entry from same user & book within 2 minutes, merge
  const last=activity[0];
  if(last && last.payload && entry.payload
      && last.payload.user===entry.payload.user
      && last.payload.title===entry.payload.title
      && (Date.now()-new Date(last.at).getTime())<120000){
    last.type='multi';
    last.payload.actions = Array.from(new Set([...(last.payload.actions||[]), entry.type]));
    if(typeof entry.payload.rating!=='undefined'){ last.payload.rating = entry.payload.rating; }
    last.at=now();
  }else{
    activity.unshift({...entry,id:Date.now()+Math.random(),likes:0,likedBy:[],at:now()});
    if(activity.length>300) activity.length=300;
  }
  renderActivity(); saveAll();
}
function postActivity(type,payload){
  mergeOrPostActivity({type,payload});
}
function activityIcon(type){ return ({share:'📣',finish:'🏁','five':'🏆','list':'🗂️','like':'👍',comment:'💬',multi:'✨'}[type]||'📝'); }

/* ========= Ratings helpers ========= */
function ratingCount(book){
  const base = typeof book.rating === 'number' ? 1 : 0;
  const extra = (book.userRatings?.length)||0;
  return base + extra;
}
function averageRatingForBook(book){
  const vals=[];
  if(typeof book.rating==='number') vals.push(book.rating);
  (book.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number') vals.push(r.rating); });
  if(!vals.length) return 0;
  return vals.reduce((a,b)=>a+b,0)/vals.length;
}

/* ========= Tags ========= */
const tagSuggestions = [
  'sci-fi','fantasy','romance','mystery','thriller','horror','historical-fiction',
  'young-adult','contemporary','classic','literary-fiction','dystopian',
  'leadership','business','productivity','entrepreneurship','marketing',
  'personal-development','psychology','philosophy','history','science',
  'technology','health','fitness','cooking','travel','memoir',
  'comedy','drama','adventure','coming-of-age','family',
  'friendship','war','politics','economics','environment','social-justice',
  'quick-read','page-turner','thought-provoking','emotional','inspiring',
  'educational','practical','reference','beginner-friendly','advanced',
  'true-crime','faith','christian','catholic','prayer','neuroscience','time-travel','space','post-apocalyptic'
];
function renderTagsDisplay(){
  const c=$('#tags-display');
  c.innerHTML=currentTags.map(t=>`<span class="tag" data-tag="${escapeAttr(t)}">${escapeHtml(t)} ×</span>`).join('');
}
function addTag(t){const x=t.trim().toLowerCase();if(!x||currentTags.includes(x))return;currentTags.push(x);renderTagsDisplay();$('#tag-input').value='';$('#tag-suggestions').style.display='none';}
function autoTagsFrom(book){
  const list=new Set(book.categories||[]);
  const s=(book.synopsis||'').toLowerCase();
  const map = [
    [/science[\s-]?fiction|spaceship|space\s|alien|astrophysics/, 'sci-fi'],
    [/fantasy|dragon|magic|sorcer|wizard|fae/, 'fantasy'],
    [/mystery|detective|whodunnit|whodunit|sleuth/, 'mystery'],
    [/thriller|conspiracy|chase|assassin/, 'thriller'],
    [/romance|love\sstory|enemies to lovers/, 'romance'],
    [/horror|haunted|possession|demon|ghost/, 'horror'],
    [/young adult|ya\b/, 'young-adult'],
    [/dystopian|post[-\s]?apocalyptic|apocalypse/, 'dystopian'],
    [/time[-\s]?travel/, 'time-travel'],
    [/space|cosmos/, 'space'],
    [/history|historical/, 'history'],
    [/memoir|autobiograph/, 'memoir'],
    [/true\s?crime/, 'true-crime'],
    [/leadership|manager|team/, 'leadership'],
    [/business|startup|founder|marketing|sales/, 'business'],
    [/productivity|habits|workflow|time management/, 'productivity'],
    [/psychology|behavior|cognitive|neuroscience/, 'psychology'],
    [/neuroscience/, 'neuroscience'],
    [/philosophy|ethic|stoic/, 'philosophy'],
    [/faith|prayer|catholic|christian|saint/, 'faith'],
  ];
  map.forEach(([re, tag])=>{ if(re.test(s)) list.add(tag); });
  book.genre && list.add(book.genre);
  currentTags=[...new Set([...currentTags,...Array.from(list).map(x=>String(x).toLowerCase())])].slice(0,8);
  renderTagsDisplay();
}

/* ========= Rendering ========= */
function bookCoverBlock(book){
  const link = goodreadsUrl(book);
  if(book.image){
    return `<a href="${link}" target="_blank" rel="noopener">
      <img class="cover" loading="lazy" alt="Cover of ${escapeHtml(book.title)}" src="${escapeAttr(book.image)}"/>
    </a>`;
  } else {
    return `<a href="${link}" target="_blank" rel="noopener" class="cover-ph">No Cover</a>`;
  }
}
function youStatus(book){
  if(!currentUser) return '';
  const mine=me();
  const r=mine.readList.find(x=>x.id===book.id);
  const cr=mine.currentReading.find(x=>x.id===book.id);
  const w=mine.wishList.find(x=>x.id===book.id);
  if(r){
    const ur=(book.userRatings||[]).find(x=>x.user===currentUser);
    const stars=ur?.rating ?? r._rating ?? 0;
    return `<div class="status-note"><strong>You</strong> marked this read ${stars?`— ${stars}★`:''}</div>`;
  }
  if(cr) return `<div class="status-note"><strong>You</strong> are reading this</div>`;
  if(w)  return `<div class="status-note"><strong>You</strong> want to read this</div>`;
  return '';
}
function likedByLine(arr=[]){
  if(!arr.length) return '';
  return `<div class="small"><em>Liked by:</em> ${escapeHtml(arr.join(', '))}</div>`;
}
function tagChips(tags){ if(!tags||!tags.length) return ''; return `<div class="tags">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`; }

  function goodreadsUrl(book){
  const q = `${book.title||''} ${book.author||''}`.trim();
  return `https://www.goodreads.com/search?q=${encodeURIComponent(q)}&search_type=books`;
}

function synBlock(book){
  if(!book.synopsis) return '';
  const long = book.synopsis.length>280;
  const short = truncate(book.synopsis, 280);
  const id = `syn-${book.id}`;
  return `
  <div class="syn" data-syn="${book.id}">
    <span class="syn-text" data-expanded="false">${escapeHtml(short)}</span>
    ${long?` <button class="c-toggle" type="button" data-action="toggle-synopsis" data-id="${book.id}" data-full="${escapeAttr(book.synopsis)}">Read more</button>`:''}
  </div>`;
}

function bookCard(book){
  const liked=currentUser && (book.postLikedBy||[]).includes(currentUser);
  const avg=averageRatingForBook(book);
  const rounded=Math.round(avg||0);
  const count=ratingCount(book);
  const sysCollapsed = $('#collapse-all')?.checked ? 'style="display:none"' : '';

  return `
  <article class="post" id="book-${book.id}" data-id="${book.id}">
    <div class="head">
      ${bookCoverBlock(book)}
      <div class="info">
        <div class="genre">${escapeHtml(book.genre)}</div>
        <div class="title">${escapeHtml(book.title)}</div>
        <div class="author">by ${escapeHtml(book.author)}</div>
        <div class="recommender">Recommended by ${escapeHtml(book.recommender)}</div>
        <div class="small" style="color:#20362c">Recommended on ${formatDate(book.id)}</div>
        <div class="rating-line">
          <div class="stars">${'★'.repeat(rounded)}${'☆'.repeat(5-rounded)}</div>
          <span class="small">(${avg.toFixed(1)}/5 • ${count} rating${count===1?'':'s'})</span>
        </div>
        ${tagChips(book.tags)}
        ${youStatus(book)}
      </div>
    </div>

    ${synBlock(book)}
    ${book.reason?`<div class="why"><div class="reason-title">Why ${escapeHtml(book.recommender)} recommends it</div>${escapeHtml(book.reason)}</div>`:''}

    <div class="actions">
      <button class="action ${liked?'active':''}" type="button" data-action="like" data-id="${book.id}">👍 <span data-like-count>${book.postLikes||0}</span></button>
      <button class="action" type="button" data-action="wish" data-id="${book.id}">📚 Want to Read</button>
      <button class="action" type="button" data-action="reading" data-id="${book.id}">📖 Currently Reading</button>
      <button class="action" type="button" data-action="finish" data-id="${book.id}">✅ Mark as Read</button>
    </div>
    ${likedByLine(book.postLikedBy)}

    <div class="comments">
      <div class="c-head">
        <span class="c-title">Comments <span class="small">(${(book.comments||[]).length})</span></span>
        <button class="c-toggle" type="button" data-action="toggle-comments" data-id="${book.id}">See Comments</button>
      </div>
      <div class="c-list" ${sysCollapsed} data-list="${book.id}">
        ${(book.comments||[]).map(c=>`
          <div class="c-item" data-comment-id="${c.id}">
            <div class="c-headline">
              <span class="c-name">${escapeHtml(c.commenter||'Anonymous')} <span class="small" style="color:#20362c;margin-left:6px">${formatDate(c.id)}</span></span>
              <button class="c-like ${(c.likedBy||[]).includes(currentUser)?'liked':''}" type="button" data-action="like-comment" data-id="${book.id}" data-cid="${c.id}">👍 ${c.likes||0}</button>
            </div>
            <div class="c-text">${escapeHtml(c.text||'')}</div>
          </div>`).join('')}
        <div class="c-form" data-id="${book.id}">
          <input type="text" class="c-input" data-field="name" value="${escapeAttr(currentUser)}" placeholder="Your name"/>
          <input type="text" class="c-textarea" data-field="text" placeholder="Write your comment…"/>
          <button class="c-btn" type="button" data-action="add-comment" data-id="${book.id}">Add Comment</button>
        </div>
      </div>
    </div>
  </article>`;
}

function renderActivity(){
  const list=$('#activity-list');
  const filter=$('#activity-filter').value;
  const cap=activityExpanded?40:12;
  const filtered=filter?activity.filter(a=>a.type===filter):activity;
  if(!filtered.length){list.innerHTML=`<div class="a-item"><div class="a-badge">👋</div><div>Welcome! Share a book to kick things off.</div></div>`;return;}
  list.innerHTML=filtered.slice(0,cap).map(a=>{
    const {type,payload,at,likes=0}=a;
    const user = escapeHtml(payload.user);
    const title = `<em>${escapeHtml(payload.title)}</em>`;
    let text='';
    if(type==='share') text=`<strong>${user}</strong> shared ${title} (${payload.rating}★)`;
    else if(type==='finish') text=`<strong>${user}</strong> finished ${title} — ${payload.rating}★`;
    else if(type==='five') text=`<strong>${user}</strong> rated ${title} <strong>5★</strong>`;
    else if(type==='list') text=`<strong>${user}</strong> ${escapeHtml(payload.action)} ${title}`;
    else if(type==='comment') text=`<strong>${user}</strong> commented on ${title}`;
    else if(type==='like') text=`<strong>${user}</strong> liked ${title}`;
    else if(type==='multi'){
      const acts = new Set(payload.actions||[]);
      const rated = (typeof payload.rating!=='undefined');
      if(acts.has('share') && (acts.has('finish') || acts.has('five') || rated)){
        text = `<strong>${user}</strong> recommended ${title} and rated it ${payload.rating||5}★`;
      }else if(acts.has('share')){
        text = `<strong>${user}</strong> recommended ${title}`;
      }else{
        text = `<strong>${user}</strong> updated ${title}`;
      }
    }
    return `<div class="a-item">
      <div class="a-badge">${activityIcon(type)}</div>
      <div>
        <div>${text}</div>
        <div class="a-meta">${timeAgo(at)} ago <span class="pill">${likes} 👍</span></div>
      </div>
    </div>`;
  }).join('');
  $('#activity-toggle').textContent=activityExpanded?'Less':'More';
}
function renderBooks(){
  const c=$('#books-feed');
  if(!currentBooks.length){c.innerHTML=`<div style="text-align:center;padding:28px;color:var(--muted)"><h3 style="font-size:1rem;color:#2a3a33">No books found</h3><p class="small">Adjust search/filters or add a new recommendation.</p></div>`;$('#result-count').textContent='0 results';return;}
  c.innerHTML=currentBooks.map(bookCard).join('');
  $('#result-count').textContent=`${currentBooks.length} result${currentBooks.length===1?'':'s'}`;
}
function renderMyLists(){
  const data=me();
  const make=(arr,actions)=> arr.length?arr.map(b=>`
    <div class="lb-row" data-id="${b.id}">
      <div><strong>${escapeHtml(b.title)}</strong> by ${escapeHtml(b.author)}</div>
      <div>${actions(b)}</div>
    </div>`).join(''):`<p class="small" style="font-style:italic">Nothing here yet</p>`;
  $('#current-reading').innerHTML=make(data.currentReading,(b)=>`
    <button class="pill-btn" type="button" data-action="finish" data-id="${b.id}">Mark Read</button>
    <button class="pill-btn" type="button" data-action="remove-current" data-id="${b.id}">Remove</button>`);
  $('#wish-list').innerHTML=make(data.wishList,(b)=>`
    <button class="pill-btn" type="button" data-action="reading" data-id="${b.id}">Start</button>
    <button class="pill-btn" type="button" data-action="remove-wish" data-id="${b.id}">Remove</button>`);
  $('#read-list').innerHTML=make(data.readList,(b)=>`
    <span class="chip">${(b._rating||0)}★</span>
    <button class="pill-btn" type="button" data-action="remove-read" data-id="${b.id}">Remove</button>`);
}

/* ========= Stats / Leaderboard / Trending ========= */
function updateStats(){
  let sum=0,n=0;
  books.forEach(b=>{
    if(typeof b.rating==='number'){sum+=b.rating;n++;}
    (b.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number'){sum+=r.rating;n++;} });
  });
  const totalBooks=books.length;
  const totalComments=books.reduce((s,b)=>s+(b.comments?.length||0),0);
  const globalAvg=n?(sum/n):0;
  const readCount=Object.values(userData||{}).reduce((s,u)=>s+(u.readList?.length||0),0);
  const usersCount=Object.keys(userData||{}).length;
  $('#total-books').textContent=String(totalBooks);
  $('#total-reviews').textContent=String(totalComments);
  $('#avg-rating').textContent=globalAvg.toFixed(1);
  $('#books-read').textContent=String(readCount);
  $('#total-users').textContent=String(usersCount);

  const list=Object.keys(userData||{}).sort((a,b)=>a.localeCompare(b));
  $('#users-pop').innerHTML=list.map(n=>`<div>${escapeHtml(n)}</div>`).join('');

  renderLB();
  renderTrending();
  populateTagFilter();
}
function renderLB(){
  const notSystem = (name)=> String(name||'').trim().toLowerCase()!=='system';

  const addRows=(container,arr,unit,empty)=>{
    if(!arr.length){container.innerHTML=`<div class="small" style="color:#2b3832">${empty}</div>`;return;}
    container.innerHTML=arr.map(([name,count])=>`
      <div class="lb-row">
        <div>${escapeHtml(name)}</div>
        <span class="lb-count">${count} ${unit}</span>
      </div>`).join('');
  };
  // Top Recommenders
  const recs={}; books.forEach(b=>{const n=b.recommender; if(n) recs[n]=(recs[n]||0)+1;});
  const recsSorted=Object.entries(recs)
    .filter(([name])=>notSystem(name))
    .sort((a,b)=>b[1]-a[1]).slice(0,3);
  addRows($('#lb-recommenders'),recsSorted,'book'+(recsSorted[0]?.[1]===1?'':'s'),'No shares yet');

  // Top Readers
  const reads={}; Object.entries(userData||{}).forEach(([n,d])=>{if(notSystem(n)) reads[n]=(d.readList||[]).length;});
  const readsSorted=Object.entries(reads).filter(([,n])=>n>0).sort((a,b)=>b[1]-a[1]).slice(0,3);
  addRows($('#lb-readers'),readsSorted,'read','No finished books yet');

  // Most Active (approx.)
  const active={};
  Object.entries(userData||{}).forEach(([n,d])=>{ if(notSystem(n)) active[n]=(d.readList?.length||0)+(d.currentReading?.length||0)+(d.wishList?.length||0);});
  books.forEach(b=>(b.comments||[]).forEach(c=>{const n=c.commenter||'Anonymous'; if(notSystem(n)) active[n]=(active[n]||0)+1;}));
  books.forEach(b=>{(b.postLikedBy||[]).forEach(n=>{ if(notSystem(n)) active[n]=(active[n]||0)+1; });});
  const actSorted=Object.entries(active).sort((a,b)=>b[1]-a[1]).slice(0,3);
  addRows($('#lb-active'),actSorted,'actions','No activity yet');
}
function trendingScore(b){
  const comments=b.comments?.length||0;
  const likes=b.postLikes||0;
  const ratings=ratingCount(b);
  return comments*2+likes*1.5+ratings;
}
function renderTrending(){
  const top=[...books].sort((a,b)=>trendingScore(b)-trendingScore(a)).slice(0,3);
  const makeRows=(arr)=> arr.length?arr.map(b=>`
    <div class="lb-row" data-jump="${b.id}">
      <div style="display:flex;align-items:center;gap:8px">
        ${b.image
  ? `<a href="${goodreadsUrl(b)}" target="_blank" rel="noopener">
       <img src="${escapeAttr(b.image)}" alt="" style="width:28px;height:42px;border-radius:6px;border:1px solid #e6ece8;object-fit:cover">
     </a>`
  : `<a href="${goodreadsUrl(b)}" target="_blank" rel="noopener">
       <div style="width:28px;height:42px;border-radius:6px;background:#e9ecef"></div>
     </a>`}
          <div><strong>${escapeHtml(b.title)}</strong></div>
          <div class="small" style="color:#20362c">${escapeHtml(b.author)}</div>
        </div>
      </div>
      <span class="lb-count">${Math.round(trendingScore(b))} actions</span>
    </div>`).join(''):`<div class="small" style="color:#2b3832">No activity yet</div>`;

  const c1=$('#trending-prelogin');
  if(c1) c1.innerHTML=makeRows(top);
  const c2=$('#trending'); 
  if(c2) c2.innerHTML=makeRows(top);
}

/* ========= Search/Filter ========= */
function getUniqueRecommenders(){ return Array.from(new Set(books.map(b=>b.recommender).filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }
function populateRecommenderFilter(){
  const sel=$('#recommender-filter'); const cur=sel.value;
  sel.innerHTML=['<option value="">All Recommenders</option>'].concat(getUniqueRecommenders().map(n=>`<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`)).join('');
  if(cur && getUniqueRecommenders().includes(cur)) sel.value=cur;
}
function populateCategoryOptions(){
  const opts=[
    'Fiction','Non-Fiction','Biography','Memoir','Self-Help','Professional','Business',
    'Leadership','Entrepreneurship','Marketing','Finance','Personal Development',
    'History','Science','Technology','Psychology','Philosophy','Spirituality/Religion',
    'Health & Fitness','Cooking','Travel','Parenting','Education',
    'Mystery','Thriller','Horror','Romance','Fantasy','Sci-Fi','Dystopian','Young Adult',
    'Classics','Literary Fiction','Poetry','Comics/Graphic Novel','Reference','Other'
  ];
  $('#genre').innerHTML=opts.map(o=>`<option value="${escapeAttr(o.toLowerCase())}">${escapeHtml(o)}</option>`).join('');
  const feedCat=$('#category-filter');
  feedCat.innerHTML=['<option value="">All Categories</option>'].concat(opts.map(o=>`<option value="${escapeAttr(o.toLowerCase())}">${escapeHtml(o)}</option>`)).join('');
}
function getAllTagsUnique(){
  const set=new Set();
  books.forEach(b=> (b.tags||[]).forEach(t=> set.add(String(t).toLowerCase())));
  return Array.from(set).sort();
}
function populateTagFilter(){
  const sel=$('#tag-filter'); if(!sel) return;
  const cur=sel.value;
  const all=getAllTagsUnique();
  sel.innerHTML=['<option value="">All Tags</option>'].concat(all.map(t=>`<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`)).join('');
  if(all.includes(cur)) sel.value=cur;
}

function bookSearchScore(b,t){
  if(!t) return 1;
  const term=t.toLowerCase();
  const inStr=(s)=> (s||'').toLowerCase();
  let score=0;
  const title=inStr(b.title), author=inStr(b.author), rec=inStr(b.recommender), syn=inStr(b.synopsis), rea=inStr(b.reason);
  const tags=(b.tags||[]).map(x=>String(x).toLowerCase());
  if(title===term) score+=100;
  if(title.startsWith(term)) score+=60;
  if(title.includes(term)) score+=30;
  if(author.startsWith(term)) score+=30;
  if(author.includes(term)) score+=20;
  if(rec.includes(term)) score+=15;
  if(rea.includes(term)) score+=12;
  if(syn.includes(term)) score+=10;
  if(tags.some(x=>x.includes(term))) score+=25;
  return score;
}
function applyFilters(){
  const term=$('#search-input').value.trim();
  const tagTerm=$('#tag-filter').value.trim().toLowerCase(); 
  const cat=$('#category-filter').value;
  const who=$('#recommender-filter').value;
  const min=parseInt($('#min-rating').value,10)||0;
  const sort=$('#sort-by').value;

  const list=books
    .map(b=>({...b,_score:bookSearchScore(b,term)}))
    .filter(b=>{
      if(term && b._score<=0) return false;
      if(cat && b.genre!==cat) return false;
      if(who && b.recommender!==who) return false;
      if(min && averageRatingForBook(b) < min) return false;
      if(tagTerm && !(b.tags||[]).map(t=>String(t).toLowerCase()).includes(tagTerm)) return false;
      return true;
    });

  if(term){ list.sort((a,b)=>b._score-a._score || b.id-a.id); }
  else if(sort==='new'){ list.sort((a,b)=>b.id-a.id); }
  else if(sort==='likes'){ list.sort((a,b)=>(b.postLikes||0)-(a.postLikes||0)); }
  else if(sort==='rating'){ list.sort((a,b)=>averageRatingForBook(b)-averageRatingForBook(a)); }
  else if(sort==='title'){ list.sort((a,b)=>a.title.localeCompare(b.title)); }

  currentBooks=list; renderBooks();
}

/* ========= Google Books Search ========= */
const searchGoogleBooks = async (q)=>{
  const box=$('#book-results');
  const input=$('#book-search');
  if(!q||q.trim().length<2){ box.style.display='none'; box.innerHTML=''; lastSearchItems=[]; return; }
  try{
    setLoading(input,true);
    const url=`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q.trim())}&maxResults=10`;
    const r=await fetch(url); if(!r.ok) throw new Error(`Search failed ${r.status}`);
    const data=await r.json(); setLoading(input,false);
    lastSearchItems=(data.items||[]).map((it,i)=>{
      const v=it.volumeInfo||{};
      return {
        index:i,
        title:v.title||'Unknown Title',
        authors:(v.authors||[]).join(', ')||'Unknown Author',
        cover:v.imageLinks?.thumbnail||'',
        description:v.description||'',
        categories:v.categories||[],
      };
    });
    if(!lastSearchItems.length){ box.innerHTML='<div class="small" style="padding:8px">No results</div>'; box.style.display='block'; return; }
    box.innerHTML=lastSearchItems.map(r=>`
      <div class="lb-row" data-pick="${r.index}">
        <div style="display:flex;gap:8px;align-items:center">
          ${r.cover?`<img src="${escapeAttr(r.cover)}" class="result-cover" style="width:24px;height:36px;border-radius:4px;border:1px solid #e6ece8;object-fit:cover">`:`<div style="width:24px;height:36px;border-radius:4px;background:#e9ecef"></div>`}
          <div><strong>${escapeHtml(r.title)}</strong><div class="small">${escapeHtml(r.authors)}</div></div>
        </div>
        ${r.categories?.length?`<span class="lb-count">${escapeHtml(r.categories[0])}</span>`:''}
      </div>`).join('');
    box.style.display='block';
  }catch(e){
    setLoading(input,false); console.warn(e);
    box.innerHTML='<div class="small" style="padding:8px;color:#b74a4a">Search failed. Try again.</div>';
    box.style.display='block';
  }
};

/* ========= CSV Export / JSON ========= */
function download(name, text, mime='text/csv;charset=utf-8;'){
  const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}
function toCsvRow(arr){ return arr.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(','); }
function exportCsvs(){
  const booksHeader = toCsvRow(['id','title','author','genre','recommender','image','avg_rating','ratings_count','tags','synopsis','reason']);
  const booksRows = books.map(b=>toCsvRow([b.id,b.title,b.author,b.genre,b.recommender,b.image||'',averageRatingForBook(b).toFixed(2),ratingCount(b),(b.tags||[]).join('|'),(b.synopsis||''),(b.reason||'')]));
  download('books.csv',[booksHeader,...booksRows].join('\n'));

  const commentsHeader = toCsvRow(['book_id','book_title','comment_id','commenter','likes','text','system']);
  const commentsRows = books.flatMap(b=>(b.comments||[]).map(c=>toCsvRow([b.id,b.title,c.id,c.commenter||'',c.likes||0,c.text||'',c.system?1:0])));
  download('comments.csv',[commentsHeader,...commentsRows].join('\n'));
}
function exportJson(){
  download('bookclub-export.json',JSON.stringify({books,userData,activity,sitePrefs},null,2),'application/json');
}
function importJson(file){
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const data=JSON.parse(fr.result);
      if(data.books) books=data.books;
      if(data.userData) userData=data.userData;
      if(data.activity) activity=data.activity;
      if(data.sitePrefs) sitePrefs=Object.assign(sitePrefs,data.sitePrefs);
      saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); renderActivity(); renderMyLists(); updateStats();
      showToast('Import complete');
    }catch(e){ showToast('Invalid JSON',true); }
  };
  fr.readAsText(file);
}

/* ========= Modal ========= */
function openFinishModal(book){
  finishContext = {bookId: book.id};
  const ur = (book.userRatings||[]).find(r=>r.user===currentUser)?.rating;
  const mineEntry = me().readList.find(x=>x.id===book.id);
  currentRating = ur ?? mineEntry?._rating ?? 0;
  $('#finish-title').textContent = `${book.title} — ${book.author}`;
  $$('#finish-stars .star').forEach(star=>{
    const val=Number(star.getAttribute('data-rating'));
    star.classList.toggle('filled', val<=currentRating);
  });
  const m=$('#finish-modal'); m.classList.add('show');
}
function closeFinishModal(){ $('#finish-modal').classList.remove('show'); finishContext=null; }

/* ========= Writing assistant ========= */
function localReason({title,author,genre,synopsis,tone,tags}){
  const bits=[]; const clean = s=> (s||'').replace(/\s+/g,' ').trim();
  const s = clean(synopsis);
  const hook = s ? s.split(/(?<=[.!?])\s+/).slice(0,1).join(' ') : '';
  if(tone==='hook'){ bits.push(`Quick rec: ${title} is a ${genre} that grabs you fast and doesn’t let go.`); }
  else if(tone==='professional'){ bits.push(`${title} distills ${genre} ideas into clear, practical takeaways.`); }
  else if(tone==='concise'){ bits.push(`${title} is a sharp ${genre} that’s worth your time.`); }
  else { bits.push(`I loved how ${title} by ${author} blends ${genre} themes into something memorable.`); }
  if(hook) bits.push(hook);
  if(tags) bits.push(`Great for fans of ${tags}.`);
  return clean(bits.join(' '));
}
async function suggestReason(tone){
  const title=$('#title').value.trim(), author=$('#author').value.trim();
  const genre=$('#genre').value, synopsis=$('#synopsis').value.trim();
  const tags=(currentTags||[]).slice(0,6).join(', ');
  const fallback = localReason({title,author,genre,synopsis,tone,tags});
  const key=(sitePrefs.openaiKey||'').trim(); if(!key) return fallback;
  try{
    const prompt=`Write a ${tone} 2-3 sentence recommendation for "${title}" by ${author}. Category ${genre}. Tags: ${tags||'—'}. Use ~80 words. No spoilers. Avoid slang.`;
    const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:prompt}],temperature:0.7,max_tokens:180})});
    if(!r.ok) throw new Error(await r.text());
    const j=await r.json(); return j?.choices?.[0]?.message?.content?.trim()||fallback;
  }catch(e){ console.warn(e); return fallback; }
}

/* ========= Bootstrapping ========= */
let currentBooks=[];

document.addEventListener('DOMContentLoaded', async () => {
  await loadAll();
  setupPWA();

  // Initial UI states
  $('#login-section').style.display='block';
  $('#main-app').style.display='none';
  $('#user-bar').style.display='none';
  $('#prelogin-row').style.display='none';      // Activity + Trending hidden until login
  $('#main-nav').style.display='none';          // NAV hidden until login

  // Render base
  populateCategoryOptions();
  populateRecommenderFilter();
  populateTagFilter();
  applyFilters();
  renderActivity();
  renderMyLists();
  updateStats();

  /* Top stats behaviors */
  $('#stat-books').addEventListener('click', ()=>{ openSection('feed'); window.scrollTo({top:0,behavior:'smooth'}); });
  $('#users-chip').addEventListener('mouseenter', ()=>{ const p=$('#users-pop'); p.style.display='block'; const r=$('#users-chip').getBoundingClientRect(); p.style.position='fixed'; p.style.left=(r.left)+'px'; p.style.top=(r.bottom+6)+'px'; });
  $('#users-pop').addEventListener('mouseleave', ()=>$('#users-pop').style.display='none');

  /* Nav */
  $('#feed-btn').addEventListener('click', ()=>{ openSection('feed'); applyFilters(); });
  $('#add-btn').addEventListener('click', ()=> openSection('add'));
  $('#my-books-btn').addEventListener('click', ()=>{ openSection('my-books'); renderMyLists(); });
  $('#prefs-btn').addEventListener('click', ()=> openSection('prefs'));

  /* Login */
  $('#login-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name=($('#username-input').value||'').trim();
    if(!name) return;
    currentUser=name; ensureUser(currentUser);
    $('#current-user-name').textContent=currentUser;
    $('#user-bar').style.display='flex';
    $('#login-section').style.display='none';
    $('#main-app').style.display='block';
    $('#main-nav').style.display='flex';      // show NAV on login
    $('#recommender').value=currentUser;
    $('#prelogin-row').style.display='grid';  // show Activity + Trending on login
    renderMyLists(); updateStats(); applyFilters(); renderActivity();
  });
  $('#logout-btn').addEventListener('click', ()=>{
    currentUser=''; $('#user-bar').style.display='none';
    $('#main-app').style.display='none'; $('#login-section').style.display='block';
    $('#prelogin-row').style.display='none';
    $('#main-nav').style.display='none';     // hide NAV on logout
  });

  /* Filters / search */
  $('#activity-toggle').addEventListener('click', ()=>{ activityExpanded=!activityExpanded; renderActivity(); });
  $('#activity-filter').addEventListener('change', renderActivity);
  $('#search-input').addEventListener('input', applyFilters);
  $('#tag-filter').addEventListener('change', applyFilters);
  $('#category-filter').addEventListener('change', applyFilters);
  $('#recommender-filter').addEventListener('change', applyFilters);
  $('#min-rating').addEventListener('change', applyFilters);
  $('#sort-by').addEventListener('change', applyFilters);
  $('#collapse-all').addEventListener('change', renderBooks);

  /* Add: Google Books search */
  let debounceT=null;
  $('#book-search').addEventListener('input',(e)=>{ clearTimeout(debounceT); debounceT=setTimeout(()=>searchGoogleBooks(e.target.value),300); });
  document.addEventListener('click',(e)=>{
    const pick=e.target.closest('[data-pick]'); if(pick){ 
      const i=Number(pick.getAttribute('data-pick')); const it=lastSearchItems[i]; if(!it) return;
      $('#title').value=it.title; $('#author').value=it.authors; $('#book-image').value=it.cover||''; $('#synopsis').value=it.description||'';
      currentTags=[]; if(it.categories?.length) currentTags.push(...it.categories.slice(0,3).map(x=>x.toLowerCase())); renderTagsDisplay();
      autoTagsFrom({categories:it.categories,genre:$('#genre').value,synopsis:it.description});
      $('#book-results').style.display='none';
    }
  });

  /* Tags input */
  $('#tags-display').addEventListener('click', (e)=>{ const x=e.target.closest('.tag'); if(!x) return; const t=x.getAttribute('data-tag'); currentTags=currentTags.filter(y=>y!==t); renderTagsDisplay(); });
  $('#tag-input').addEventListener('input',(e)=>{ const q=e.target.value.toLowerCase().trim(); const s=$('#tag-suggestions'); if(!q){s.style.display='none';return;} const items=tagSuggestions.filter(t=>t.includes(q) && !currentTags.includes(t)).slice(0,8); s.innerHTML=items.map(t=>`<div class="lb-row" data-tagpick="${t}"><div>${t}</div></div>`).join(''); s.style.display=items.length?'block':'none'; });
  document.addEventListener('click',(e)=>{ const t=e.target.closest('[data-tagpick]'); if(t){ addTag(t.getAttribute('data-tagpick')); $('#tag-suggestions').style.display='none'; } });
  $('#synopsis').addEventListener('blur', ()=>{ autoTagsFrom({categories:[],genre:$('#genre').value,synopsis:$('#synopsis').value}); });

  /* Add: Rating stars (share form) */
  $$('#rating-stars .star').forEach(star=>{
    star.addEventListener('click', ()=>{ const val=Number(star.getAttribute('data-rating')); currentRating=val; $$('#rating-stars .star').forEach(s=> s.classList.toggle('filled', Number(s.getAttribute('data-rating'))<=val)); $('#rating-feedback').textContent=`You selected ${val} star${val===1?'':'s'}.`; });
  });

  /* Finish modal stars */
  $$('#finish-stars .star').forEach(star=>{
    star.addEventListener('click', ()=>{ const val=Number(star.getAttribute('data-rating')); currentRating=val; $$('#finish-stars .star').forEach(s=> s.classList.toggle('filled', Number(s.getAttribute('data-rating'))<=val)); });
  });
$('#finish-save').addEventListener('click', ()=>{
  try{
    if(!finishContext){ closeFinishModal(); return; }
    const book=books.find(b=>b.id===finishContext.bookId); if(!book){ closeFinishModal(); return; }

    const rating = Number.isFinite(currentRating) ? currentRating : 0; // allow 0 stars
    ensureUser(currentUser); const mine=me();

    if(!mine.readList.some(x=>x.id===book.id)){
      mine.readList.push({id:book.id,title:book.title,author:book.author,_rating:rating});
      mine.currentReading = mine.currentReading.filter(x=>x.id!==book.id);
      mine.wishList = mine.wishList.filter(x=>x.id!==book.id);
    }else{
      const rec=mine.readList.find(x=>x.id===book.id);
      rec._rating = rating;
    }

    book.userRatings = book.userRatings || [];
    const ex = book.userRatings.find(r=>r.user===currentUser);
    if(ex) ex.rating = rating; else book.userRatings.push({user:currentUser,rating});

    mergeOrPostActivity({
      type:'finish',
      payload:{user:currentUser,title:book.title,author:book.author, ...(rating>0?{rating}: {})}
    });
    addActionComment(book, `${currentUser} finished this book${rating>0?` — ${rating}★`:''}`, currentUser);

    if(rating===5){
      mergeOrPostActivity({type:'five',payload:{user:currentUser,title:book.title,author:book.author,rating:5}});
      postToTeams('five', `${currentUser} rated "${book.title}" 5★`);
    }
    postToTeams('finish', `${currentUser} finished "${book.title}"${rating>0?` — ${rating}★`:''}`);

    saveAll(); closeFinishModal(); renderMyLists(); applyFilters(); updateStats();
    showToast('Marked as read!');
  }catch(e){
    console.warn(e); closeFinishModal(); showToast('Saved locally. If something looks off, refresh.',true);
  }
});
  $('#finish-cancel').addEventListener('click', closeFinishModal);

  /* Add: Form submit */
  $('#book-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!currentUser){ showToast('Please log in first.', true); return; }
    const title=$('#title').value.trim(), author=$('#author').value.trim();
    const genre=$('#genre').value, recommender=($('#recommender').value||currentUser).trim();
    const image=$('#book-image').value.trim(), synopsis=$('#synopsis').value.trim(), reason=$('#reason').value.trim();
    if(!title||!author||!reason||!currentRating){ showToast('Title, author, rating, and reason are required.',true); return; }

    const book={id:Date.now(), title, author, genre, recommender, image, synopsis, reason, rating:currentRating, userRatings:[], tags:[...currentTags], comments:[], postLikes:0, postLikedBy:[]};
    books.unshift(book);

    ensureUser(recommender); const recMe=userData[recommender]; if(!recMe.readList.some(x=>x.id===book.id)) recMe.readList.push({id:book.id,title:book.title,author:book.author,_rating:currentRating});
    addActionComment(book, `${recommender} shared this book — ${currentRating}★`, recommender);
    mergeOrPostActivity({type:'share',payload:{user:recommender,title,author,rating:currentRating}});
    if(currentRating===5){ mergeOrPostActivity({type:'five',payload:{user:recommender,title,author,rating:5}}); }

    $('#book-form').reset(); currentTags=[]; renderTagsDisplay();
    currentRating=0; $$('#rating-stars .star').forEach(s=>s.classList.remove('filled')); $('#rating-feedback').textContent='Click stars to rate (required)'; $('#book-results').style.display='none';

    saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); updateStats(); showToast('Book shared!');
  });

  /* Prefs */
  $('#prefs-save').addEventListener('click', ()=>{ sitePrefs.postNew=$('#pref-post-new').checked; sitePrefs.postFinish=$('#pref-post-finish').checked; sitePrefs.postFive=$('#pref-post-5').checked; saveAll(); showToast('Preferences saved.'); });
  $('#save-teams-btn').addEventListener('click', ()=>{ sitePrefs.teamsWebhook=$('#pref-teams-url').value.trim(); saveAll(); showToast('Teams URL saved'); });
  $('#export-csv-btn').addEventListener('click', exportCsvs);
  $('#export-json-btn').addEventListener('click', exportJson);
  $('#import-json').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) importJson(f); e.target.value=''; });

  // Admin Options: password gate
  $('#toggle-danger').addEventListener('click', ()=>{
    const dm=$('#data-management');
    if(dm.style.display==='none' || !dm.style.display){
      const pw=prompt('Enter admin password:');
      if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
      dm.style.display='block';
    }else{
      dm.style.display='none';
    }
  });

  $('#clear-data-btn').addEventListener('click', ()=>{
    const pw=prompt('Enter admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
    if(!confirm('This will erase ALL data. Continue?'))return;
    books=[]; userData={}; activity=[]; sitePrefs={teamsWebhook:'',postNew:true,postFinish:true,postFive:true,openaiKey:sitePrefs.openaiKey||''};
    saveAll(); populateRecommenderFilter(); populateTagFilter(); applyFilters(); renderActivity(); renderMyLists(); updateStats(); showToast('All data cleared.');
  });
  $('#rename-user-btn').addEventListener('click', ()=>{
    const pw=prompt('Admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
    const from=$('#rename-from').value.trim(); const to=$('#rename-to').value.trim();
    if(!from||!to){ showToast('Enter both names',true); return; }
    if(!userData[from]){ showToast('From user not found',true); return; }
    ensureUser(to);
    ['readList','wishList','currentReading'].forEach(k=>{ const a=userData[to][k]; const b=userData[from][k]; const ids=new Set(a.map(x=>x.id)); b.forEach(x=>{ if(!ids.has(x.id)) a.push(x); }); });
    delete userData[from]; saveAll(); updateStats(); showToast('User renamed/merged');
  });

  // Minimal admin edit: delete book by ID
  $('#delete-book-btn').addEventListener('click', ()=>{
    const pw=prompt('Admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
    const idStr=$('#delete-book-id').value.trim(); if(!idStr){ showToast('Enter a book ID',true); return; }
    const id=Number(idStr);
    const before=books.length;
    books=books.filter(b=>b.id!==id);
    Object.values(userData).forEach(u=>{
      ['readList','wishList','currentReading'].forEach(k=>{ u[k]=u[k].filter(x=>x.id!==id); });
    });
    if(books.length===before){ showToast('No book with that ID found',true); return; }
    saveAll(); applyFilters(); renderMyLists(); updateStats(); showToast('Book deleted.');
  });

  // Minimal admin edit: purge / delete activity
  $('#purge-activity-btn').addEventListener('click', ()=>{
    const pw=prompt('Admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
    const days=parseInt($('#activity-days').value.trim(),10);
    if(!days||days<1){ showToast('Enter a valid number of days',true); return; }
    const cutoff=Date.now() - days*24*3600*1000;
    const before=activity.length;
    activity=activity.filter(a=> new Date(a.at).getTime() >= cutoff );
    saveAll(); renderActivity(); showToast(`Purged ${before-activity.length} activity items.`);
  });
  $('#delete-last-activity-btn').addEventListener('click', ()=>{
    const pw=prompt('Admin password:'); if(pw!==ADMIN_PASSWORD){ showToast('Incorrect password',true); return; }
    if(activity.length){ activity.shift(); saveAll(); renderActivity(); showToast('Most recent activity deleted.'); }
    else { showToast('No activity to delete'); }
  });

  // Removed "System" sample activity; if needed, require login and use current user instead
  // (kept to help testing but no longer posts as "System")
  const postSampleBtn=$('#post-sample-btn');
  if(postSampleBtn){
    postSampleBtn.addEventListener('click', ()=>{
      if(!currentUser){ showToast('Log in first.', true); return; }
      const b=books[0]; if(!b){ showToast('No books yet'); return; }
      postActivity('like',{user:currentUser,title:b.title});
      showToast('Sample like posted.');
    });
  }

  /* Install (PWA) */
  $('#install-app-btn').addEventListener('click', async ()=>{
    const status=$('#install-status'); const standalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone===true;
    if(standalone){ showToast('Already installed'); return; }
    if(deferredPrompt){ deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; if(outcome==='accepted'){ status.textContent='Installed'; showToast('Installed'); } deferredPrompt=null; }
    else{ $('#ios-steps').setAttribute('open','open'); showToast('On iPhone/iPad use Share → Add to Home Screen'); }
  });

  /* AI helper */
  $('#save-openai-key').addEventListener('click', ()=>{ sitePrefs.openaiKey=$('#openai-key').value.trim(); saveAll(); showToast('API key saved (local only)'); });
  $('#clear-openai-key').addEventListener('click', ()=>{ sitePrefs.openaiKey=''; $('#openai-key').value=''; saveAll(); showToast('API key cleared'); });
  $('#reason-suggest').addEventListener('click', async ()=>{ const tone=$('#reason-tone').value||'personal'; const btn=$('#reason-suggest'); setLoading(btn,true); const text=await suggestReason(tone); setLoading(btn,false); $('#reason').value=text; $('#reason').focus(); });

  /* Global clicks: feed interactions & quick jumps */
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-action]'); const jump=e.target.closest('[data-jump]');
    if(jump){ const id=jump.getAttribute('data-jump'); const el=$(`#book-${id}`); if(el){ openSection('feed'); el.scrollIntoView({behavior:'smooth',block:'start'}); } return; }
    if(!btn) return;
    const action=btn.getAttribute('data-action'); const bookId=btn.getAttribute('data-id'); const cid=btn.getAttribute('data-cid');

    const findBook=(id)=>books.find(x=>String(x.id)===String(id));

    if(action==='toggle-comments'){
      const list=$(`[data-list="${bookId}"]`); if(list) list.style.display=(list.style.display==='none'?'grid':'none'); return;
    }

    if(action==='toggle-synopsis'){
      const full=btn.getAttribute('data-full')||''; 
      const wrap=document.querySelector(`.syn[data-syn="${bookId}"]`); if(!wrap) return;
      const span=wrap.querySelector('.syn-text'); if(!span) return;
      const expanded=span.getAttribute('data-expanded')==='true';
      if(expanded){
        span.textContent = (full.length>280? full.slice(0,279)+'…' : full);
        span.setAttribute('data-expanded','false');
        btn.textContent='Read more';
      }else{
        span.textContent = full;
        span.setAttribute('data-expanded','true');
        btn.textContent='Show less';
      }
      return;
    }

    if(action==='like'){
      if(!currentUser){ showToast('Log in to like.',true); return; }
      const b=findBook(bookId); if(!b) return;
      b.postLikedBy=b.postLikedBy||[];
      if(b.postLikedBy.includes(currentUser)){
        b.postLikedBy=b.postLikedBy.filter(n=>n!==currentUser); b.postLikes=Math.max(0,(b.postLikes||0)-1);
      }else{
        b.postLikedBy.push(currentUser); b.postLikes=(b.postLikes||0)+1; mergeOrPostActivity({type:'like',payload:{user:currentUser,title:b.title}});
      }
      saveAll(); applyFilters(); return;
    }

    if(action==='wish'){
      if(!currentUser){ showToast('Log in to add to list.',true); return; }
      const b=findBook(bookId); if(!b) return; ensureUser(currentUser); const mine=me();
      if(!mine.wishList.some(x=>x.id===b.id)) mine.wishList.push({id:b.id,title:b.title,author:b.author});
      addActionComment(b, `${currentUser} added to Want to Read`, currentUser);
      mergeOrPostActivity({type:'list',payload:{user:currentUser,title:b.title,action:'added to Want to Read'}});
      saveAll(); renderMyLists(); updateStats(); showToast('Added to Want to Read'); return;
    }

    if(action==='reading'){
      if(!currentUser){ showToast('Log in to add to list.',true); return; }
      const b=findBook(bookId); if(!b) return; ensureUser(currentUser); const mine=me();
      if(!mine.currentReading.some(x=>x.id===b.id)){ mine.currentReading.push({id:b.id,title:b.title,author:b.author}); mine.wishList=mine.wishList.filter(x=>x.id!==b.id); }
      addActionComment(b, `${currentUser} started reading`, currentUser);
      mergeOrPostActivity({type:'list',payload:{user:currentUser,title:b.title,action:'started reading'}});
      saveAll(); renderMyLists(); updateStats(); showToast('Added to Currently Reading'); return;
    }

    if(action==='finish'){
      if(!currentUser){ showToast('Log in to finish books.',true); return; }
      const b=findBook(bookId); if(!b) return; openFinishModal(b); return;
    }

    if(action==='remove-current'){ ensureUser(currentUser); me().currentReading=me().currentReading.filter(x=>String(x.id)!==String(bookId)); saveAll(); renderMyLists(); updateStats(); return; }
    if(action==='remove-wish'){ ensureUser(currentUser); me().wishList=me().wishList.filter(x=>String(x.id)!==String(bookId)); saveAll(); renderMyLists(); updateStats(); return; }
    if(action==='remove-read'){ ensureUser(currentUser); me().readList=me().readList.filter(x=>String(x.id)!==String(bookId)); saveAll(); renderMyLists(); updateStats(); return; }

    if(action==='add-comment'){
      const wrap=btn.closest('.c-form'); if(!wrap) return;
      const name=wrap.querySelector('[data-field="name"]').value.trim()||currentUser||'Anonymous';
      const text=wrap.querySelector('[data-field="text"]').value.trim(); if(!text){ showToast('Comment cannot be empty.',true); return; }
      const b=findBook(bookId); if(!b) return; b.comments=b.comments||[]; b.comments.push({id:Date.now()+Math.random(),commenter:name,text,likes:0,likedBy:[],system:false});
      mergeOrPostActivity({type:'comment',payload:{user:name,title:b.title}}); saveAll(); applyFilters(); showToast('Comment added!'); return;
    }

    if(action==='like-comment'){
      if(!currentUser){ showToast('Log in to like comments.', true); return; }
      const b=findBook(bookId); if(!b) return; const c=(b.comments||[]).find(x=>String(x.id)===String(cid)); if(!c) return;
      c.likedBy=c.likedBy||[];
      if(c.likedBy.includes(currentUser)){ c.likedBy=c.likedBy.filter(n=>n!==currentUser); c.likes=Math.max(0,(c.likes||0)-1); }
      else { c.likedBy.push(currentUser); c.likes=(c.likes||0)+1; }
      saveAll(); applyFilters(); return;
    }
  });

  // jump from trending items
  const t1=$('#trending-prelogin'); if(t1){ t1.addEventListener('click',(e)=>{ const r=e.target.closest('[data-jump]'); if(!r) return; const id=r.getAttribute('data-jump'); const el=$(`#book-${id}`); if(el){ openSection('feed'); el.scrollIntoView({behavior:'smooth',block:'start'}); } }); }
  const t2=$('#trending'); if(t2){ t2.addEventListener('click',(e)=>{ const r=e.target.closest('[data-jump]'); if(!r) return; const id=r.getAttribute('data-jump'); const el=$(`#book-${id}`); if(el){ openSection('feed'); el.scrollIntoView({behavior:'smooth',block:'start'}); } }); }
});

/* Helpers */
function openSection(id){
  $$('.section').forEach(s=>s.classList.remove('active')); $('#'+id).classList.add('active');
  $$('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(id==='feed') $('#feed-btn').classList.add('active');
  if(id==='add') $('#add-btn').classList.add('active');
  if(id==='my-books') $('#my-books-btn').classList.add('active');
  if(id==='prefs') $('#prefs-btn').classList.add('active');
}
function addActionComment(book, text, who){
  book.comments=book.comments||[];
  book.comments.unshift({id:Date.now()+Math.random(), commenter: who || 'Anonymous', text, likes:0, likedBy:[], system:false});
}
</script>
</body>
</html>
