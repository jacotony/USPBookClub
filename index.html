<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>
<style>
  :root{
    --pine:#2f4a3e; --spruce:#3e5a4c; --sage:#8ca093; --silver:#c2c7c9;
    --mist:#efe6db; --accent:#d59a63; --ink:#2a2f2d; --muted:#5f6b64;
    --line:#dfe5e1; --gold:#b8860b; --glass:rgba(255,255,255,.18);
    --glass-2:rgba(255,255,255,.28); --shadow:0 20px 40px rgba(0,0,0,.10)
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;background:linear-gradient(135deg,var(--spruce) 0%,var(--pine) 45%,var(--sage) 100%);min-height:100vh;padding:20px;color:var(--ink)}
  .container{max-width:1200px;margin:0 auto}
  .header{color:#fff;text-align:center;margin-bottom:30px}
  .header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
  .header p{opacity:.95;font-size:1.1rem}

  .user-info{display:none;justify-content:space-between;align-items:center;background:var(--glass);padding:10px 20px;border-radius:20px;color:#fff;margin-bottom:20px;backdrop-filter:blur(12px);border:1px solid var(--glass-2)}
  .toolbar{display:flex;gap:8px}
  .pill-btn{background:none;border:1px solid #fff;color:#fff;padding:6px 14px;border-radius:14px;cursor:pointer;font-size:12px}
  .pill-btn:hover{background:rgba(255,255,255,.18)}
  .status-chip{margin-left:8px;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.6);opacity:.9}

  .stats-bar{display:flex;justify-content:center;gap:30px;margin-bottom:30px;flex-wrap:wrap}
  .stat-card{background:var(--glass);padding:14px 22px;border-radius:20px;color:#fff;text-align:center;border:1px solid var(--glass-2);backdrop-filter:blur(15px);transition:.25s}
  .stat-card:hover{transform:translateY(-5px);background:rgba(255,255,255,.3)}
  .stat-number{font-size:2rem;font-weight:700;display:block}
  .stat-label{font-size:.9rem;opacity:.9}

  .nav{display:flex;gap:10px;justify-content:center;margin-bottom:30px;flex-wrap:wrap}
  .nav-btn{background:var(--glass);color:#fff;border:2px solid var(--glass-2);padding:12px 24px;border-radius:25px;cursor:pointer;transition:.2s;backdrop-filter:blur(10px)}
  .nav-btn:hover,.nav-btn.active{background:rgba(255,255,255,.34);transform:translateY(-2px)}

  .content{background:rgba(255,255,255,.97);border-radius:20px;padding:30px;box-shadow:var(--shadow)}
  .login-screen{text-align:center;padding:60px 20px}
  .login-form{background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:420px;margin:0 auto}
  .login-form h2{color:var(--spruce);margin-bottom:10px}

  .section{display:none}.section.active{display:block}

  .add-book-form{background:linear-gradient(135deg,var(--mist) 0%,#e9e1d2 100%);padding:24px;border-radius:15px;margin-bottom:30px;border-left:4px solid var(--pine)}
  .form-row{display:flex;gap:12px;flex-wrap:wrap}
  .form-group{flex:1 1 250px;margin-bottom:14px}
  .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--ink)}
  .input,.select,.textarea{width:100%;padding:12px;border:2px solid var(--line);border-radius:8px;font-size:16px;transition:.2s border-color}
  .textarea{resize:vertical;min-height:100px}
  .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--pine)}
  .btn{background:linear-gradient(135deg,var(--pine) 0%,var(--spruce) 100%);color:#fff;border:none;padding:12px 22px;border-radius:25px;cursor:pointer;font-size:16px;font-weight:600;transition:.2s}
  .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(47,74,62,.35)}
  .btn-small{padding:6px 12px;font-size:12px;margin:2px}
  .btn-danger{background:#b74a4a}

  .search-filter{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
  .chip{background:#e8efe9;border:1px solid #d9e4dc;color:#2e4a3a;padding:6px 10px;border-radius:999px;font-size:12px}

  .activity{background:#fff;border-radius:15px;padding:16px 18px;margin-bottom:18px;border-left:4px solid var(--accent);box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .activity-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .activity h3{color:#6b765f}
  .activity-body{max-height:260px;overflow:auto}
  .activity.expanded .activity-body{max-height:520px}
  .activity-item{display:flex;gap:12px;align-items:flex-start;padding:10px 0;border-bottom:1px solid #f1f1f1}
  .activity-item:last-child{border-bottom:none}
  .activity-badge{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#f3eee4}
  .activity-meta{font-size:12px;color:#888}
  .activity-actions{display:flex;align-items:center;gap:8px;margin-top:6px}
  .liked-by-line{font-size:.85rem;color:#3f4e46;margin-top:4px}

  .book-feed{display:flex;flex-direction:column;gap:24px}
  .book-post{background:#fff;border-radius:15px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:.25s;border-left:4px solid var(--pine)}
  .book-post:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
  .post-header{display:flex;gap:18px;margin-bottom:16px;align-items:flex-start}
  .book-cover{width:100px;height:150px;object-fit:cover;border-radius:10px;border:2px solid var(--line);flex-shrink:0}
  .book-cover-placeholder{width:100px;height:150px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#6c757d;flex-shrink:0}
  .book-info{flex:1}
  .book-title{font-size:1.35rem;font-weight:800;color:var(--ink);margin-bottom:6px}
  .book-author{color:var(--muted);margin-bottom:6px;font-style:italic}
  .book-genre{background:var(--pine);color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;font-weight:700;text-transform:uppercase;display:inline-block;margin-bottom:8px}
  .tag{display:inline-block;background:#eef4ef;border:1px solid #dbe7df;color:#2e4a3a;padding:2px 8px;border-radius:999px;font-size:.75rem;margin:2px 6px 0 0;cursor:pointer}
  .tag.removable{background:#ffeaa7;border-color:#fdcb6e}
  .tag.removable:hover{background:#fdcb6e}
  .book-recommender{font-size:.95rem;color:#3e5a4c;font-weight:700;margin-bottom:8px}
  .book-rating{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .stars{display:flex;gap:3px}
  .star{font-size:18px;color:#ddd;cursor:pointer;transition:color .15s;background:none;border:none;padding:2px}
  .star.filled{color:var(--gold)}
  .block-title{font-weight:700;color:#3c4e44;margin-bottom:4px}
  .book-synopsis,.book-reason{color:#555;line-height:1.6;margin-bottom:12px}

  .post-actions{display:flex;gap:12px;align-items:center;padding:12px 0;border-top:1px solid #f0f0f0;border-bottom:1px solid #f0f0f0;margin-bottom:8px;flex-wrap:wrap}
  .action-btn{background:none;border:1px solid var(--pine);color:var(--pine);padding:8px 14px;border-radius:20px;cursor:pointer;transition:.2s;font-size:14px;display:flex;align-items:center;gap:6px}
  .action-btn:hover,.action-btn.active{background:var(--pine);color:#fff}
  .liked-by{font-size:.85rem;color:#3f4e46;margin:4px 0 12px}

  .comments-section{margin-top:8px}
  .comment{background:#f6faf7;padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid #e0ebe4}
  .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .commenter-name{font-weight:700;color:#3e5a4c}
  .comment-text{color:#555;margin-bottom:8px}
  .like-comment-btn{background:none;border:none;color:#999;font-size:12px;cursor:pointer}
  .like-comment-btn.liked,.like-comment-btn:hover{color:#3e5a4c}
  .add-comment{margin-top:10px;background:#fff;padding:14px;border:1px solid #dee2e6;border-radius:10px}
  .comment-form{display:flex;flex-direction:column;gap:10px}
  .comment-input{padding:8px 12px;border:1px solid #dee2e6;border-radius:6px;font-size:14px}
  .comment-textarea{padding:10px 12px;border:1px solid #dee2e6;border-radius:6px;resize:vertical;min-height:60px}

  .reading-list{background:#fff;border-radius:15px;padding:18px;margin-bottom:18px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
  .reading-list h3{color:#3e5a4c;margin-bottom:10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0}
  .list-item:last-child{border-bottom:none}

  .dropdown{position:relative}
  .results{position:absolute;z-index:40;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.12);margin-top:6px;max-height:280px;overflow:auto}
  .result-item{padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer}
  .result-item:hover{background:#f4f7f5}
  .result-cover{width:32px;height:48px;border-radius:6px;object-fit:cover;background:#e9ecef}

  .tags-input-container{position:relative;border:2px solid var(--line);border-radius:8px;padding:8px;min-height:50px;background:#fff;cursor:text}
  .tags-input-container:focus-within{border-color:var(--pine)}
  .tags-display{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
  .tag-input{border:none;outline:none;flex:1;min-width:100px;padding:4px}
  .suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:50;max-height:150px;overflow:auto;margin-top:2px}
  .suggestion-item{padding:8px 12px;cursor:pointer;font-size:14px}
  .suggestion-item:hover{background:#f4f7f5}

  .toast{position:fixed;bottom:24px;right:24px;background:#1d1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#b74a4a}
  .loading{opacity:.6;pointer-events:none}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-radius:50%;border-top-color:#666;animation:spin .8s linear infinite;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10000}
  .modal .card{background:#fff;border-radius:16px;padding:20px;max-width:520px;width:90%;box-shadow:0 12px 36px rgba(0,0,0,.25)}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

  @media (max-width:768px){
    .header h1{font-size:2rem}
    .stats-bar{gap:15px}
    .stat-card{padding:10px 16px}
    .stat-number{font-size:1.5rem}
    .nav{gap:6px}
    .nav-btn{padding:8px 16px;font-size:14px}
    .content{padding:20px;margin:0 -10px}
    .post-header{flex-direction:column;align-items:center;text-align:center;gap:12px}
    .book-info{text-align:center}
    .post-actions{justify-content:center;gap:8px}
    .action-btn{padding:6px 12px;font-size:13px}
    .search-filter{flex-direction:column;gap:8px}
    .form-row{flex-direction:column}
    .user-info{flex-direction:column;gap:10px;text-align:center}
    .toolbar{justify-content:center}
    .activity-head{flex-direction:column;gap:8px;align-items:flex-start}
    .reading-list{padding:14px}
    #top-recommenders{margin:0 10px 20px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Book Club</h1>
      <p>Find your next favorite book</p>
    </div>

    <div id="user-info" class="user-info">
      <span>Welcome, <strong id="current-user-name"></strong>!</span>
      <div class="toolbar">
        <button class="pill-btn" id="logout-btn" type="button">Switch User</button>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card"><span class="stat-number" id="total-books">0</span><span class="stat-label">Books</span></div>
      <div class="stat-card"><span class="stat-number" id="total-reviews">0</span><span class="stat-label">Comments</span></div>
      <div class="stat-card"><span class="stat-number" id="avg-rating">0.0</span><span class="stat-label">Avg Rating</span></div>
      <div class="stat-card"><span class="stat-number" id="books-read">0</span><span class="stat-label">Books Read</span></div>
      <div class="stat-card"><span class="stat-number" id="total-users">0</span><span class="stat-label">Users</span></div>
    </div>

    <div id="top-recommenders" class="reading-list" style="margin-bottom:20px">
      <h3>Top Recommenders</h3>
      <div id="recommenders-list"></div>
    </div>
    <div id="top-readers" class="reading-list" style="margin-bottom:20px">
      <h3>Top Readers</h3>
      <div id="readers-list"></div>
    </div>
    <div id="top-commenters" class="reading-list" style="margin-bottom:20px">
      <h3>Top Commenters</h3>
      <div id="commenters-list"></div>
    </div>

    <nav class="nav">
      <button class="nav-btn active" id="feed-btn">Book Feed</button>
      <button class="nav-btn" id="add-btn">Add Book</button>
      <button class="nav-btn" id="my-books-btn">My Lists</button>
      <button class="nav-btn" id="professional-btn">Professional Books</button>
      <button class="nav-btn" id="prefs-btn">Preferences</button>
    </nav>

    <main class="content">
      <section id="login-section" class="login-screen">
        <form class="login-form" id="login-form">
          <h2>Welcome to Book Club!</h2>
          <p style="margin-bottom:15px;color:var(--muted)">Enter your first name to access your personal reading lists</p>
          <p style="margin-bottom:20px;color:var(--spruce);font-size:14px;font-weight:600;background:#f8f9fa;padding:10px;border-radius:8px">
            Important: Your name is your only login. Use the exact same name each time or your lists won't sync!
          </p>
          <div class="form-group">
            <input class="input" type="text" id="username-input" placeholder="Enter your first name" required style="text-align:center"/>
          </div>
          <button class="btn" type="submit">Enter Book Club</button>
        </form>
      </section>

      <section id="main-app" style="display:none">
        <section id="feed" class="section active">
          <div class="activity" id="activity">
            <div class="activity-head">
              <h3>Activity</h3>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="activity-filter" class="select" style="padding:4px 8px;font-size:12px;min-width:auto">
                  <option value="">All Activity</option>
                  <option value="share">New Books</option>
                  <option value="finish">Finished</option>
                  <option value="five">5★ Ratings</option>
                  <option value="prev">Previously Read</option>
                  <option value="like">Likes</option>
                </select>
                <button id="activity-toggle" class="pill-btn" type="button">Show more</button>
              </div>
            </div>
            <div id="activity-list" class="activity-body"></div>
          </div>

          <div class="search-filter">
            <input type="text" class="input" placeholder="Search title, author, recommender..." id="search-input"/>
            <input type="text" class="input" placeholder="Filter by tag (e.g., sci-fi, leadership)" id="tag-filter" style="max-width:240px"/>
            <select class="select" id="category-filter">
              <option value="">All Categories</option>
              <option value="professional">Professional</option>
              <option value="fiction">Fiction</option>
              <option value="non-fiction">Non-Fiction</option>
              <option value="biography">Biography</option>
              <option value="self-help">Self-Help</option>
              <option value="other">Other</option>
            </select>
            <select class="select" id="recommender-filter">
              <option value="">All Recommenders</option>
            </select>
            <select class="select" id="min-rating">
              <option value="0">Min Rating (Any)</option>
              <option value="5">5★</option>
              <option value="4">4★+</option>
              <option value="3">3★+</option>
            </select>
            <select class="select" id="sort-by">
              <option value="new">Newest</option>
              <option value="likes">Most Likes</option>
              <option value="rating">Rating (High → Low)</option>
              <option value="title">Title (A → Z)</option>
            </select>
            <span class="chip" id="result-count"></span>
          </div>

          <div id="books-feed" class="book-feed"></div>
        </section>

        <section id="add" class="section">
          <div class="add-book-form">
            <h2 style="margin-bottom:10px;color:var(--ink)">Share a Book Recommendation</h2>

            <div class="form-row">
              <div class="form-group"><label><input id="pref-post-new" type="checkbox" checked/> Post on <strong>new book</strong></label></div>
              <div class="form-group"><label><input id="pref-post-finish" type="checkbox" checked/> Post when someone <strong>finishes a book</strong></label></div>
              <div class="form-group"><label><input id="pref-post-5" type="checkbox" checked/> Post for <strong>new 5★ ratings</strong></label></div>
            </div>
            <button id="prefs-save" class="btn" type="button">Save Preferences</button>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <div id="finish-modal" class="modal">
    <div class="card">
      <h3 id="finish-heading" style="margin-bottom:8px">Rate this book</h3>
      <p id="finish-title" style="color:var(--muted);margin-bottom:8px"></p>
      <div class="stars" id="finish-stars" style="margin:8px 0 4px">
        <button class="star" data-rating="1" type="button">★</button>
        <button class="star" data-rating="2" type="button">★</button>
        <button class="star" data-rating="3" type="button">★</button>
        <button class="star" data-rating="4" type="button">★</button>
        <button class="star" data-rating="5" type="button">★</button>
      </div>
      <div class="actions">
        <button class="btn" id="finish-save" type="button">Save</button>
        <button class="btn btn-danger" id="finish-cancel" type="button">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ========= JSONBin Storage & State ========= */
const JSONBIN_API = 'https://api.jsonbin.io/v3';
const BIN_ID = '676a2bb6ad19ca34f8d7ba7f';   // Create a new bin at jsonbin.io
const API_KEY = '$2a$10$mNoiDz9pmi1CAop9lb5yCudKwJeWZeNtdMW/MezkG3J.qchnkMLoy'; // Your API key

let currentUser=''; 
let books=[]; 
let userData={}; 
let activity=[]; 
let currentBooks=[]; 
let currentRating=0;
let finishContext=null; 
let activityExpanded=false;
let sitePrefs={teamsWebhook:'',postNew:true,postFinish:true,postFive:true};
let isLoading=false;
let currentTags = [];

// Common tag suggestions based on genre and popular book categories
const tagSuggestions = [
  'sci-fi', 'fantasy', 'romance', 'mystery', 'thriller', 'horror', 'historical-fiction',
  'young-adult', 'contemporary', 'classic', 'literary-fiction', 'dystopian',
  'leadership', 'business', 'productivity', 'entrepreneurship', 'marketing', 
  'personal-development', 'psychology', 'philosophy', 'history', 'science',
  'technology', 'health', 'fitness', 'cooking', 'travel', 'memoir',
  'comedy', 'drama', 'action', 'adventure', 'coming-of-age', 'family',
  'friendship', 'war', 'politics', 'economics', 'environment', 'social-justice',
  'quick-read', 'page-turner', 'thought-provoking', 'emotional', 'inspiring',
  'educational', 'practical', 'reference', 'beginner-friendly', 'advanced'
];

async function loadAll(){
  if(isLoading) return; 
  isLoading = true;
  
  // First load from localStorage for instant display
  try{
    const cached = JSON.parse(localStorage.getItem('bookclub_payload')||'{}');
    if(cached.books) books = cached.books;
    if(cached.userData) userData = cached.userData;
    if(cached.activity) activity = cached.activity;
    if(cached.sitePrefs) sitePrefs = Object.assign(sitePrefs, cached.sitePrefs);
    currentUser = localStorage.getItem('bookclub_currentUser') || '';
  }catch(e){
    console.error('Failed to load local cache:', e);
  }

  // Then sync with JSONBin
  try{
    const response = await fetch(`${JSONBIN_API}/b/${BIN_ID}/latest`, {
      method: 'GET',
      headers: {
        'X-Master-Key': API_KEY,
        'X-Access-Key': API_KEY
      }
    });
    
    if(!response.ok){
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    const record = data.record || {};
    
    books = record.books || books;
    userData = record.userData || userData;
    activity = record.activity || activity;
    sitePrefs = Object.assign(sitePrefs, record.sitePrefs || {});
    
    // Cache locally
    localStorage.setItem('bookclub_payload', JSON.stringify({books, userData, activity, sitePrefs}));
    
  }catch(e){
    console.error('Failed to sync with JSONBin:', e);
    showToast('Using local data - sync failed. Check connection.', true);
  }
  
  isLoading = false;
}

async function saveAll(){
  // Always save locally first
  try{
    const payload = {books, userData, activity, sitePrefs};
    localStorage.setItem('bookclub_payload', JSON.stringify(payload));
    localStorage.setItem('bookclub_currentUser', currentUser);
  }catch(e){
    console.error('Failed to save locally:', e);
  }
  
  // Then sync to JSONBin
  try{
    const payload = {books, userData, activity, sitePrefs};
    const response = await fetch(`${JSONBIN_API}/b/${BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': API_KEY,
        'X-Access-Key': API_KEY
      },
      body: JSON.stringify(payload)
    });
    
    if(!response.ok){
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  }catch(e){
    console.error('Failed to save to JSONBin:', e);
    showToast('Saved locally - server sync failed. Will retry.', true);
  }
}

const defaultUser=()=>({readList:[],wishList:[],currentReading:[]});
function ensureUser(name){ if(!userData[name]) userData[name]=defaultUser(); }
const me=()=>userData[currentUser]||defaultUser();

/* ========= Utilities ========= */
const $  = (sel, root=document) => root.querySelector(sel);
const $ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const now=()=>new Date().toISOString();
const timeAgo=(iso)=>{const d=new Date(iso);const s=(Date.now()-d)/1000;if(s<60)return`${Math.floor(s)}s ago`;const m=s/60;if(m<60)return`${Math.floor(m)}m ago`;const h=m/60;if(h<24)return`${Math.floor(h)}h ago`;return`${Math.floor(h/24)}d ago`};
const escapeHtml=(s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const escapeAttr=(s='')=>escapeHtml(s).replaceAll('"','&quot;');
const showToast=(msg,isError=false)=>{const t=$('#toast');t.textContent=msg;t.classList.toggle('error',isError);t.classList.add('show');clearTimeout(showToast._t);showToast._t=setTimeout(()=>t.classList.remove('show'),isError?3000:1700);};
const formatStars=(n)=>'★'.repeat(n)+'☆'.repeat(5-n);
const debounce=(fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
const truncate=(s,n=400)=> s && s.length>n ? s.slice(0,n-1)+'…' : s;

function setLoading(element, loading) {
  element.classList.toggle('loading', loading);
  if (loading && !element.querySelector('.spinner')) {
    const span = document.createElement('span');
    span.className = 'spinner';
    element.prepend(span);
  } else if (!loading) {
    const spinner = element.querySelector('.spinner');
    if (spinner) spinner.remove();
  }
}

/* ========= Teams Channel Posting ========= */
async function postToTeams(type, text){
  const url = sitePrefs.teamsWebhook?.trim();
  if(!url) return;
  const allow = (type==='new' && sitePrefs.postNew) || (type==='finish' && sitePrefs.postFinish) || (type==='five' && sitePrefs.postFive);
  if(!allow) return;
  try{ 
    await fetch(url,{
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text})
    }); 
  }catch(e){ 
    console.error('Teams post failed',e); 
  }
}

/* ========= Activity ========= */
function postActivity(type,payload){
  const item = {id:Date.now(), type, payload, at:now(), likes:0, likedBy:[]};
  activity.unshift(item);
  if(activity.length>200) activity.length=200;
  saveAll(); renderActivity();
}
function activityIcon(type){ return ({share:'📣',finish:'🏁','five':'🏆','prev':'📖','like':'👍'}[type]||'📝'); }

/* ========= Ratings helpers ========= */
function ratingCount(book){
  const base = book.rating ? 1 : 0;
  const extra = (book.userRatings?.length)||0;
  return base + extra;
}
function averageRatingForBook(book){
  const vals=[];
  if(book.rating) vals.push(book.rating);
  (book.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number') vals.push(r.rating); });
  if(!vals.length) return 0;
  return vals.reduce((a,b)=>a+b,0)/vals.length;
}

/* ========= Tags System ========= */
function renderTagsDisplay() {
  const container = $('#tags-display');
  container.innerHTML = currentTags.map(tag => `
    <span class="tag removable" data-tag="${escapeAttr(tag)}">
      ${escapeHtml(tag)} ×
    </span>
  `).join('');
}

function addTag(tag) {
  const cleanTag = tag.trim().toLowerCase();
  if (!cleanTag || currentTags.includes(cleanTag)) return;
  currentTags.push(cleanTag);
  renderTagsDisplay();
  $('#tag-input').value = '';
  hideSuggestions();
}

function removeTag(tag) {
  currentTags = currentTags.filter(t => t !== tag);
  renderTagsDisplay();
}

function showSuggestions(input) {
  const query = input.toLowerCase().trim();
  if (!query) {
    hideSuggestions();
    return;
  }
  
  const filtered = tagSuggestions
    .filter(tag => tag.includes(query) && !currentTags.includes(tag))
    .slice(0, 8);
  
  const container = $('#tag-suggestions');
  if (filtered.length === 0) {
    hideSuggestions();
    return;
  }
  
  container.innerHTML = filtered.map(tag => `
    <div class="suggestion-item" data-tag="${escapeAttr(tag)}">
      ${escapeHtml(tag)}
    </div>
  `).join('');
  container.style.display = 'block';
}

function hideSuggestions() {
  $('#tag-suggestions').style.display = 'none';
}

function autoPopulateTagsFromBook(book) {
  // Auto-populate tags based on genre and book data
  const autoTags = [];
  
  // Add genre-based tags
  const genreMap = {
    'fiction': ['fiction'],
    'non-fiction': ['non-fiction'],
    'biography': ['biography', 'memoir'],
    'self-help': ['self-help', 'personal-development'],
    'professional': ['business', 'professional', 'leadership']
  };
  
  if (genreMap[book.genre]) {
    autoTags.push(...genreMap[book.genre]);
  }
  
  // Try to extract tags from description
  const description = (book.description || '').toLowerCase();
  const keywords = ['sci-fi', 'science fiction', 'fantasy', 'romance', 'mystery', 'thriller', 'horror'];
  keywords.forEach(keyword => {
    if (description.includes(keyword)) {
      const tag = keyword.replace('science fiction', 'sci-fi');
      if (!autoTags.includes(tag)) autoTags.push(tag);
    }
  });
  
  // Add unique tags to current tags
  autoTags.forEach(tag => {
    if (!currentTags.includes(tag)) {
      currentTags.push(tag);
    }
  });
  
  renderTagsDisplay();
}

/* ========= Rendering ========= */
function bookCoverBlock(book){
  if (book.image) {
    const searchQuery = encodeURIComponent(`${book.title} ${book.author}`);
    const goodreadsUrl = `https://www.goodreads.com/search?q=${searchQuery}`;
    return `<a href="${goodreadsUrl}" target="_blank" rel="noopener"><img class="book-cover" loading="lazy" alt="Cover of ${escapeHtml(book.title)}" src="${escapeAttr(book.image)}" style="cursor:pointer" title="View on Goodreads"/></a>`;
  } else {
    return `<div class="book-cover-placeholder">No Cover</div>`;
  }
}
function likedByLine(arr=[]){
  if(!arr.length) return '';
  const names = arr.join(', ');
  return `<div class="liked-by"><em>Liked by:</em> ${escapeHtml(names)}</div>`;
}
function tagChips(tags){
  if(!tags||!tags.length) return '';
  return `<div>${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`;
}
function bookCard(book){
  const liked=currentUser && (book.postLikedBy||[]).includes(currentUser);
  const synopsis=book.synopsis||'';
  const reason=book.reason||'';
  const avg=averageRatingForBook(book);
  const rounded=Math.round(avg||0);
  const count=ratingCount(book);
  return `
  <article class="book-post" data-id="${book.id}">
    <div class="post-header">
      ${bookCoverBlock(book)}
      <div class="book-info">
        <div class="book-genre">${escapeHtml(book.genre)}</div>
        <h3 class="book-title">${escapeHtml(book.title)}</h3>
        <div class="book-author">by ${escapeHtml(book.author)}</div>
        <div class="book-recommender">Recommended by ${escapeHtml(book.recommender)}</div>
        <div class="book-rating"><div class="stars">${formatStars(rounded)}</div><span>(${avg.toFixed(1)}/5 • ${count} rating${count===1?'':'s'})</span></div>
        ${tagChips(book.tags)}
      </div>
    </div>

    ${synopsis?`<div class="book-synopsis"><div class="block-title">Synopsis</div>${escapeHtml(synopsis)}</div>`:''}
    ${reason?`<div class="book-reason"><div class="block-title">Why ${escapeHtml(book.recommender)} recommends it</div>${escapeHtml(reason)}</div>`:''}

    <div class="post-actions">
      <button class="action-btn ${liked?'active':''}" type="button" data-action="like" data-id="${book.id}">👍 <span data-like-count>${book.postLikes||0}</span> Likes</button>
      <button class="action-btn" type="button" data-action="wish" data-id="${book.id}">📚 Want to Read</button>
      <button class="action-btn" type="button" data-action="reading" data-id="${book.id}">📖 Currently Reading</button>
      <button class="action-btn" type="button" data-action="finish" data-id="${book.id}">✅ Mark as Read</button>
      <button class="action-btn" type="button" data-action="prev" data-id="${book.id}">✔️ Previously Read</button>
    </div>
    ${likedByLine(book.postLikedBy)}

    <div class="comments-section">
      <strong>Comments (${(book.comments||[]).length}):</strong>
      ${(book.comments||[]).map(c=>`
        <div class="comment" data-comment-id="${c.id}">
          <div class="comment-header">
            <span class="commenter-name">${escapeHtml(c.commenter)}</span>
            <button class="like-comment-btn ${(c.likedBy||[]).includes(currentUser)?'liked':''}" type="button" data-action="like-comment" data-id="${book.id}" data-cid="${c.id}">👍 ${c.likes||0}</button>
          </div>
          <div class="comment-text">${escapeHtml(c.text)}</div>
        </div>`).join('')}
      <div class="add-comment">
        <div class="comment-form" data-id="${book.id}">
          <input type="text" placeholder="Your name" class="comment-input" data-field="name" value="${escapeAttr(currentUser)}"/>
          <textarea placeholder="Write your comment..." class="comment-textarea" data-field="text"></textarea>
          <button class="btn btn-small" type="button" data-action="add-comment" data-id="${book.id}">Add Comment</button>
        </div>
      </div>
    </div>
  </article>`;
}

function renderActivity(){
  const list=$('#activity-list');
  const filter = $('#activity-filter').value;
  const cap = activityExpanded ? 30 : 10;
  const filtered = filter ? activity.filter(a => a.type === filter) : activity;
  if(!filtered.length){
    const msg = filter ? 'No activity for this filter' : 'Welcome! Share a book to kick off the activity feed.';
    list.innerHTML=`<div class="activity-item"><div class="activity-badge">👋</div><div>${msg}</div></div>`;
    return;
  }
  list.innerHTML = filtered.slice(0,cap).map(a=>{
    const {type,payload,at,likes=0,likedBy=[]}=a;
    let text='';
    if(type==='share')      text=`<strong>${escapeHtml(payload.user)}</strong> shared <em>${escapeHtml(payload.title)}</em> by ${escapeHtml(payload.author)} (${payload.rating}★).`;
    else if(type==='finish')text=`<strong>${escapeHtml(payload.user)}</strong> finished <em>${escapeHtml(payload.title)}</em> — ${payload.rating}★.`;
    else if(type==='five')  text=`<strong>${escapeHtml(payload.user)}</strong> rated <em>${escapeHtml(payload.title)}</em> <strong>5★</strong>.`;
    else if(type==='like')  text=`<strong>${escapeHtml(payload.user)}</strong> liked <em>${escapeHtml(payload.title)}</em>.`;
    else                    text=`<strong>${escapeHtml(payload.user)}</strong> marked previously read <em>${escapeHtml(payload.title)}</em>.`;
    const likedByNames = likedBy.length ? `<div class="liked-by-line"><em>Liked by:</em> ${escapeHtml(likedBy.join(', '))}</div>` : '';
    const meLiked = currentUser && likedBy.includes(currentUser);
    const likeBtnClass = 'pill-btn' + (meLiked ? ' active' : '');
    return `<div class="activity-item" data-aid="${a.id}">
      <div class="activity-badge">${activityIcon(type)}</div>
      <div>
        <div>${text}</div>
        <div class="activity-meta">${timeAgo(at)}</div>
        <div class="activity-actions">
          <button class="${likeBtnClass}" type="button" data-action="like-activity" data-aid="${a.id}">👍 ${likes}</button>
        </div>
        ${likedByNames}
      </div>
    </div>`;
  }).join('');
  $('#activity-toggle').textContent = activityExpanded ? 'Show less' : 'Show more';
  $('#activity').classList.toggle('expanded',activityExpanded);
}

function renderBooks(){
  const c=$('#books-feed');
  if(!currentBooks.length){
    c.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted)"><h3>No books found</h3><p>Try adjusting search/filters or add a new recommendation!</p></div>`;
    $('#result-count').textContent='0 results';
    return;
  }
  c.innerHTML=currentBooks.map(bookCard).join('');
  $('#result-count').textContent=`${currentBooks.length} result${currentBooks.length===1?'':'s'}`;
}

function renderProfessionalBooks(){
  const list=books.filter(b=>b.genre==='professional');
  const c=$('#professional-books');
  if(!list.length){c.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted)"><h3>No professional books yet</h3><p>Be the first to recommend one!</p></div>`;return;}
  c.innerHTML=list.map(bookCard).join('');
}

function renderMyLists(){
  const data=me();
  const make=(arr,actions)=> arr.length?arr.map(b=>`
    <div class="list-item" data-id="${b.id}">
      <div><strong>${escapeHtml(b.title)}</strong> by ${escapeHtml(b.author)}</div>
      <div>${actions(b)}</div>
    </div>`).join(''):`<p style="color:#999;font-style:italic">Nothing here yet</p>`;
  $('#current-reading').innerHTML=make(data.currentReading,(b)=>`
    <button class="btn btn-small" type="button" data-action="finish" data-id="${b.id}">Mark as Read</button>
    <button class="btn btn-small btn-danger" type="button" data-action="remove-current" data-id="${b.id}">Remove</button>`);
  $('#wish-list').innerHTML=make(data.wishList,(b)=>`
    <button class="btn btn-small" type="button" data-action="reading" data-id="${b.id}">Start Reading</button>
    <button class="btn btn-small btn-danger" type="button" data-action="remove-wish" data-id="${b.id}">Remove</button>`);
  $('#read-list').innerHTML=make(data.readList,(b)=>`
    <span class="chip">${(b._rating||b.rating||0)}★</span>
    <button class="btn btn-small btn-danger" type="button" data-action="remove-read" data-id="${b.id}">Remove</button>`);
}

/* ========= Stats / Top Lists / Filters ========= */
function updateStats(){
  // global averages over all individual ratings
  let ratingSum=0, ratingN=0;
  books.forEach(b=>{
    if(b.rating){ ratingSum+=b.rating; ratingN++; }
    (b.userRatings||[]).forEach(r=>{ if(typeof r.rating==='number'){ratingSum+=r.rating; ratingN++;} });
  });
  const totalBooks=books.length;
  const totalComments=books.reduce((s,b)=>s+(b.comments?.length||0),0);
  const globalAvg=ratingN ? (ratingSum/ratingN) : 0;
  const readCount=me().readList.length;
  const usersCount=Object.keys(userData||{}).length;
  $('#total-books').textContent=String(totalBooks);
  $('#total-reviews').textContent=String(totalComments);
  $('#avg-rating').textContent=globalAvg.toFixed(1);
  $('#books-read').textContent=String(readCount);
  $('#total-users').textContent=String(usersCount);
  renderTopRecommenders();
  renderTopReaders();
  renderTopCommenters();
}

function renderTopRecommenders(){
  const counts = {};
  books.forEach(b => { const name = b.recommender; if (name) counts[name] = (counts[name] || 0) + 1; });
  const sorted = Object.entries(counts).sort(([,a], [,b]) => b - a).slice(0, 5);
  const container = $('#recommenders-list');
  if (!sorted.length) { container.innerHTML = '<p style="color:#999;font-style:italic">No books shared yet</p>'; return; }
  container.innerHTML = sorted.map(([name, count]) => `
    <div class="list-item">
      <div><strong>${escapeHtml(name)}</strong></div>
      <span class="chip">${count} book${count === 1 ? '' : 's'}</span>
    </div>
  `).join('');
}
function renderTopReaders(){
  const counts = {};
  Object.entries(userData||{}).forEach(([name, data])=>{
    counts[name] = (data.readList||[]).length;
  });
  const sorted = Object.entries(counts).filter(([,n])=>n>0).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const container = $('#readers-list');
  if (!sorted.length) { container.innerHTML = '<p style="color:#999;font-style:italic">No finished books yet</p>'; return; }
  container.innerHTML = sorted.map(([name,count])=>`
    <div class="list-item">
      <div><strong>${escapeHtml(name)}</strong></div>
      <span class="chip">${count} read</span>
    </div>`).join('');
}
function renderTopCommenters(){
  const counts = {};
  books.forEach(b => (b.comments||[]).forEach(c=>{
    const n=c.commenter||'Anonymous';
    counts[n]=(counts[n]||0)+1;
  }));
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const container = $('#commenters-list');
  if (!sorted.length) { container.innerHTML = '<p style="color:#999;font-style:italic">No comments yet</p>'; return; }
  container.innerHTML = sorted.map(([name,count])=>`
    <div class="list-item">
      <div><strong>${escapeHtml(name)}</strong></div>
      <span class="chip">${count} comment${count===1?'':'s'}</span>
    </div>`).join('');
}

function getUniqueRecommenders(){ return Array.from(new Set(books.map(b=>b.recommender).filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }
function populateRecommenderFilter(){
  const sel=$('#recommender-filter'); const cur=sel.value;
  sel.innerHTML=['<option value="">All Recommenders</option>'].concat(getUniqueRecommenders().map(n=>`<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`)).join('');
  if(cur && getUniqueRecommenders().includes(cur)) sel.value=cur;
}

/* Advanced search scoring */
function bookSearchScore(b, t){
  if(!t) return 1;
  const term=t.toLowerCase();
  const inStr=(s)=> (s||'').toLowerCase();
  let score=0;
  const title=inStr(b.title), author=inStr(b.author), rec=inStr(b.recommender), syn=inStr(b.synopsis), rea=inStr(b.reason);
  const tags=(b.tags||[]).map(x=>x.toLowerCase());
  if(title===term) score+=100;
  if(title.startsWith(term)) score+=60;
  if(title.includes(term)) score+=30;
  if(author.startsWith(term)) score+=30;
  if(author.includes(term)) score+=20;
  if(rec.includes(term)) score+=15;
  if(rea.includes(term)) score+=12;
  if(syn.includes(term)) score+=10;
  if(tags.some(x=>x.includes(term))) score+=25;
  return score;
}

function applyFilters(){
  const term=$('#search-input').value.trim();
  const tagTerm=$('#tag-filter').value.trim().toLowerCase();
  const cat=$('#category-filter').value;
  const who=$('#recommender-filter').value;
  const min=parseInt($('#min-rating').value,10)||0;
  const sort=$('#sort-by').value;

  const list = books
    .map(b=>({ ...b, _score: bookSearchScore(b, term) }))
    .filter(b=>{
      if(term && b._score<=0) return false;
      if(cat && b.genre!==cat) return false;
      if(who && b.recommender!==who) return false;
      if(min && averageRatingForBook(b) < min) return false;
      if(tagTerm && !(b.tags||[]).some(t=> String(t).toLowerCase().includes(tagTerm))) return false;
      return true;
    });

  if(term){
    list.sort((a,b)=> b._score - a._score || b.id - a.id);
  }else if(sort==='new'){ list.sort((a,b)=>b.id-a.id); }
  else if(sort==='likes'){ list.sort((a,b)=>(b.postLikes||0)-(a.postLikes||0)); }
  else if(sort==='rating'){ list.sort((a,b)=>averageRatingForBook(b)-averageRatingForBook(a)); }
  else if(sort==='title'){ list.sort((a,b)=>a.title.localeCompare(b.title)); }

  currentBooks=list;
  renderBooks();
}

/* ========= Google Books API Search ========= */
const searchGoogleBooks = debounce(async (q)=>{
  const box=$('#book-results');
  const input = $('#book-search');
  if(!q||q.trim().length<2){ box.style.display='none'; box.innerHTML=''; return; }

  try{
    setLoading(input, true);
    const query = encodeURIComponent(q.trim());
    const url = `https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=10`;
    const r=await fetch(url);
    if (!r.ok) throw new Error(`Search failed: ${r.status}`);
    const data=await r.json();
    setLoading(input, false);

    const items = data.items || [];
    if(!items.length){ 
      box.innerHTML='<div class="result-item"><div style="color:#999;font-style:italic">No results found</div></div>';
      box.style.display='block';
      return; 
    }
    
    const rows = items.map((item, index) => {
      const info = item.volumeInfo || {};
      const title = info.title || 'Unknown Title';
      const authors = (info.authors || []).join(', ') || 'Unknown Author';
      const thumbnail = info.imageLinks?.thumbnail || '';
      const description = info.description || '';
      const categories = info.categories || [];
      
      return {
        title,
        author: authors,
        cover: thumbnail,
        description,
        categories,
        index
      };
    });

    box.innerHTML=rows.map((r)=>`
      <div class="result-item" data-i="${r.index}">
        <img class="result-cover" src="${r.cover||''}" alt="" onerror="this.style.display='none'"/>
        <div>
          <div><strong>${escapeHtml(r.title)}</strong></div>
group dropdown" style="flex:2 1 380px">
                <label for="book-search">Search books to auto-fill (Google Books)</label>
                <input id="book-search" class="input" type="text" placeholder="Start typing a title or author..."/>
                <div id="book-results" class="results" style="display:none"></div>
              </div>
            </div>

            <form id="book-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="title">Book Title *</label>
                  <input class="input" type="text" id="title" required/>
                </div>
                <div class="form-group">
                  <label for="author">Author *</label>
                  <input class="input" type="text" id="author" required/>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="genre">Category</label>
                  <select class="select" id="genre">
                    <option value="fiction">Fiction</option>
                    <option value="non-fiction">Non-Fiction</option>
                    <option value="biography">Biography</option>
                    <option value="self-help">Self-Help</option>
                    <option value="other">Other</option>
                    <option value="professional">Professional</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="recommender">Your Name</label>
                  <input class="input" type="text" id="recommender" required/>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="book-image">Book Cover Image (optional)</label>
                  <input class="input" type="url" id="book-image" placeholder="https://example.com/book-cover.jpg"/>
                </div>
              </div>

              <div class="form-group">
                <label for="synopsis">Synopsis (auto-filled when available)</label>
                <textarea class="textarea" id="synopsis" placeholder="Book description..."></textarea>
              </div>

              <div class="form-group">
                <label for="reason">Why I recommend this book *</label>
                <textarea class="textarea" id="reason" placeholder="What did you love about it? Why should others read it?" required></textarea>
              </div>

              <div class="form-group">
                <label>Tags</label>
                <div class="tags-input-container" id="tags-container">
                  <div class="tags-display" id="tags-display"></div>
                  <input type="text" class="tag-input" id="tag-input" placeholder="Add tags (e.g., sci-fi, leadership)..."/>
                  <div class="suggestions" id="tag-suggestions" style="display:none"></div>
                </div>
              </div>

              <div class="form-group">
                <label>Your Rating *</label>
                <div class="stars" id="rating-stars" aria-label="rating stars" style="margin-top:6px">
                  <button class="star" type="button" data-rating="1">★</button>
                  <button class="star" type="button" data-rating="2">★</button>
                  <button class="star" type="button" data-rating="3">★</button>
                  <button class="star" type="button" data-rating="4">★</button>
                  <button class="star" type="button" data-rating="5">★</button>
                </div>
                <div id="rating-feedback" style="font-size:14px;color:var(--muted);margin-top:4px">Click stars to rate (required)</div>
              </div>

              <button type="submit" class="btn">Share Book</button>
            </form>
          </div>
        </section>

        <section id="my-books" class="section">
          <h2 style="margin-bottom:12px;color:var(--ink)">My Reading Lists</h2>
          <div class="reading-list">
            <h3>Currently Reading</h3>
            <div id="current-reading"></div>
          </div>
          <div class="reading-list">
            <h3>Want to Read</h3>
            <div id="wish-list"></div>
          </div>
          <div class="reading-list">
            <h3>Previously Read</h3>
            <div id="read-list"></div>
          </div>
        </section>

        <section id="professional" class="section">
          <h2 style="margin-bottom:10px;color:var(--ink)">Professional Development Books</h2>
          <p style="margin-bottom:18px;color:var(--muted)">Books for professional growth</p>
          <div id="professional-books" class="book-feed"></div>
        </section>

        <section id="prefs" class="section">
          <h2 style="margin-bottom:12px;color:var(--ink)">Preferences</h2>

          <div class="reading-list">
            <h3>Export / Backup</h3>
            <p style="color:var(--muted);margin-bottom:8px">Downloads Excel-friendly CSV files (books.csv and comments.csv).</p>
            <button id="export-csv-btn" class="btn" type="button">Download CSVs</button>
          </div>

          <div class="reading-list">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Admin</h3>
              <button id="toggle-danger" class="pill-btn" type="button">Show Danger Zone</button>
            </div>
          </div>

          <div class="reading-list" id="data-management" style="display:none">
            <h3>Data Management (Danger Zone)</h3>
            <div class="form-row">
              <div class="form-group">
                <button id="clear-data-btn" class="btn btn-danger" type="button">Clear All Data</button>
                <p style="color:var(--muted);font-size:12px;margin-top:4px">
                  Requires admin password and confirmation.
                </p>
              </div>
            </div>
          </div>

          <div class="reading-list">
            <h3>Teams Channel Notifications</h3>
            <p style="color:var(--muted);margin-bottom:8px">
              Optional. Add an <em>Incoming Webhook</em> to your Teams <strong>channel</strong>, then paste the URL here.
            </p>
            <div class="form-row">
              <div class="form-group" style="flex:2 1 520px">
                <label for="pref-teams-url">Teams Webhook URL</label>
                <input id="pref-teams-url" class="input" type="url" placeholder="https://outlook.office.com/webhook/..."/>
              </div>
            </div>
            <div class="form-row">
              <div class="form-
