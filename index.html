<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Book Club</title>
<style>
  :root{
    --pine:#2f4a3e; --spruce:#3e5a4c; --sage:#8ca093; --silver:#c2c7c9;
    --mist:#f5efe7; --accent:#d59a63; --ink:#2a2f2d; --line:#dfe5e1;
  }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--mist);color:var(--ink)}
  header{background:linear-gradient(90deg,var(--pine),var(--spruce));color:#fff;padding:16px 20px;display:flex;gap:16px;align-items:center;justify-content:space-between}
  header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.4px}
  .brand{display:flex;align-items:center;gap:10px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab-btn{border:0;border-radius:10px;padding:8px 12px;background:#ffffff20;color:#fff;cursor:pointer}
  .tab-btn.active{background:#fff;color:var(--pine);font-weight:700}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  label{display:block;font-size:13px;color:#4a5550;margin-bottom:6px}
  input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  button.primary{background:var(--pine);color:#fff;border-color:transparent;cursor:pointer}
  button.primary:hover{filter:brightness(.95)}
  button.ghost{background:#fff;color:var(--pine)}
  .right{margin-left:auto}
  .muted{color:#6b716d;font-size:13px}
  .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .stat{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;text-align:center}
  .stat .n{font-size:28px;font-weight:800;color:var(--pine)}
  .list{display:grid;gap:10px}
  .book{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .book h4{margin:0 0 4px 0}
  .activity-item{padding:8px 10px;border-left:4px solid var(--accent);background:#fff;border-radius:8px}
  .hl{font-weight:700}
  .topbar{display:flex;gap:10px;align-items:center}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px}
  .rightbar{display:flex;gap:8px;align-items:center}
  .error{background:#ffe8e8;border:1px solid #ffb8b8;color:#7a1f1f;border-radius:10px;padding:10px;margin-top:8px}
  .success{background:#e7fbef;border:1px solid #b9f3d2;color:#0a5130;border-radius:10px;padding:10px;margin-top:8px}
  .hide{display:none}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>ðŸ“š Book Club</h1>
  </div>
  <div class="topbar rightbar">
    <span id="currentUser" class="pill">Not signed in</span>
    <button id="btnSignIn" class="tab-btn">Sign in</button>
    <button id="btnSignOut" class="tab-btn hide">Sign out</button>
  </div>
</header>

<div class="wrap">
  <!-- Tabs -->
  <div class="tabs card">
    <button class="tab-btn active" data-tab="main">Main</button>
    <button class="tab-btn" data-tab="add">Add Book</button>
    <button class="tab-btn" data-tab="books">Books</button>
  </div>

  <!-- MAIN -->
  <section id="tab-main" class="card">
    <h2 style="margin-top:0">Dashboard</h2>
    <div class="stats" style="margin:12px 0 6px">
      <div class="stat"><div class="n" id="statBooks">0</div><div class="muted">Books</div></div>
      <div class="stat"><div class="n" id="statUsers">0</div><div class="muted">Users</div></div>
      <div class="stat"><div class="n" id="statComments">0</div><div class="muted">Comments</div></div>
    </div>
    <div class="row">
      <div class="col">
        <h3>Recent Activity</h3>
        <div id="activityList" class="list"></div>
      </div>
      <div class="col">
        <h3>Quick Add</h3>
        <form id="quickAddForm">
          <label>Title</label><input id="qaTitle" required />
          <label>Author</label><input id="qaAuthor" />
          <button class="primary" type="submit" style="margin-top:8px">Add Book</button>
          <div id="qaMsg" class="muted"></div>
        </form>
      </div>
    </div>
  </section>

  <!-- ADD BOOK -->
  <section id="tab-add" class="card hide">
    <h2 style="margin-top:0">Add a Book</h2>
    <form id="addBookForm">
      <div class="row">
        <div class="col">
          <label>Title</label>
          <input id="title" required />
        </div>
        <div class="col">
          <label>Author</label>
          <input id="author" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Category</label>
          <select id="category">
            <option>Fiction</option>
            <option>Nonfiction</option>
            <option>Fantasy</option>
            <option>Romance</option>
            <option>Thriller</option>
            <option>History</option>
            <option>Biography</option>
            <option>Business</option>
            <option>Self-Help</option>
            <option>Mystery</option>
            <option>Sci-Fi</option>
            <option>Classic</option>
            <option>Young Adult</option>
          </select>
        </div>
        <div class="col">
          <label>Custom Category (optional)</label>
          <input id="catCustom" placeholder="e.g., Pirate Fantasy" />
        </div>
      </div>
      <div>
        <label>Why would you recommend it? (optional)</label>
        <textarea id="why"></textarea>
      </div>
      <button class="primary" type="submit" style="margin-top:10px">Save Book</button>
      <div id="addMsg" class="muted"></div>
    </form>
  </section>

  <!-- BOOKS -->
  <section id="tab-books" class="card hide">
    <div class="row" style="align-items:flex-end">
      <div class="col"><h2 style="margin:0">Books</h2></div>
      <div class="col">
        <label>Search</label>
        <input id="search" placeholder="Title or authorâ€¦" />
      </div>
    </div>
    <div id="booksList" class="list" style="margin-top:10px"></div>
  </section>

  <!-- SIGN IN MODAL (super simple) -->
  <section id="signinModal" class="card hide">
    <h3 style="margin-top:0">Sign in</h3>
    <div class="row">
      <div class="col"><label>Name</label><input id="siName" placeholder="Jane Doe" /></div>
      <div class="col"><label>Email</label><input id="siEmail" placeholder="jane@example.com" /></div>
    </div>
    <div class="row">
      <div class="col">
        <button id="doSignIn" class="primary">Continue</button>
        <button id="cancelSignIn" class="ghost">Cancel</button>
        <div id="siMsg" class="muted"></div>
      </div>
    </div>
  </section>

  <div id="globalMsg" class="error hide"></div>
</div>

<script>
  // ---------------- CONFIG: EDIT THESE TWO LINES ----------------
  const CONFIG = {
    BIN_ID: "PUT_YOUR_JSONBIN_ID_HERE",         // e.g., "68b1dc30ae596e708fdb3ff1"
    MASTER_KEY: "PUT_YOUR_X_MASTER_KEY_HERE"    // e.g., "$2a$10$...."
  };
  // --------------------------------------------------------------

  const BIN_URL = `https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`;
  const HEADERS_GET = {"X-Master-Key": CONFIG.MASTER_KEY, "X-Bin-Meta":"false"};
  const HEADERS_PUT = {"X-Master-Key": CONFIG.MASTER_KEY, "Content-Type":"application/json"};

  // Minimal in-memory cache
  let DB = { users:[], books:[], activity:[] };
  let currentUser = null;

  // ---------- Utilities ----------
  const $ = (id)=>document.getElementById(id);
  const show = (el, yes=true)=> el.classList[yes?'remove':'add']('hide');
  const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);

  function toast(id, msg, ok=true){
    const el=$(id); el.textContent=msg; el.className = ok?'success':'error';
    show(el,true); setTimeout(()=>show(el,false), 2000);
  }

  function setUserUI(){
    $('currentUser').textContent = currentUser ? `Signed in: ${currentUser.name}` : 'Not signed in';
    show($('btnSignIn'), !currentUser);
    show($('btnSignOut'), !!currentUser);
  }

  function setActiveTab(name){
    document.querySelectorAll('.tab-btn').forEach(b=>{
      if(b.dataset.tab){ b.classList.toggle('active', b.dataset.tab===name); }
    });
    ['main','add','books'].forEach(t=> show($('tab-'+t), t===name));
    // collapse modal if open
    show($('signinModal'), false);
  }

  // ---------- Remote DB (JSONBin) ----------
  async function loadRemote(){
    const r = await fetch(BIN_URL, {headers:HEADERS_GET});
    if(!r.ok) throw new Error('Failed to load from JSONBin');
    const data = await r.json();
    if(!data.users) data.users=[];
    if(!data.books) data.books=[];
    if(!data.activity) data.activity=[];
    DB = data;
  }

  async function saveRemote(){
    const r = await fetch(BIN_URL, {method:'PUT', headers:HEADERS_PUT, body:JSON.stringify(DB)});
    if(!r.ok) throw new Error('Failed to save to JSONBin');
  }

  // ---------- Auth ----------
  async function ensureUser(name,email){
    name = (name||'').trim(); email=(email||'').trim().toLowerCase();
    if(!name) throw new Error('Enter a name');
    await loadRemote();
    let u = DB.users.find(x=> x.email && x.email===email) || DB.users.find(x=> x.name===name);
    if(!u){
      u = { id: uid(), name, email };
      DB.users.push(u);
      DB.activity.unshift({type:'user_join', userId:u.id, name:u.name, ts:Date.now()});
      await saveRemote();
    }
    currentUser = u;
    localStorage.setItem('bc_user', JSON.stringify(u));
    setUserUI();
    await refreshUI();
  }

  function signOut(){
    currentUser = null;
    localStorage.removeItem('bc_user');
    setUserUI();
  }

  // ---------- Books ----------
  async function addBook({title,author,category,why}){
    if(!currentUser) throw new Error('Please sign in first');
    await loadRemote();
    const cat = (category || '').trim();
    DB.books.unshift({
      id: uid(), title:title.trim(), author:(author||'').trim(),
      category: cat, why:(why||'').trim(),
      createdAt: Date.now(), userId: currentUser.id, userName: currentUser.name,
      comments: []
    });
    DB.activity.unshift({
      type:'book_added', userId: currentUser.id, name: currentUser.name,
      title:title.trim(), ts: Date.now()
    });
    await saveRemote();
    await refreshUI();
  }

  // ---------- UI Renderers ----------
  function renderStats(){
    $('statBooks').textContent = DB.books.length;
    $('statUsers').textContent = DB.users.length;
    const comments = DB.books.reduce((n,b)=> n + (b.comments?b.comments.length:0), 0);
    $('statComments').textContent = comments;
  }

  function renderActivity(){
    const root = $('activityList');
    root.innerHTML = '';
    const items = DB.activity.slice(0,10);
    if(items.length===0){ root.innerHTML = '<div class="muted">No activity yet.</div>'; return; }
    for(const a of items){
      const d = new Date(a.ts).toLocaleString();
      let line = '';
      if(a.type==='book_added'){
        line = `<span class="hl">${a.name}</span> added <span class="hl">${a.title}</span>`;
      } else if(a.type==='user_join'){
        line = `<span class="hl">${a.name}</span> joined the club`;
      }
      const div = document.createElement('div');
      div.className='activity-item';
      div.innerHTML = `${line} <span class="muted">(${d})</span>`;
      root.appendChild(div);
    }
  }

  function renderBooks(filter=''){
    const root = $('booksList');
    root.innerHTML='';
    const q = (filter||'').toLowerCase();
    const list = DB.books.filter(b =>
      b.title.toLowerCase().includes(q) || (b.author||'').toLowerCase().includes(q)
    );
    if(list.length===0){ root.innerHTML = '<div class="muted">No books yet.</div>'; return; }
    for(const b of list){
      const el = document.createElement('div');
      el.className='book';
      el.innerHTML = `
        <div>
          <h4>${b.title}</h4>
          <div class="muted">${b.author||'Unknown'} â€¢ ${b.category||'Uncategorized'}</div>
          ${b.why ? `<div style="margin-top:6px">${b.why}</div>` : ''}
        </div>
        <div class="muted right">by ${b.userName||'Someone'}</div>
      `;
      root.appendChild(el);
    }
  }

  async function refreshUI(){
    await loadRemote();
    renderStats();
    renderActivity();
    renderBooks($('search').value);
  }

  // ---------- Events ----------
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.classList.contains('tab-btn') && t.dataset.tab){
      setActiveTab(t.dataset.tab);
    }
  });

  $('btnSignIn').onclick = ()=> { $('siMsg').textContent=''; show($('signinModal'),true); };
  $('cancelSignIn').onclick = ()=> show($('signinModal'),false);
  $('doSignIn').onclick = async ()=>{
    try{
      $('siMsg').textContent='Signing inâ€¦';
      await ensureUser($('siName').value, $('siEmail').value);
      $('siMsg').textContent='Signed in!';
      show($('signinModal'),false);
    }catch(err){ $('siMsg').textContent = err.message; }
  };
  $('btnSignOut').onclick = ()=> { signOut(); setActiveTab('main'); };

  $('addBookForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    try{
      const title = $('title').value;
      const author = $('author').value;
      let category = $('category').value;
      const c2 = $('catCustom').value.trim();
      if(c2) category = c2;
      const why = $('why').value;
      $('addMsg').textContent='Savingâ€¦';
      await addBook({title,author,category,why});
      $('addMsg').textContent='Saved!';
      e.target.reset();
      setActiveTab('books');
    }catch(err){
      $('addMsg').textContent = err.message;
    }
  });

  $('quickAddForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    try{
      const title = $('qaTitle').value;
      const author = $('qaAuthor').value;
      $('qaMsg').textContent='Savingâ€¦';
      await addBook({title,author,category:'Uncategorized',why:''});
      $('qaMsg').textContent='Saved!';
      e.target.reset();
    }catch(err){
      $('qaMsg').textContent = err.message;
    }
  });

  $('search').addEventListener('input', ()=> renderBooks($('search').value));

  // ---------- Boot ----------
  (async function init(){
    // load current user if present
    try{
      const u = localStorage.getItem('bc_user');
      if(u) currentUser = JSON.parse(u);
    }catch{}
    setUserUI();
    try{
      await refreshUI();
    }catch(err){
      const g=$('globalMsg'); g.textContent = err.message; show(g,true);
    }
  })();
</script>
</body>
</html>
