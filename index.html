<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>
<style>
  :root{--green-1:#8fac7e;--green-2:#6b8e5a;--sand-1:#a0956b;--glass:rgba(255,255,255,.2);--glass-2:rgba(255,255,255,.3);--ink:#333;--muted:#666;--line:#e9ecef;--gold:#b8860b;--shadow:0 20px 40px rgba(0,0,0,.1)}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--green-1) 0%,var(--green-2) 50%,var(--sand-1) 100%);min-height:100vh;padding:20px}
  .container{max-width:1200px;margin:0 auto}
  .header{color:#fff;text-align:center;margin-bottom:30px}
  .header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
  .header p{opacity:.9;font-size:1.1rem}
  .user-info{display:none;justify-content:space-between;align-items:center;background:var(--glass);padding:10px 20px;border-radius:20px;color:#fff;margin-bottom:20px;backdrop-filter:blur(12px)}
  .toolbar{display:flex;gap:8px}
  .pill-btn{background:none;border:1px solid #fff;color:#fff;padding:6px 14px;border-radius:14px;cursor:pointer;font-size:12px}
  .pill-btn:hover{background:rgba(255,255,255,.2)}
  .stats-bar{display:flex;justify-content:center;gap:30px;margin-bottom:30px;flex-wrap:wrap}
  .stat-card{background:var(--glass);padding:14px 22px;border-radius:20px;color:#fff;text-align:center;border:1px solid var(--glass-2);backdrop-filter:blur(15px);transition:.25s}
  .stat-card:hover{transform:translateY(-5px);background:rgba(255,255,255,.32)}
  .stat-number{font-size:2rem;font-weight:700;display:block}
  .stat-label{font-size:.9rem;opacity:.9}
  .nav{display:flex;gap:10px;justify-content:center;margin-bottom:30px;flex-wrap:wrap}
  .nav-btn{background:var(--glass);color:#fff;border:2px solid var(--glass-2);padding:12px 24px;border-radius:25px;cursor:pointer;transition:.2s;backdrop-filter:blur(10px)}
  .nav-btn:hover,.nav-btn.active{background:rgba(255,255,255,.34);transform:translateY(-2px)}
  .content{background:rgba(255,255,255,.97);border-radius:20px;padding:30px;box-shadow:var(--shadow)}
  .login-screen{text-align:center;padding:60px 20px}
  .login-form{background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:420px;margin:0 auto}
  .login-form h2{color:#6b8e5a;margin-bottom:10px}
  .section{display:none}.section.active{display:block}
  .add-book-form{background:linear-gradient(135deg,#f5f2e8 0%,#ede5d3 100%);padding:24px;border-radius:15px;margin-bottom:30px;border-left:4px solid var(--green-1)}
  .form-row{display:flex;gap:12px;flex-wrap:wrap}
  .form-group{flex:1 1 250px;margin-bottom:14px}
  .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--ink)}
  .input,.select,.textarea{width:100%;padding:12px;border:2px solid var(--line);border-radius:8px;font-size:16px;transition:.2s border-color}
  .textarea{resize:vertical;min-height:100px}
  .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--green-1)}
  .btn{background:linear-gradient(135deg,var(--green-1) 0%,var(--green-2) 100%);color:#fff;border:none;padding:12px 22px;border-radius:25px;cursor:pointer;font-size:16px;font-weight:600;transition:.2s}
  .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(143,172,126,.4)}
  .btn-small{padding:6px 12px;font-size:12px;margin:2px}
  .btn-danger{background:#dc3545}
  .search-filter{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
  .chip{background:#eef3ea;border:1px solid #dfe8d7;color:#3a5630;padding:6px 10px;border-radius:999px;font-size:12px}
  .book-feed{display:flex;flex-direction:column;gap:24px}
  .activity{background:#fff;border-radius:15px;padding:16px 18px;margin-bottom:18px;border-left:4px solid var(--sand-1);box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .activity h3{margin-bottom:8px;color:#5b6540}
  .activity-item{display:flex;gap:12px;align-items:flex-start;padding:10px 0;border-bottom:1px solid #f1f1f1}
  .activity-item:last-child{border-bottom:none}
  .activity-badge{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#f1efe5}
  .activity-meta{font-size:12px;color:#888}
  .book-post{background:#fff;border-radius:15px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:.25s;border-left:4px solid var(--green-1)}
  .book-post:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
  .post-header{display:flex;gap:18px;margin-bottom:16px;align-items:flex-start}
  .book-cover{width:100px;height:150px;object-fit:cover;border-radius:10px;border:2px solid var(--line);flex-shrink:0}
  .book-cover-placeholder{width:100px;height:150px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#6c757d;flex-shrink:0}
  .book-info{flex:1}
  .book-title{font-size:1.35rem;font-weight:800;color:var(--ink);margin-bottom:6px}
  .book-author{color:#666;margin-bottom:6px;font-style:italic}
  .book-genre{background:var(--green-1);color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;font-weight:700;text-transform:uppercase;display:inline-block;margin-bottom:8px}
  .book-recommender{font-size:.95rem;color:#6b8e5a;font-weight:600;margin-bottom:10px}
  .book-rating{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .stars{display:flex;gap:3px}
  .star{font-size:18px;color:#999;cursor:pointer;transition:color .15s}
  .star.filled,.star:hover{color:#b8860b}
  .book-description{color:#555;line-height:1.6;margin-bottom:16px}
  .post-actions{display:flex;gap:12px;align-items:center;padding:12px 0;border-top:1px solid #f0f0f0;border-bottom:1px solid #f0f0f0;margin-bottom:14px;flex-wrap:wrap}
  .action-btn{background:none;border:1px solid var(--green-1);color:var(--green-1);padding:8px 14px;border-radius:20px;cursor:pointer;transition:.2s;font-size:14px;display:flex;align-items:center;gap:6px}
  .action-btn:hover,.action-btn.active{background:var(--green-1);color:#fff}
  .comments-section{margin-top:8px}
  .comment{background:#f8f9fa;padding:12px;border-radius:10px;margin-bottom:10px}
  .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .commenter-name{font-weight:700;color:#6b8e5a}
  .comment-rating{color:#b8860b;font-size:14px}
  .comment-text{color:#555;margin-bottom:8px}
  .like-comment-btn{background:none;border:none;color:#999;font-size:12px;cursor:pointer}
  .like-comment-btn.liked,.like-comment-btn:hover{color:#6b8e5a}
  .add-comment{margin-top:10px;background:#fff;padding:14px;border:1px solid #dee2e6;border-radius:10px}
  .comment-form{display:flex;flex-direction:column;gap:10px}
  .comment-input-row{display:flex;gap:10px;align-items:center}
  .comment-input{flex:1;padding:8px 12px;border:1px solid #dee2e6;border-radius:6px;font-size:14px}
  .comment-textarea{padding:10px 12px;border:1px solid #dee2e6;border-radius:6px;resize:vertical;min-height:60px}
  .reading-list{background:#fff;border-radius:15px;padding:18px;margin-bottom:18px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
  .reading-list h3{color:#6b8e5a;margin-bottom:10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0}
  .list-item:last-child{border-bottom:none}
  .empty-state{text-align:center;padding:50px 20px;color:#666}
  .dropdown{position:relative}
  .results{position:absolute;z-index:40;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.12);margin-top:6px;max-height:280px;overflow:auto}
  .result-item{padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer}
  .result-item:hover{background:#f5f7f2}
  .result-cover{width:32px;height:48px;border-radius:6px;object-fit:cover;background:#e9ecef}
  .toast{position:fixed;bottom:24px;right:24px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1;transform:translateY(0)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10000}
  .modal .card{background:#fff;border-radius:16px;padding:20px;max-width:420px;width:90%;box-shadow:0 12px 36px rgba(0,0,0,.25)}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  @media (max-width:768px){.post-header{flex-direction:column;align-items:center;text-align:center}.post-actions{flex-wrap:wrap}.search-filter{flex-direction:column}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>US Probation Book Club</h1>
      <p>Find your next favorite book with your colleagues</p>
    </div>

    <div id="user-info" class="user-info" aria-live="polite">
      <span>Welcome, <strong id="current-user-name"></strong>!</span>
      <div class="toolbar">
        <button class="pill-btn" id="export-btn" type="button">Export Data</button>
        <button class="pill-btn" id="logout-btn" type="button">Switch User</button>
      </div>
    </div>

    <div class="stats-bar" role="region" aria-label="Stats">
      <div class="stat-card"><span class="stat-number" id="total-books">0</span><span class="stat-label">Books</span></div>
      <div class="stat-card"><span class="stat-number" id="total-reviews">0</span><span class="stat-label">Reviews</span></div>
      <div class="stat-card"><span class="stat-number" id="avg-rating">0.0</span><span class="stat-label">Avg Rating</span></div>
      <div class="stat-card"><span class="stat-number" id="books-read">0</span><span class="stat-label">Books Read</span></div>
    </div>

    <nav class="nav" aria-label="Primary">
      <button class="nav-btn active" id="feed-btn" type="button">Book Feed</button>
      <button class="nav-btn" id="add-btn" type="button">Add Book</button>
      <button class="nav-btn" id="my-books-btn" type="button">My Lists</button>
      <button class="nav-btn" id="professional-btn" type="button">Professional Books</button>
      <button class="nav-btn" id="prefs-btn" type="button">Preferences</button>
    </nav>

    <main class="content">
      <!-- Login -->
      <section id="login-section" class="login-screen">
        <form class="login-form" id="login-form" novalidate>
          <h2>Welcome to the Book Club!</h2>
          <p style="margin-bottom:20px;color:#666">Enter your first name to access your personal reading lists</p>
          <div class="form-group">
            <label for="username-input" class="visually-hidden">First name</label>
            <input class="input" type="text" id="username-input" placeholder="Enter your first name" autocomplete="given-name" required style="text-align:center"/>
          </div>
          <button class="btn" type="submit">Join Book Club</button>
        </form>
      </section>

      <!-- App -->
      <section id="main-app" style="display:none">
        <!-- Feed -->
        <section id="feed" class="section active" aria-label="Book Feed">
          <div class="activity" id="activity">
            <h3>Activity</h3>
            <div id="activity-list"></div>
          </div>

          <div class="search-filter">
            <input type="text" class="input" placeholder="Search title, author, recommender…" id="search-input" aria-label="Search books"/>
            <select class="select" id="category-filter" aria-label="Category">
              <option value="">All Categories</option>
              <option value="professional">Professional</option>
              <option value="fiction">Fiction</option>
              <option value="non-fiction">Non-Fiction</option>
              <option value="biography">Biography</option>
              <option value="self-help">Self-Help</option>
              <option value="other">Other</option>
            </select>
            <select class="select" id="recommender-filter" aria-label="Recommended by">
              <option value="">All Recommenders</option>
            </select>
            <select class="select" id="min-rating" aria-label="Minimum rating">
              <option value="0">Min Rating (Any)</option>
              <option value="5">5★</option>
              <option value="4">4★+</option>
              <option value="3">3★+</option>
            </select>
            <select class="select" id="sort-by" aria-label="Sort">
              <option value="new">Newest</option>
              <option value="likes">Most Likes</option>
              <option value="rating">Rating (High → Low)</option>
              <option value="title">Title (A → Z)</option>
            </select>
            <span class="chip" id="result-count"></span>
          </div>

          <div id="books-feed" class="book-feed"></div>
        </section>

        <!-- Add Book -->
        <section id="add" class="section" aria-label="Add Book">
          <div class="add-book-form">
            <h2 style="margin-bottom:10px;color:#333">Share a Book Recommendation</h2>

            <div class="form-row">
              <div class="form-group dropdown" style="flex:2 1 380px">
                <label for="book-search">Search books to auto-fill (Open Library)</label>
                <input id="book-search" class="input" type="text" placeholder="Start typing a title or author…"/>
                <div id="book-results" class="results" style="display:none"></div>
              </div>
            </div>

            <form id="book-form" novalidate>
              <div class="form-row">
                <div class="form-group">
                  <label for="title">Book Title</label>
                  <input class="input" type="text" id="title" required/>
                </div>
                <div class="form-group">
                  <label for="author">Author</label>
                  <input class="input" type="text" id="author" required/>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="genre">Category</label>
                  <select class="select" id="genre">
                    <option value="fiction">Fiction</option>
                    <option value="non-fiction">Non-Fiction</option>
                    <option value="biography">Biography</option>
                    <option value="self-help">Self-Help</option>
                    <option value="other">Other</option>
                    <option value="professional">Professional</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="recommender">Your Name</label>
                  <input class="input" type="text" id="recommender" required/>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="book-image">Book Cover Image (optional)</label>
                  <input class="input" type="url" id="book-image" placeholder="https://example.com/book-cover.jpg"/>
                </div>
              </div>

              <div class="form-group">
                <label for="description">Why you recommend it</label>
                <textarea class="textarea" id="description" required placeholder="Tell your colleagues why they should read this book..."></textarea>
              </div>

              <div class="form-group" aria-label="Your Rating">
                <label>Your Rating</label>
                <div class="stars" id="rating-stars" role="radiogroup" aria-label="Rating from 1 to 5">
                  <button class="star" type="button" data-rating="1" aria-pressed="false" aria-label="1 star">★</button>
                  <button class="star" type="button" data-rating="2" aria-pressed="false" aria-label="2 stars">★</button>
                  <button class="star" type="button" data-rating="3" aria-pressed="false" aria-label="3 stars">★</button>
                  <button class="star" type="button" data-rating="4" aria-pressed="false" aria-label="4 stars">★</button>
                  <button class="star" type="button" data-rating="5" aria-pressed="true"  aria-label="5 stars">★</button>
                </div>
              </div>

              <button type="submit" class="btn">Share Book</button>
            </form>
          </div>
        </section>

        <!-- My Lists -->
        <section id="my-books" class="section" aria-label="My Reading Lists">
          <h2 style="margin-bottom:12px;color:#333">My Reading Lists</h2>

          <div class="reading-list">
            <h3>Currently Reading</h3>
            <div id="current-reading"></div>
          </div>

          <div class="reading-list">
            <h3>Want to Read</h3>
            <div id="wish-list"></div>
          </div>

          <div class="reading-list">
            <h3>Previously Read</h3>
            <div style="margin-bottom:10px">
              <details>
                <summary style="cursor:pointer;color:#6b8e5a;margin-bottom:8px">+ Add a previously read book (no channel post unless 5★)</summary>
                <div class="form-row" style="margin-top:10px">
                  <div class="form-group"><label for="prev-title">Title</label><input id="prev-title" class="input" type="text" /></div>
                  <div class="form-group"><label for="prev-author">Author</label><input id="prev-author" class="input" type="text" /></div>
                  <div class="form-group">
                    <label>Rating</label>
                    <div class="stars" id="prev-stars">
                      <button class="star" data-rating="1" type="button">★</button>
                      <button class="star" data-rating="2" type="button">★</button>
                      <button class="star" data-rating="3" type="button">★</button>
                      <button class="star" data-rating="4" type="button">★</button>
                      <button class="star" data-rating="5" type="button">★</button>
                    </div>
                  </div>
                </div>
                <button id="prev-add" class="btn btn-small" type="button">Add to Previously Read</button>
              </details>
            </div>
            <div id="read-list"></div>
          </div>
        </section>

        <!-- Professional -->
        <section id="professional" class="section" aria-label="Professional Development Books">
          <h2 style="margin-bottom:10px;color:#333">Professional Development Books</h2>
          <p style="margin-bottom:18px;color:#666">Books relevant to probation work, criminal justice, and professional growth</p>
          <div id="professional-books" class="book-feed"></div>
        </section>

        <!-- Preferences -->
        <section id="prefs" class="section" aria-label="Preferences">
          <h2 style="margin-bottom:12px;color:#333">Preferences</h2>
          <div class="reading-list">
            <h3>Microsoft Teams</h3>
            <p style="color:#666;margin-bottom:8px">Paste your channel’s <em>Incoming Webhook</em> URL. New shares + finished books will post here. Adding to <em>Previously Read</em> only posts if 5★.</p>
            <div class="form-row">
              <div class="form-group" style="flex:2 1 480px">
                <label for="pref-teams-webhook">Teams Incoming Webhook URL</label>
                <input id="pref-teams-webhook" class="input" type="url" placeholder="https://outlook.office.com/webhook/..."/>
              </div>
              <div class="form-group" style="align-self:flex-end">
                <label style="display:flex;align-items:center;gap:8px">
                  <input id="pref-teams-on" type="checkbox"/> Post to Teams on new activity
                </label>
              </div>
            </div>
            <button id="prefs-save" class="btn" type="button">Save Preferences</button>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Finish rating modal -->
  <div id="finish-modal" class="modal" aria-hidden="true">
    <div class="card">
      <h3 style="margin-bottom:8px">Rate this book</h3>
      <p id="finish-title" style="color:#666;margin-bottom:8px"></p>
      <div class="stars" id="finish-stars" style="margin:8px 0 4px">
        <button class="star" data-rating="1" type="button">★</button>
        <button class="star" data-rating="2" type="button">★</button>
        <button class="star" data-rating="3" type="button">★</button>
        <button class="star" data-rating="4" type="button">★</button>
        <button class="star" data-rating="5" type="button">★</button>
      </div>
      <div class="actions">
        <button class="btn" id="finish-save" type="button">Save</button>
        <button class="btn btn-danger" id="finish-cancel" type="button">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ======= Storage & State ======= */
const LS={books:'bookclub_books',users:'bookclub_userData',current:'bookclub_currentUser',activity:'bookclub_activity'};
let currentUser=''; let books=[]; let userData={}; let activity=[]; let currentBooks=[]; let currentRating=5;
const commentRatings=new Map(); let finishContext=null; let prevRating=5;

/* ======= Helpers ======= */
const $=(s,root=document)=>root.querySelector(s);
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const now=()=>new Date().toISOString();
const timeAgo=(iso)=>{const d=new Date(iso);const s=(Date.now()-d)/1000;if(s<60)return`${Math.floor(s)}s ago`;const m=s/60;if(m<60)return`${Math.floor(m)}m ago`;const h=m/60;if(h<24)return`${Math.floor(h)}h ago`;return`${Math.floor(h/24)}d ago`};
const escapeHtml=(s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const escapeAttr=(s='')=>escapeHtml(s).replaceAll('"','&quot;');
const showToast=(msg)=>{const t=$('#toast');t.textContent=msg;t.classList.add('show');clearTimeout(showToast._t);showToast._t=setTimeout(()=>t.classList.remove('show'),1700);};
const save=()=>{localStorage.setItem(LS.books,JSON.stringify(books));localStorage.setItem(LS.users,JSON.stringify(userData));localStorage.setItem(LS.current,currentUser);localStorage.setItem(LS.activity,JSON.stringify(activity));};
const load=()=>{try{books=JSON.parse(localStorage.getItem(LS.books)||'[]')||[];userData=JSON.parse(localStorage.getItem(LS.users)||'{}')||{};currentUser=localStorage.getItem(LS.current)||'';activity=JSON.parse(localStorage.getItem(LS.activity)||'[]')||[];}catch{}};
const defaultPrefs=()=>({teamsWebhook:'',teamsOnNewPost:false});
const ensureUser=(name)=>{if(!userData[name]) userData[name]={readList:[],wishList:[],currentReading:[],prefs:defaultPrefs()}; if(!userData[name].prefs) userData[name].prefs=defaultPrefs();};
const me=()=> userData[currentUser] || {readList:[],wishList:[],currentReading:[],prefs:defaultPrefs()};
const myPrefs=()=> (userData[currentUser]?.prefs || defaultPrefs());
const requireUser=()=>{if(!currentUser){showToast('Please log in first.');return false;}return true;};
const formatStars=(n)=>'★'.repeat(n)+'☆'.repeat(5-n);
const debounce=(fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};

/* ======= Seed data (first run) ======= */
const seedBooks=()=>([
  {id:1,title:"The Body Keeps the Score",author:"Bessel van der Kolk",genre:"professional",recommender:"Dr. Sarah Johnson",description:"Essential reading for understanding trauma's impact on the brain and body. Directly applicable to our work with clients.",rating:5,image:"",postLikes:8,postLikedBy:["Mike","Jennifer","Tom","Lisa","David","Maria","Alex","Chris"],comments:[
    {id:101,commenter:"Mike Rodriguez",rating:5,text:"Changed how I approach trauma-informed supervision.",likes:3,likedBy:["Sarah","Jennifer","Tom"]},
    {id:102,commenter:"Jennifer Martinez",rating:4,text:"Dense but worth it. I refer back to chapters regularly.",likes:2,likedBy:["Mike","Sarah"]}
  ]},
  {id:2,title:"Just Mercy",author:"Bryan Stevenson",genre:"professional",recommender:"Chief Probation Officer Williams",description:"A powerful examination of justice and mercy in the criminal justice system.",rating:5,image:"",postLikes:12,postLikedBy:["Sarah","Mike","Jennifer","Tom","Lisa","David","Maria","Alex","Chris","Pat","Jordan","Sam"],comments:[
    {id:201,commenter:"Lisa Chen",rating:5,text:"Should be required reading for everyone in criminal justice.",likes:7,likedBy:["Sarah","Mike","Jennifer","Tom","David","Maria","Alex"]}
  ]},
  {id:3,title:"Where the Crawdads Sing",author:"Delia Owens",genre:"fiction",recommender:"Jennifer Martinez",description:"Beautiful writing and a compelling mystery—great fiction pick!",rating:4,image:"",postLikes:6,postLikedBy:["Sarah","Mike","Tom","Lisa","Maria","Alex"],comments:[
    {id:301,commenter:"Tom Wilson",rating:4,text:"Loved the setting. The mystery kept me guessing.",likes:2,likedBy:["Jennifer","Sarah"]}
  ]}
]);

/* ======= Activity ======= */
const postActivity=(type,payload)=>{activity.unshift({id:Date.now(),type,payload,at:now()});if(activity.length>200)activity.length=200;save();renderActivity();};
const activityIcon=(type)=> type==='share'?'📣':(type==='finish-5'?'🏆':'🏁');
const renderActivity=()=>{
  const list=$('#activity-list');
  if(!activity.length){list.innerHTML='<div class="activity-item"><div class="activity-badge">👋</div><div>Welcome! Share a book to kick off the activity feed.</div></div>';return;}
  list.innerHTML=activity.slice(0,10).map(a=>{
    const {type,payload,at}=a;
    const text = type==='share'
      ? `<strong>${escapeHtml(payload.user)}</strong> shared <em>${escapeHtml(payload.title)}</em> by ${escapeHtml(payload.author)} (${payload.rating}★).`
      : `<strong>${escapeHtml(payload.user)}</strong> finished <em>${escapeHtml(payload.title)}</em> and rated it ${payload.rating}★.`;
    return `<div class="activity-item"><div class="activity-badge">${activityIcon(type)}</div><div><div>${text}</div><div class="activity-meta">${timeAgo(at)}</div></div></div>`;
  }).join('');
};

/* ======= UI rendering ======= */
const bookCoverBlock=(book)=> book.image
  ? `<img class="book-cover" loading="lazy" alt="Cover of ${escapeHtml(book.title)}" src="${escapeAttr(book.image)}"/>`
  : `<div class="book-cover-placeholder" aria-hidden="true">No Cover</div>`;

const bookCard=(book)=>{
  const liked=currentUser && book.postLikedBy.includes(currentUser);
  return `
  <article class="book-post" data-id="${book.id}">
    <div class="post-header">
      ${bookCoverBlock(book)}
      <div class="book-info">
        <div class="book-genre">${escapeHtml(book.genre)}</div>
        <h3 class="book-title">${escapeHtml(book.title)}</h3>
        <div class="book-author">by ${escapeHtml(book.author)}</div>
        <div class="book-recommender">Recommended by ${escapeHtml(book.recommender)}</div>
        <div class="book-rating"><div class="stars">${formatStars(book.rating)}</div><span>(${book.rating}/5)</span></div>
      </div>
    </div>
    <p class="book-description">${escapeHtml(book.description)}</p>
    <div class="post-actions">
      <button class="action-btn ${liked?'active':''}" type="button" data-action="like" data-id="${book.id}">👍 <span data-like-count>${book.postLikes}</span> Likes</button>
      <button class="action-btn" type="button" data-action="wish" data-id="${book.id}">📚 Want to Read</button>
      <button class="action-btn" type="button" data-action="reading" data-id="${book.id}">📖 Currently Reading</button>
      <button class="action-btn" type="button" data-action="read" data-id="${book.id}">✅ Mark as Read</button>
    </div>
    <div class="comments-section">
      <strong>Comments (${book.comments.length}):</strong>
      ${book.comments.map(c=>`
        <div class="comment" data-comment-id="${c.id}">
          <div class="comment-header">
            <span class="commenter-name">${escapeHtml(c.commenter)}</span>
            <span class="comment-rating">${formatStars(c.rating)}</span>
          </div>
          <div class="comment-text">${escapeHtml(c.text)}</div>
          <div class="comment-actions">
            <button class="like-comment-btn ${currentUser && c.likedBy.includes(currentUser)?'liked':''}" type="button" data-action="like-comment" data-id="${book.id}" data-cid="${c.id}">👍 ${c.likes}</button>
          </div>
        </div>`).join('')}
      <div class="add-comment">
        <div class="comment-form" data-id="${book.id}">
          <div class="comment-input-row">
            <input type="text" placeholder="Your name" class="comment-input" data-field="name" value="${escapeAttr(currentUser)}"/>
            <div class="stars comment-stars" data-role="comment-stars" data-id="${book.id}">
              ${[1,2,3,4,5].map(n=>`<button class="star ${n<= (commentRatings.get(book.id)||5)?'filled':''}" type="button" data-action="comment-rating" data-id="${book.id}" data-rating="${n}" aria-label="${n} star">★</button>`).join('')}
            </div>
          </div>
          <textarea placeholder="Write your comment..." class="comment-textarea" data-field="text"></textarea>
          <button class="btn btn-small" type="button" data-action="add-comment" data-id="${book.id}">Add Comment</button>
        </div>
      </div>
    </div>
  </article>`;
};

const renderBooks=()=>{
  const c=$('#books-feed');
  if(!currentBooks.length){c.innerHTML=`<div class="empty-state"><h3>No books found</h3><p>Try adjusting search/filters or add a new recommendation!</p></div>`;$('#result-count').textContent='0 results';return;}
  c.innerHTML=currentBooks.map(bookCard).join('');
  currentBooks.forEach(b=>commentRatings.set(b.id,5));
  $('#result-count').textContent=`${currentBooks.length} result${currentBooks.length===1?'':'s'}`;
};

const renderProfessionalBooks=()=>{
  const list=books.filter(b=>b.genre==='professional');
  const c=$('#professional-books');
  if(!list.length){c.innerHTML=`<div class="empty-state"><h3>No professional books yet</h3><p>Be the first to recommend one!</p></div>`;return;}
  c.innerHTML=list.map(bookCard).join('');
  list.forEach(b=>commentRatings.set(b.id,5));
};

const renderMyLists=()=>{
  const data=me();
  const make=(arr,actions)=> arr.length?arr.map(b=>`
    <div class="list-item" data-id="${b.id}">
      <div><strong>${escapeHtml(b.title)}</strong> by ${escapeHtml(b.author)}</div>
      <div>${actions(b)}</div>
    </div>`).join(''):`<p style="color:#999;font-style:italic">Nothing here yet</p>`;
  $('#current-reading').innerHTML=make(data.currentReading,(b)=>`
    <button class="btn btn-small" type="button" data-action="read" data-id="${b.id}">Mark as Read</button>
    <button class="btn btn-small btn-danger" type="button" data-action="remove-current" data-id="${b.id}">Remove</button>`);
  $('#wish-list').innerHTML=make(data.wishList,(b)=>`
    <button class="btn btn-small" type="button" data-action="reading" data-id="${b.id}">Start Reading</button>
    <button class="btn btn-small btn-danger" type="button" data-action="remove-wish" data-id="${b.id}">Remove</button>`);
  $('#read-list').innerHTML=make(data.readList,(b)=>`
    <span class="chip">${(b._rating||b.rating||0)}★</span>
    <button class="btn btn-small btn-danger" type="button" data-action="remove-read" data-id="${b.id}">Remove</button>`);
};

/* ======= Stats / Filters ======= */
const updateStats=()=>{
  const totalBooks=books.length;
  const totalComments=books.reduce((s,b)=>s+(b.comments?.length||0),0);
  const avg=totalBooks?(books.reduce((s,b)=>s+(b.rating||0),0)/totalBooks):0;
  const readCount=me().readList.length;
  $('#total-books').textContent=String(totalBooks);
  $('#total-reviews').textContent=String(totalComments);
  $('#avg-rating').textContent=avg.toFixed(1);
  $('#books-read').textContent=String(readCount);
};
const getUniqueRecommenders=()=> Array.from(new Set(books.map(b=>b.recommender).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
const populateRecommenderFilter=()=>{
  const sel=$('#recommender-filter'); const cur=sel.value;
  sel.innerHTML=['<option value="">All Recommenders</option>'].concat(getUniqueRecommenders().map(n=>`<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`)).join('');
  if(cur && getUniqueRecommenders().includes(cur)) sel.value=cur;
};
const applyFilters=()=>{
  const term=$('#search-input').value.trim().toLowerCase();
  const cat=$('#category-filter').value;
  const who=$('#recommender-filter').value;
  const min=parseInt($('#min-rating').value,10)||0;
  const sort=$('#sort-by').value;
  currentBooks=books.filter(b=>{
    const inSearch=!term||[b.title,b.author,b.recommender].some(x=>x.toLowerCase().includes(term));
    const inCat=!cat||b.genre===cat;
    const byWho=!who||b.recommender===who;
    const inRating=(b.rating||0)>=min;
    return inSearch&&inCat&&byWho&&inRating;
  });
  if(sort==='new') currentBooks.sort((a,b)=>b.id-a.id);
  else if(sort==='likes') currentBooks.sort((a,b)=>(b.postLikes||0)-(a.postLikes||0));
  else if(sort==='rating') currentBooks.sort((a,b)=>(b.rating||0)-(a.rating||0));
  else if(sort==='title') currentBooks.sort((a,b)=>a.title.localeCompare(b.title));
  renderBooks();
};

/* ======= Teams Webhook ======= */
const postToTeams=async(summary,title,text)=>{
  const p=myPrefs(); if(!p.teamsOnNewPost||!p.teamsWebhook) return;
  const card={'@type':'MessageCard','@context':'http://schema.org/extensions','summary':summary,'themeColor':'5B8A3C','title':title,'sections':[{'text':text}],
    'potentialAction':[{'@type':'OpenUri','name':'Open Book Club','targets':[{'os':'default','uri':window.location.href}]}]};
  try{await fetch(p.teamsWebhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(card)});}catch(e){console.error('Teams webhook failed',e);}
};

/* ======= CRUD ======= */
const addBook=(payload)=>{
  const book={id:Date.now(),title:payload.title,author:payload.author,genre:payload.genre,recommender:payload.recommender,description:payload.description,rating:payload.rating,image:payload.image||"",postLikes:0,postLikedBy:[],comments:[]};
  books.unshift(book); save(); updateStats(); populateRecommenderFilter(); applyFilters();
  postActivity('share',{user:currentUser||payload.recommender,title:book.title,author:book.author,rating:book.rating});
  postToTeams(`New book: ${book.title}`,`📚 New recommendation: ${book.title} (${book.rating}★)`,`**Author:** ${book.author}<br/>**Recommended by:** ${book.recommender}<br/><br/>${escapeHtml(book.description)}`);
  showToast('Book shared!');
};
const togglePostLike=(id)=>{if(!requireUser())return;const b=books.find(x=>x.id===id);if(!b)return;const i=b.postLikedBy.indexOf(currentUser); if(i>=0){b.postLikedBy.splice(i,1);b.postLikes=Math.max(0,b.postLikes-1);}else{b.postLikedBy.push(currentUser);b.postLikes+=1;} save();applyFilters();};
const toggleCommentLike=(id,cid)=>{if(!requireUser())return;const b=books.find(x=>x.id===id);if(!b)return;const c=b.comments.find(x=>x.id===cid);if(!c)return;const i=c.likedBy.indexOf(currentUser); if(i>=0){c.likedBy.splice(i,1);c.likes=Math.max(0,c.likes-1);}else{c.likedBy.push(currentUser);c.likes+=1;} save();applyFilters();};
const addComment=(id,name,text,rating)=>{if(!requireUser())return;const b=books.find(x=>x.id===id);if(!b)return;if(!name||!text){showToast('Enter your name and comment');return;} b.comments.push({id:Date.now(),commenter:name.trim(),rating:rating||5,text:text.trim(),likes:0,likedBy:[]}); save();updateStats();applyFilters();showToast('Comment added!');};
const addToWishList=(id)=>{if(!requireUser())return;const b=books.find(x=>x.id===id);const d=me();if(!d.wishList.find(i=>i.id===id)){d.wishList.push(b);save();showToast(`"${b.title}" added to Wish List`);}else showToast('Already in Wish List');};
const addToCurrentReading=(id)=>{if(!requireUser())return;const b=books.find(x=>x.id===id);const d=me();if(!d.currentReading.find(i=>i.id===id)){d.currentReading.push(b);d.wishList=d.wishList.filter(i=>i.id!==id);save();renderMyLists();showToast(`"${b.title}" added to Currently Reading`);}else showToast('Already in Currently Reading');};

/* Finish flow (posts to Teams always) */
const openFinishModal=(book)=>{finishContext={bookId:book.id,rating:5};$('#finish-title').textContent=`${book.title} — ${book.author}`; $$('#finish-stars .star').forEach(s=>s.classList.toggle('filled',parseInt(s.dataset.rating,10)<=5)); $('#finish-modal').style.display='flex';$('#finish-modal').setAttribute('aria-hidden','false');};
const closeFinishModal=()=>{$('#finish-modal').style.display='none';$('#finish-modal').setAttribute('aria-hidden','true');finishContext=null;};
const markAsReadFlow=(id)=>{if(!requireUser())return;const b=books.find(x=>x.id===id);if(!b)return;openFinishModal(b);};
const completeMarkAsRead=()=>{if(!finishContext)return;const {bookId,rating}=finishContext;const d=me();const b=books.find(x=>x.id===bookId);
  if(!d.readList.find(i=>i.id===bookId)){d.readList.push({...b,_rating:rating}); d.wishList=d.wishList.filter(i=>i.id!==bookId); d.currentReading=d.currentReading.filter(i=>i.id!==bookId); save(); updateStats(); renderMyLists();
    postActivity(rating===5?'finish-5':'finish',{user:currentUser,title:b.title,rating});
    postToTeams(`Finished: ${b.title}`,`🏁 Finished: ${b.title} (${rating}★)`,`**Reader:** ${currentUser}<br/>**Author:** ${b.author}`); showToast(`Marked "${b.title}" as read (${rating}★)`);} else showToast('Already marked as read');
  closeFinishModal();
};
/* Remove from lists */
const removeFromList=(list,id)=>{if(!requireUser())return;const d=me();d[list]=d[list].filter(i=>i.id!==id);save();if(list==='readList')updateStats();renderMyLists();};

/* Export */
const exportAllData=()=>{const payload={exportedAt:now(),currentUser,books,userData,activity};const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');a.href=url;a.download=`bookclub_export_${ts}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);showToast('Data exported as JSON');};

/* ======= Open Library + Google Books lookup ======= */
const openLibrarySearch=async(q)=>{const url=`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&limit=10&fields=key,title,author_name,cover_i`;const res=await fetch(url);if(!res.ok)return[];const data=await res.json();return (data.docs||[]).map(d=>{const workKey=d.key;const cover=d.cover_i?`https://covers.openlibrary.org/b/id/${d.cover_i}-M.jpg`:'';return {workKey,title:d.title||'',author:(d.author_name&&d.author_name[0])||'',cover};});};
const fetchOpenLibraryDescription=async(workKey)=>{if(!workKey)return'';const key=workKey.startsWith('/works/')?workKey:`/works/${workKey}`;const res=await fetch(`https://openlibrary.org${key}.json`);if(!res.ok)return'';const data=await res.json();const desc=data.description;return typeof desc==='string'?desc:(desc&&desc.value)||'';};
const googleBooksLookup=async(title,author)=>{const q=`intitle:${title} inauthor:${author}`;const url=`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=1&printType=books&projection=lite&fields=items(volumeInfo/title,volumeInfo/authors,volumeInfo/description,volumeInfo/imageLinks/thumbnail)`;const res=await fetch(url);if(!res.ok)return{};const json=await res.json();const item=json.items&&json.items[0];if(!item)return{};const vi=item.volumeInfo||{};return {description:vi.description||'',cover:(vi.imageLinks&&vi.imageLinks.thumbnail)||''};};
const getBestMetadata=async(title,author,workKey,existingCover)=>{let description=await fetchOpenLibraryDescription(workKey);let cover=existingCover; if(!description||!cover){const gb=await googleBooksLookup(title,author); if(!description)description=gb.description||''; if(!cover)cover=gb.cover||'';} return {cover,description};};
const showResults=(items)=>{const box=$('#book-results');if(!items.length){box.style.display='none';box.innerHTML='';return;} box.style.display='block'; box.innerHTML=items.map(it=>`
  <div class="result-item" data-title="${escapeAttr(it.title)}" data-author="${escapeAttr(it.author)}" data-cover="${escapeAttr(it.cover)}" data-workkey="${escapeAttr(it.workKey||'')}">
    <img class="result-cover" src="${escapeAttr(it.cover)||''}" alt="" onerror="this.style.visibility='hidden'"/>
    <div><div><strong>${escapeHtml(it.title)}</strong></div><div style="color:#666;font-size:.9rem">${escapeHtml(it.author)}</div></div>
  </div>`).join('');};

/* ======= Auth / Nav ======= */
const login=(name)=>{currentUser=name.trim();if(!currentUser){showToast('Enter your first name');return;}ensureUser(currentUser);$('#login-section').style.display='none';$('#main-app').style.display='block';$('#user-info').style.display='flex';$('#current-user-name').textContent=currentUser;$('#recommender').value=currentUser;save();updateStats();populateRecommenderFilter();applyFilters();renderMyLists();};
const logout=()=>{currentUser='';save();$('#login-section').style.display='block';$('#main-app').style.display='none';$('#user-info').style.display='none';$('#username-input').value='';};
const showSection=(id,btn)=>{$$('.section').forEach(s=>s.classList.remove('active'));$$('.nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active');btn.classList.add('active');if(id==='my-books')renderMyLists();if(id==='professional')renderProfessionalBooks();};
const updateFormStarDisplay=()=>{$$('#rating-stars .star').forEach((b,i)=>{const filled=i<currentRating;b.classList.toggle('filled',filled);b.setAttribute('aria-pressed',String(filled&&i===currentRating-1));});};

/* ======= Init ======= */
document.addEventListener('DOMContentLoaded',()=>{
  if(!localStorage.getItem(LS.books)){books=seedBooks();}
  load(); if(!Array.isArray(books)||!books.length){books=seedBooks();}
  currentBooks=books.slice();
  if(currentUser){$('#login-section').style.display='none';$('#main-app').style.display='block';$('#user-info').style.display='flex';$('#current-user-name').textContent=currentUser;$('#recommender').value=currentUser;}
  updateStats();renderActivity();populateRecommenderFilter();applyFilters();updateFormStarDisplay();

  /* Listeners */
  $('#login-form').addEventListener('submit',e=>{e.preventDefault();login($('#username-input').value);});
  $('#logout-btn').addEventListener('click',logout);
  $('#export-btn').addEventListener('click',exportAllData);
  $('#feed-btn').addEventListener('click',e=>showSection('feed',e.currentTarget));
  $('#add-btn').addEventListener('click',e=>showSection('add',e.currentTarget));
  $('#my-books-btn').addEventListener('click',e=>{if(!requireUser())return;showSection('my-books',e.currentTarget);});
  $('#professional-btn').addEventListener('click',e=>showSection('professional',e.currentTarget));
  $('#prefs-btn').addEventListener('click',e=>{showSection('prefs',e.currentTarget); const p=myPrefs(); $('#pref-teams-webhook').value=p.teamsWebhook||''; $('#pref-teams-on').checked=!!p.teamsOnNewPost;});
  $('#prefs-save').addEventListener('click',()=>{if(!requireUser())return; const p=myPrefs(); p.teamsWebhook=$('#pref-teams-webhook').value.trim(); p.teamsOnNewPost=$('#pref-teams-on').checked; save(); showToast('Preferences saved');});

  $('#search-input').addEventListener('input',debounce(applyFilters,250));
  $('#category-filter').addEventListener('change',applyFilters);
  $('#recommender-filter').addEventListener('change',applyFilters);
  $('#min-rating').addEventListener('change',applyFilters);
  $('#sort-by').addEventListener('change',applyFilters);

  $('#rating-stars').addEventListener('click',e=>{const btn=e.target.closest('.star');if(!btn)return;currentRating=parseInt(btn.dataset.rating,10);updateFormStarDisplay();});
  $('#book-form').addEventListener('submit',e=>{
    e.preventDefault(); if(!requireUser())return;
    const payload={title:$('#title').value.trim(),author:$('#author').value.trim(),genre:$('#genre').value,recommender:($('#recommender').value.trim()||currentUser),description:$('#description').value.trim(),image:$('#book-image').value.trim(),rating:currentRating};
    if(!payload.title||!payload.author||!payload.recommender||!payload.description){showToast('Please fill in all required fields.');return;}
    addBook(payload); e.target.reset(); currentRating=5; updateFormStarDisplay(); $('#recommender').value=currentUser;
  });

  /* Feed actions */
  const handleFeed=(e)=>{
    const btn=e.target.closest('[data-action]'); if(!btn)return;
    const action=btn.dataset.action; const id=parseInt(btn.dataset.id,10);
    if(action==='like')return togglePostLike(id);
    if(action==='wish')return addToWishList(id);
    if(action==='reading')return addToCurrentReading(id);
    if(action==='read')return markAsReadFlow(id);
    if(action==='like-comment'){const cid=parseInt(btn.dataset.cid,10);return toggleCommentLike(id,cid);}
    if(action==='add-comment'){const form=btn.closest('.comment-form');const name=$('[data-field="name"]',form).value||currentUser;const text=$('[data-field="text"]',form).value;const rating=commentRatings.get(id)||5; addComment(id,name,text,rating); $('[data-field="text"]',form).value='';}
    if(action==='comment-rating'){const r=parseInt(btn.dataset.rating,10);const bookId=parseInt(btn.dataset.id,10);commentRatings.set(bookId,r);const group=btn.closest('[data-role="comment-stars"]'); $$('.star',group).forEach(s=>s.classList.toggle('filled',parseInt(s.dataset.rating,10)<=r));}
  };
  $('#books-feed').addEventListener('click',handleFeed);
  $('#professional-books').addEventListener('click',handleFeed);
  $('#my-books').addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-action]'); if(!btn)return;
    const id=parseInt(btn.dataset.id,10); const action=btn.dataset.action;
    if(action==='reading')addToCurrentReading(id);
    else if(action==='read')markAsReadFlow(id);
    else if(action==='remove-current')removeFromList('currentReading',id);
    else if(action==='remove-wish')removeFromList('wishList',id);
    else if(action==='remove-read')removeFromList('readList',id);
  });

  /* Previously Read mini-stars */
  const setPrevStars=(r)=>{$$('#prev-stars .star').forEach(s=>s.classList.toggle('filled',parseInt(s.dataset.rating,10)<=r));}; setPrevStars(prevRating);
  $('#prev-stars').addEventListener('click',e=>{const b=e.target.closest('.star');if(!b)return;prevRating=parseInt(b.dataset.rating,10);setPrevStars(prevRating);});
  $('#prev-add').addEventListener('click',()=>{
    if(!requireUser())return;
    const title=$('#prev-title').value.trim(); const author=$('#prev-author').value.trim(); const rating=prevRating||5;
    if(!title||!author){showToast('Enter title and author');return;}
    me().readList.push({id:Date.now(),title,author,_rating:rating}); save(); updateStats(); renderMyLists(); showToast('Added to Previously Read');
    if(rating===5){ postToTeams(`5★ Previously Read: ${title}`,`🏆 5★ Previously Read: ${title}`,`**Reader:** ${currentUser}<br/>**Author:** ${author}`); }
    $('#prev-title').value=''; $('#prev-author').value=''; prevRating=5; setPrevStars(prevRating);
  });

  /* Finish modal */
  $('#finish-stars').addEventListener('click',e=>{const b=e.target.closest('.star');if(!b)return;const r=parseInt(b.dataset.rating,10);finishContext={...(finishContext||{}),rating:r}; $$('#finish-stars .star').forEach(s=>s.classList.toggle('filled',parseInt(s.dataset.rating,10)<=r));});
  $('#finish-save').addEventListener('click',completeMarkAsRead);
  $('#finish-cancel').addEventListener('click',()=>{closeFinishModal();});
  $('#finish-modal').addEventListener('click',e=>{if(e.target.id==='finish-modal')closeFinishModal();});

  /* Open Library search */
  const runSearch=debounce(async()=>{const q=$('#book-search').value.trim(); if(q.length<3){$('#book-results').style.display='none';return;} try{const results=await openLibrarySearch(q); showResults(results);}catch{ $('#book-results').style.display='none'; }},350);
  $('#book-search').addEventListener('input',runSearch);
  $('#book-results').addEventListener('click',async(e)=>{
    const item=e.target.closest('.result-item'); if(!item)return;
    const title=item.dataset.title||''; const author=item.dataset.author||''; const cover=item.dataset.cover||''; const workKey=item.dataset.workkey||'';
    $('#title').value=title; $('#author').value=author; if(cover)$('#book-image').value=cover; $('#book-results').style.display='none';
    try{const meta=await getBestMetadata(title,author,workKey,cover); if(meta.description&&!$('#description').value)$('#description').value=meta.description; if(meta.cover&&!$('#book-image').value)$('#book-image').value=meta.cover;}catch(e){console.warn('Metadata fetch failed',e);}
  });
  document.addEventListener('click',(e)=>{const box=$('#book-results'); if(box.style.display!=='none' && !box.contains(e.target) && e.target!==$('#book-search')) box.style.display='none';});
});
</script>
</body>
</html>