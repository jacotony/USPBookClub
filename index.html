<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Club</title>
<style>
  :root{
    --pine:#2f4a3e; --spruce:#3e5a4c; --sage:#8ca093; --silver:#c2c7c9;
    --mist:#efe6db; --accent:#d59a63; --ink:#2a2f2d; --muted:#5f6b64;
    --line:#dfe5e1; --gold:#b8860b; --glass:rgba(255,255,255,.18);
    --glass-2:rgba(255,255,255,.28); --shadow:0 20px 40px rgba(0,0,0,.10)
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;background:linear-gradient(135deg,var(--spruce) 0%,var(--pine) 45%,var(--sage) 100%);min-height:100vh;padding:20px;color:var(--ink)}
  .container{max-width:1200px;margin:0 auto}
  .header{color:#fff;text-align:center;margin-bottom:30px}
  .header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
  .header p{opacity:.95;font-size:1.1rem}

  .user-info{display:none;justify-content:space-between;align-items:center;background:var(--glass);padding:10px 20px;border-radius:20px;color:#fff;margin-bottom:20px;backdrop-filter:blur(12px);border:1px solid var(--glass-2)}
  .toolbar{display:flex;gap:8px}
  .pill-btn{background:none;border:1px solid #fff;color:#fff;padding:6px 14px;border-radius:14px;cursor:pointer;font-size:12px}
  .pill-btn:hover{background:rgba(255,255,255,.18)}

  .stats-bar{display:flex;justify-content:center;gap:30px;margin-bottom:30px;flex-wrap:wrap}
  .stat-card{background:var(--glass);padding:14px 22px;border-radius:20px;color:#fff;text-align:center;border:1px solid var(--glass-2);backdrop-filter:blur(15px);transition:.25s}
  .stat-card:hover{transform:translateY(-5px);background:rgba(255,255,255,.3)}
  .stat-number{font-size:2rem;font-weight:700;display:block}
  .stat-label{font-size:.9rem;opacity:.9}

  .nav{display:flex;gap:10px;justify-content:center;margin-bottom:30px;flex-wrap:wrap}
  .nav-btn{background:var(--glass);color:#fff;border:2px solid var(--glass-2);padding:12px 24px;border-radius:25px;cursor:pointer;transition:.2s;backdrop-filter:blur(10px)}
  .nav-btn:hover,.nav-btn.active{background:rgba(255,255,255,.34);transform:translateY(-2px)}

  .content{background:rgba(255,255,255,.97);border-radius:20px;padding:30px;box-shadow:var(--shadow)}
  .login-screen{text-align:center;padding:60px 20px}
  .login-form{background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:420px;margin:0 auto}
  .login-form h2{color:var(--spruce);margin-bottom:10px}

  .section{display:none}.section.active{display:block}

  .add-book-form{background:linear-gradient(135deg,var(--mist) 0%,#e9e1d2 100%);padding:24px;border-radius:15px;margin-bottom:30px;border-left:4px solid var(--pine)}
  .form-row{display:flex;gap:12px;flex-wrap:wrap}
  .form-group{flex:1 1 250px;margin-bottom:14px}
  .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--ink)}
  .input,.select,.textarea{width:100%;padding:12px;border:2px solid var(--line);border-radius:8px;font-size:16px;transition:.2s border-color}
  .textarea{resize:vertical;min-height:100px}
  .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--pine)}
  .btn{background:linear-gradient(135deg,var(--pine) 0%,var(--spruce) 100%);color:#fff;border:none;padding:12px 22px;border-radius:25px;cursor:pointer;font-size:16px;font-weight:600;transition:.2s}
  .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(47,74,62,.35)}
  .btn-small{padding:6px 12px;font-size:12px;margin:2px}
  .btn-danger{background:#b74a4a}

  .search-filter{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
  .chip{background:#e8efe9;border:1px solid #d9e4dc;color:#2e4a3a;padding:6px 10px;border-radius:999px;font-size:12px}

  .reading-list{background:#fff;border-radius:15px;padding:18px;margin-bottom:18px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
  .reading-list h3{color:#3e5a4c;margin-bottom:10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0}
  .list-item:last-child{border-bottom:none}

  .toast{position:fixed;bottom:24px;right:24px;background:#1d1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#b74a4a}
  .loading{opacity:.6;pointer-events:none}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid #ddd;border-radius:50%;border-top-color:#666;animation:spin .8s linear infinite;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}

  @media (max-width:768px){
    .header h1{font-size:2rem}
    .stats-bar{gap:15px}
    .stat-card{padding:10px 16px}
    .stat-number{font-size:1.5rem}
    .nav{gap:6px}
    .nav-btn{padding:8px 16px;font-size:14px}
    .content{padding:20px;margin:0 -10px}
    .form-row{flex-direction:column}
    .user-info{flex-direction:column;gap:10px;text-align:center}
    .toolbar{justify-content:center}
    .reading-list{padding:14px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Book Club</h1>
      <p>Find your next favorite book</p>
    </div>

    <div id="user-info" class="user-info">
      <span>Welcome, <strong id="current-user-name"></strong>!</span>
      <div class="toolbar">
        <button class="pill-btn" id="logout-btn" type="button">Switch User</button>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card"><span class="stat-number" id="total-books">0</span><span class="stat-label">Books</span></div>
      <div class="stat-card"><span class="stat-number" id="total-reviews">0</span><span class="stat-label">Comments</span></div>
      <div class="stat-card"><span class="stat-number" id="avg-rating">0.0</span><span class="stat-label">Avg Rating</span></div>
      <div class="stat-card"><span class="stat-number" id="books-read">0</span><span class="stat-label">Books Read</span></div>
      <div class="stat-card"><span class="stat-number" id="total-users">0</span><span class="stat-label">Users</span></div>
    </div>

    <div id="top-recommenders" class="reading-list" style="margin-bottom:20px">
      <h3>Top Recommenders</h3>
      <div id="recommenders-list"></div>
    </div>

    <nav class="nav">
      <button class="nav-btn active" id="feed-btn">Book Feed</button>
      <button class="nav-btn" id="add-btn">Add Book</button>
    </nav>

    <main class="content">
      <section id="login-section" class="login-screen">
        <form class="login-form" id="login-form">
          <h2>Welcome to Book Club!</h2>
          <p style="margin-bottom:15px;color:var(--muted)">Enter your first name to access your personal reading lists</p>
          <div class="form-group">
            <input class="input" type="text" id="username-input" placeholder="Enter your first name" required style="text-align:center"/>
          </div>
          <button class="btn" type="submit">Enter Book Club</button>
        </form>
      </section>

      <section id="main-app" style="display:none">
        <section id="feed" class="section active">
          <div id="books-feed" class="book-feed">
            <div style="text-align:center;padding:40px;color:var(--muted)">
              <h3>Welcome!</h3>
              <p>Add books to get started</p>
            </div>
          </div>
        </section>

        <section id="add" class="section">
          <div class="add-book-form">
            <h2 style="margin-bottom:20px;color:var(--ink)">Add Book</h2>
            <form id="book-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="title">Book Title *</label>
                  <input class="input" type="text" id="title" required/>
                </div>
                <div class="form-group">
                  <label for="author">Author *</label>
                  <input class="input" type="text" id="author" required/>
                </div>
              </div>
              <div class="form-group">
                <label for="reason">Why I recommend this book *</label>
                <textarea class="textarea" id="reason" placeholder="What did you love about it?" required></textarea>
              </div>
              <button type="submit" class="btn">Add Book</button>
            </form>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ========= JSONBin Storage & State ========= */
const JSONBIN_API = 'https://api.jsonbin.io/v3';
const BIN_ID = '68b1dc30ae596e708fdb3ff1';
const API_KEY = '$2a$10$LVh6eQns1sOKv23ek6kbD.7UJoIW.UclGVfzMvSeD2eSLfshtVOZi';

let currentUser = ''; 
let books = []; 
let userData = {};
let isLoading = false;

/* ========= Utilities ========= */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const now = () => new Date().toISOString();
const escapeHtml = (s='') => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

const showToast = (msg, isError=false) => {
  const t = $('#toast');
  t.textContent = msg;
  t.classList.toggle('error', isError);
  t.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => t.classList.remove('show'), isError ? 3000 : 1700);
};

async function loadAll() {
  if (isLoading) return; 
  isLoading = true;
  
  console.log('App initializing...');
  
  // Load from localStorage first
  try {
    const cached = JSON.parse(localStorage.getItem('bookclub_payload') || '{}');
    books = cached.books || [];
    userData = cached.userData || {};
    currentUser = localStorage.getItem('bookclub_currentUser') || '';
    console.log('Local cache loaded');
  } catch(e) {
    console.error('Failed to load local cache:', e);
  }

  // Then sync with JSONBin
  try {
    console.log('Attempting to load from JSONBin...');
    const response = await fetch(`${JSONBIN_API}/b/${BIN_ID}/latest`, {
      method: 'GET',
      headers: {
        'X-Master-Key': API_KEY,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('JSONBin error:', response.status, errorText);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    console.log('JSONBin response:', data);
    const record = data.record || {};
    
    books = record.books || [];
    userData = record.userData || {};
    
    // Cache locally
    localStorage.setItem('bookclub_payload', JSON.stringify({books, userData}));
    
    showToast('Data synced successfully!');
    
  } catch(e) {
    console.error('Failed to sync with JSONBin:', e);
    showToast(`Sync failed: ${e.message}`, true);
  }
  
  isLoading = false;
  updateStats();
}

async function saveAll() {
  // Save locally first
  try {
    const payload = {books, userData};
    localStorage.setItem('bookclub_payload', JSON.stringify(payload));
    localStorage.setItem('bookclub_currentUser', currentUser);
    console.log('Saved locally');
  } catch(e) {
    console.error('Failed to save locally:', e);
  }
  
  // Then sync to JSONBin
  try {
    console.log('Attempting to save to JSONBin...');
    const payload = {books, userData};
    
    const response = await fetch(`${JSONBIN_API}/b/${BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': API_KEY
      },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('JSONBin save error:', response.status, errorText);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    console.log('Data saved to JSONBin successfully');
    showToast('Data saved and synced!');
    
  } catch(e) {
    console.error('Failed to save to JSONBin:', e);
    showToast(`Save failed: ${e.message}`, true);
  }
}

function updateStats() {
  $('#total-books').textContent = String(books.length);
  $('#total-users').textContent = String(Object.keys(userData).length);
  
  const container = $('#recommenders-list');
  if (books.length === 0) {
    container.innerHTML = '<p style="color:#999;font-style:italic">No books shared yet</p>';
  } else {
    container.innerHTML = books.slice(0, 3).map(b => `
      <div class="list-item">
        <div><strong>${escapeHtml(b.title)}</strong> by ${escapeHtml(b.author)}</div>
      </div>
    `).join('');
  }
}

function showSection(id, btn) {
  $$('.section').forEach(s => s.classList.remove('active'));
  $$('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}

/* ========= Init & Event Bindings ========= */
async function init() {
  console.log('Starting initialization...');
  
  try {
    await loadAll();
    console.log('LoadAll completed successfully');
  } catch(e) {
    console.error('LoadAll failed:', e);
    showToast('Failed to initialize app', true);
  }

  if (currentUser) {
    $('#login-section').style.display = 'none';
    $('#main-app').style.display = 'block';
    $('#user-info').style.display = 'flex';
    $('#current-user-name').textContent = currentUser;
  }

  // Login form
  $('#login-form').addEventListener('submit', async e => {
    e.preventDefault();
    console.log('Login form submitted');
    const name = $('#username-input').value.trim();
    if (!name) {
      showToast('Please enter your name', true);
      return;
    }
    
    currentUser = name;
    if (!userData[name]) {
      userData[name] = {readList: [], wishList: [], currentReading: []};
    }
    
    await saveAll();
    
    $('#login-section').style.display = 'none';
    $('#main-app').style.display = 'block';
    $('#user-info').style.display = 'flex';
    $('#current-user-name').textContent = name;
    
    showToast(`Welcome, ${name}!`);
  });

  // Navigation
  $('#feed-btn').addEventListener('click', function() { showSection('feed', this); });
  $('#add-btn').addEventListener('click', function() { showSection('add', this); });

  // Logout
  $('#logout-btn').addEventListener('click', () => {
    currentUser = ''; 
    localStorage.removeItem('bookclub_currentUser');
    $('#login-section').style.display = 'block';
    $('#main-app').style.display = 'none';
    $('#user-info').style.display = 'none';
    $('#username-input').value = '';
  });

  // Book form
  $('#book-form').addEventListener('submit', async e => {
    e.preventDefault();
    console.log('Book form submitted');
    
    if (!currentUser) {
      showToast('Please log in first', true);
      return;
    }

    const title = $('#title').value.trim();
    const author = $('#author').value.trim();
    const reason = $('#reason').value.trim();

    if (!title || !author || !reason) {
      showToast('Please fill in all required fields', true);
      return;
    }

    const newBook = {
      id: Date.now(),
      title,
      author,
      reason,
      recommender: currentUser,
      addedAt: now()
    };

    books.unshift(newBook);
    await saveAll();
    updateStats();

    // Reset form
    e.target.reset();
    
    showSection('feed', $('#feed-btn'));
    showToast('Book added successfully!');
  });

  console.log('Initialization complete');
}

// Start the app
init().catch(e => {
  console.error('Failed to initialize app:', e);
  showToast('App failed to start - check console', true);
});
</script>
</body>
</html>
