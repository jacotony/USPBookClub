<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>US Probation Book Club</title>
  <style>
    :root{
      --green-1:#8fac7e;
      --green-2:#6b8e5a;
      --sand-1:#a0956b;
      --glass: rgba(255,255,255,.2);
      --glass-2: rgba(255,255,255,.3);
      --ink:#333;
      --muted:#666;
      --line:#e9ecef;
      --gold:#b8860b;
      --shadow:0 20px 40px rgba(0,0,0,.1);
      --r:20px;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--green-1) 0%,var(--green-2) 50%,var(--sand-1) 100%);
      min-height:100vh;
      padding:20px;
    }

    .container{max-width:1200px;margin:0 auto}

    .header{color:#fff;text-align:center;margin-bottom:30px}
    .header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .header p{opacity:.9;font-size:1.1rem}

    .user-info{
      display:none;justify-content:space-between;align-items:center;
      background:var(--glass);padding:10px 20px;border-radius:20px;color:#fff;margin-bottom:20px;
      backdrop-filter: blur(12px);
    }
    .logout-btn{
      background:none;border:1px solid #fff;color:#fff;padding:6px 14px;border-radius:14px;cursor:pointer;font-size:12px
    }

    .stats-bar{display:flex;justify-content:center;gap:30px;margin-bottom:30px;flex-wrap:wrap}
    .stat-card{
      background:var(--glass);padding:14px 22px;border-radius:20px;color:#fff;text-align:center;
      border:1px solid var(--glass-2);backdrop-filter: blur(15px);transition:.25s transform,.25s background
    }
    .stat-card:hover{transform:translateY(-5px);background:rgba(255,255,255,.32)}
    .stat-number{font-size:2rem;font-weight:700;display:block}
    .stat-label{font-size:.9rem;opacity:.9}

    .nav{display:flex;gap:10px;justify-content:center;margin-bottom:30px;flex-wrap:wrap}
    .nav-btn{
      background:var(--glass);color:#fff;border:2px solid var(--glass-2);
      padding:12px 24px;border-radius:25px;cursor:pointer;transition:.25s transform,.25s background;backdrop-filter: blur(10px)
    }
    .nav-btn:hover,.nav-btn.active{background:rgba(255,255,255,.34);transform:translateY(-2px)}

    .content{
      background:rgba(255,255,255,.97);border-radius:20px;padding:30px;backdrop-filter: blur(20px);
      box-shadow:var(--shadow)
    }

    .login-screen{text-align:center;padding:60px 20px}
    .login-form{background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:420px;margin:0 auto}
    .login-form h2{color:var(--green-2);margin-bottom:10px}

    .section{display:none}
    .section.active{display:block}

    .add-book-form{
      background:linear-gradient(135deg,#f5f2e8 0%,#ede5d3 100%);
      padding:24px;border-radius:15px;margin-bottom:30px;border-left:4px solid var(--green-1)
    }

    .form-group{margin-bottom:18px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--ink)}
    .input, .select, .textarea{
      width:100%;padding:12px;border:2px solid var(--line);border-radius:8px;font-size:16px;transition:.2s border-color
    }
    .textarea{resize:vertical;min-height:100px}
    .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--green-1)}

    .btn{
      background:linear-gradient(135deg,var(--green-1) 0%,var(--green-2) 100%);
      color:#fff;border:none;padding:12px 22px;border-radius:25px;cursor:pointer;font-size:16px;font-weight:600;
      transition:.2s transform,.2s box-shadow
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(143,172,126,.4)}
    .btn-small{padding:6px 12px;font-size:12px;margin:2px}
    .btn-danger{background:#dc3545}

    .search-filter{display:flex;gap:15px;margin-bottom:25px;flex-wrap:wrap}
    .search-input{flex:1;min-width:220px}
    .filter-select{min-width:160px}

    .book-feed{display:flex;flex-direction:column;gap:24px}

    .book-post{
      background:#fff;border-radius:15px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.1);
      transition:.25s transform,.25s box-shadow;border-left:4px solid var(--green-1)
    }
    .book-post:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,0,0,.15)}

    .post-header{display:flex;gap:18px;margin-bottom:16px;align-items:flex-start}
    .book-cover{width:100px;height:150px;object-fit:cover;border-radius:10px;border:2px solid var(--line);flex-shrink:0}
    .book-cover-placeholder{
      width:100px;height:150px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);
      border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#6c757d;text-align:center;flex-shrink:0
    }

    .book-info{flex:1}
    .book-title{font-size:1.35rem;font-weight:800;color:var(--ink);margin-bottom:6px}
    .book-author{color:#666;margin-bottom:6px;font-style:italic}
    .book-genre{
      background:var(--green-1);color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;font-weight:700;text-transform:uppercase;display:inline-block;margin-bottom:8px
    }
    .book-recommender{font-size:.95rem;color:var(--green-2);font-weight:600;margin-bottom:10px}
    .book-rating{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .stars{display:flex;gap:3px}
    .star{font-size:18px;color:#999;cursor:pointer;transition:color .15s}
    .star.filled,.star:hover{color:var(--gold)}

    .book-description{color:#555;line-height:1.6;margin-bottom:16px}

    .post-actions{
      display:flex;gap:12px;align-items:center;padding:12px 0;border-top:1px solid #f0f0f0;border-bottom:1px solid #f0f0f0;margin-bottom:14px;flex-wrap:wrap
    }
    .action-btn{
      background:none;border:1px solid var(--green-1);color:var(--green-1);padding:8px 14px;border-radius:20px;cursor:pointer;transition:.2s;
      font-size:14px;display:flex;align-items:center;gap:6px
    }
    .action-btn:hover,.action-btn.active{background:var(--green-1);color:#fff}

    .comments-section{margin-top:8px}
    .comment{background:#f8f9fa;padding:12px;border-radius:10px;margin-bottom:10px}
    .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .commenter-name{font-weight:700;color:var(--green-2)}
    .comment-rating{color:var(--gold);font-size:14px}
    .comment-text{color:#555;margin-bottom:8px}
    .like-comment-btn{background:none;border:none;color:#999;font-size:12px;cursor:pointer}
    .like-comment-btn.liked,.like-comment-btn:hover{color:var(--green-2)}

    .add-comment{margin-top:10px;background:#fff;padding:14px;border:1px solid #dee2e6;border-radius:10px}
    .comment-form{display:flex;flex-direction:column;gap:10px}
    .comment-input-row{display:flex;gap:10px;align-items:center}
    .comment-input{flex:1;padding:8px 12px;border:1px solid #dee2e6;border-radius:6px;font-size:14px}
    .comment-textarea{padding:10px 12px;border:1px solid #dee2e6;border-radius:6px;resize:vertical;min-height:60px}

    .reading-list{background:#fff;border-radius:15px;padding:18px;margin-bottom:18px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .reading-list h3{color:var(--green-2);margin-bottom:10px}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0}
    .list-item:last-child{border-bottom:none}

    .empty-state{text-align:center;padding:50px 20px;color:#666}

    .toast{
      position:fixed;bottom:24px;right:24px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);
      transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)
    }
    .toast.show{opacity:1;transform:translateY(0)}
    @media (max-width:768px){
      .post-header{flex-direction:column;align-items:center;text-align:center}
      .post-actions{flex-wrap:wrap}
      .search-filter{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header" role="banner">
      <h1>US Probation Book Club</h1>
      <p>Find your next favorite book with your colleagues</p>
    </div>

    <div id="user-info" class="user-info" aria-live="polite">
      <span>Welcome, <strong id="current-user-name"></strong>!</span>
      <button class="logout-btn" id="logout-btn" type="button" aria-label="Switch user">Switch User</button>
    </div>

    <div class="stats-bar" role="region" aria-label="Stats">
      <div class="stat-card"><span class="stat-number" id="total-books">0</span><span class="stat-label">Books</span></div>
      <div class="stat-card"><span class="stat-number" id="total-reviews">0</span><span class="stat-label">Reviews</span></div>
      <div class="stat-card"><span class="stat-number" id="avg-rating">0.0</span><span class="stat-label">Avg Rating</span></div>
      <div class="stat-card"><span class="stat-number" id="books-read">0</span><span class="stat-label">Books Read</span></div>
    </div>

    <nav class="nav" aria-label="Primary">
      <button class="nav-btn active" id="feed-btn" type="button">Book Feed</button>
      <button class="nav-btn" id="add-btn" type="button">Add Book</button>
      <button class="nav-btn" id="my-books-btn" type="button">My Lists</button>
      <button class="nav-btn" id="professional-btn" type="button">Professional Books</button>
    </nav>

    <main class="content" id="app-root">
      <!-- Login Screen -->
      <section id="login-section" class="login-screen" aria-label="Login">
        <form class="login-form" id="login-form" novalidate>
          <h2>Welcome to the Book Club!</h2>
          <p style="margin-bottom:20px;color:#666">Enter your first name to access your personal reading lists</p>
          <div class="form-group">
            <label for="username-input" class="visually-hidden">First name</label>
            <input class="input" type="text" id="username-input" placeholder="Enter your first name" autocomplete="given-name" required style="text-align:center" />
          </div>
          <button class="btn" type="submit">Join Book Club</button>
        </form>
      </section>

      <!-- Main App -->
      <section id="main-app" style="display:none">
        <!-- Book Feed -->
        <section id="feed" class="section active" aria-label="Book Feed">
          <div class="search-filter">
            <input type="text" class="input search-input" placeholder="Search books..." id="search-input" aria-label="Search books" />
            <select class="select filter-select" id="category-filter" aria-label="Filter by category">
              <option value="">All Categories</option>
              <option value="professional">Professional</option>
              <option value="fiction">Fiction</option>
              <option value="non-fiction">Non-Fiction</option>
              <option value="biography">Biography</option>
              <option value="self-help">Self-Help</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div id="books-feed" class="book-feed"></div>
        </section>

        <!-- Add Book -->
        <section id="add" class="section" aria-label="Add Book">
          <div class="add-book-form">
            <h2 style="margin-bottom:14px;color:#333">Share a Book Recommendation</h2>
            <form id="book-form" novalidate>
              <div class="form-group">
                <label for="title">Book Title</label>
                <input class="input" type="text" id="title" required />
              </div>
              <div class="form-group">
                <label for="author">Author</label>
                <input class="input" type="text" id="author" required />
              </div>
              <div class="form-group">
                <label for="genre">Category</label>
                <select class="select" id="genre">
                  <option value="fiction">Fiction</option>
                  <option value="non-fiction">Non-Fiction</option>
                  <option value="biography">Biography</option>
                  <option value="self-help">Self-Help</option>
                  <option value="other">Other</option>
                  <option value="professional">Professional</option>
                </select>
              </div>
              <div class="form-group">
                <label for="recommender">Your Name</label>
                <input class="input" type="text" id="recommender" required />
              </div>
              <div class="form-group">
                <label for="book-image">Book Cover Image (optional)</label>
                <input class="input" type="url" id="book-image" placeholder="https://example.com/book-cover.jpg" />
              </div>
              <div class="form-group">
                <label for="description">Why you recommend it</label>
                <textarea class="textarea" id="description" required placeholder="Tell your colleagues why they should read this book..."></textarea>
              </div>
              <div class="form-group" aria-label="Your Rating">
                <label>Your Rating</label>
                <div class="stars" id="rating-stars" role="radiogroup" aria-label="Rating from 1 to 5">
                  <button class="star" type="button" data-rating="1" aria-pressed="false" aria-label="1 star">‚òÖ</button>
                  <button class="star" type="button" data-rating="2" aria-pressed="false" aria-label="2 stars">‚òÖ</button>
                  <button class="star" type="button" data-rating="3" aria-pressed="false" aria-label="3 stars">‚òÖ</button>
                  <button class="star" type="button" data-rating="4" aria-pressed="false" aria-label="4 stars">‚òÖ</button>
                  <button class="star" type="button" data-rating="5" aria-pressed="true"  aria-label="5 stars">‚òÖ</button>
                </div>
              </div>
              <button type="submit" class="btn">Share Book</button>
            </form>
          </div>
        </section>

        <!-- My Lists -->
        <section id="my-books" class="section" aria-label="My Reading Lists">
          <h2 style="margin-bottom:12px;color:#333">My Reading Lists</h2>

          <div class="reading-list">
            <h3>Currently Reading</h3>
            <div id="current-reading"></div>
          </div>

          <div class="reading-list">
            <h3>Want to Read</h3>
            <div id="wish-list"></div>
          </div>

          <div class="reading-list">
            <h3>Books I've Read</h3>
            <div id="read-list"></div>
          </div>
        </section>

        <!-- Professional Books -->
        <section id="professional" class="section" aria-label="Professional Development Books">
          <h2 style="margin-bottom:10px;color:#333">Professional Development Books</h2>
          <p style="margin-bottom:18px;color:#666">Books relevant to probation work, criminal justice, and professional growth</p>
          <div id="professional-books" class="book-feed"></div>
        </section>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /***************
     * State & Store
     ***************/
    const LS_KEYS = {
      books: 'bookclub_books',
      users: 'bookclub_userData',
      current: 'bookclub_currentUser'
    };

    let currentUser = '';
    let books = [];
    let userData = {};
    let currentRating = 5;               // "Add Book" rating
    let currentBooks = [];               // filtered view
    const commentRatings = new Map();    // per-book temporary comment rating

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const showToast = (msg) => {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> t.classList.remove('show'), 1800);
    };

    const saveState = () => {
      localStorage.setItem(LS_KEYS.books, JSON.stringify(books));
      localStorage.setItem(LS_KEYS.users, JSON.stringify(userData));
      localStorage.setItem(LS_KEYS.current, currentUser);
    };

    const loadState = () => {
      try{
        const b = JSON.parse(localStorage.getItem(LS_KEYS.books) || 'null');
        const u = JSON.parse(localStorage.getItem(LS_KEYS.users) || 'null');
        const c = localStorage.getItem(LS_KEYS.current) || '';
        if(Array.isArray(b) && b.length) books = b;
        if(u && typeof u === 'object') userData = u;
        if(c) currentUser = c;
      }catch(e){ /* ignore */ }
    };

    /**********************
     * Seed (first run only)
     **********************/
    const seedBooks = () => ([
      {
        id: 1,
        title: "The Body Keeps the Score",
        author: "Bessel van der Kolk",
        genre: "professional",
        recommender: "Dr. Sarah Johnson",
        description: "Essential reading for understanding trauma's impact on the brain and body. Directly applicable to our work with clients.",
        rating: 5,
        image: "",
        postLikes: 8,
        postLikedBy: ["Mike","Jennifer","Tom","Lisa","David","Maria","Alex","Chris"],
        comments: [
          { id: 101, commenter: "Mike Rodriguez", rating: 5, text: "Changed how I approach trauma-informed supervision.", likes: 3, likedBy: ["Sarah","Jennifer","Tom"] },
          { id: 102, commenter: "Jennifer Martinez", rating: 4, text: "Dense but worth it. I refer back to chapters regularly.", likes: 2, likedBy: ["Mike","Sarah"] }
        ]
      },
      {
        id: 2,
        title: "Just Mercy",
        author: "Bryan Stevenson",
        genre: "professional",
        recommender: "Chief Probation Officer Williams",
        description: "A powerful examination of justice and mercy in the criminal justice system.",
        rating: 5,
        image: "",
        postLikes: 12,
        postLikedBy: ["Sarah","Mike","Jennifer","Tom","Lisa","David","Maria","Alex","Chris","Pat","Jordan","Sam"],
        comments: [
          { id: 201, commenter: "Lisa Chen", rating: 5, text: "Should be required reading for everyone in criminal justice.", likes: 7, likedBy: ["Sarah","Mike","Jennifer","Tom","David","Maria","Alex"] }
        ]
      },
      {
        id: 3,
        title: "Where the Crawdads Sing",
        author: "Delia Owens",
        genre: "fiction",
        recommender: "Jennifer Martinez",
        description: "Beautiful writing and a compelling mystery‚Äîgreat fiction pick!",
        rating: 4,
        image: "",
        postLikes: 6,
        postLikedBy: ["Sarah","Mike","Tom","Lisa","Maria","Alex"],
        comments: [
          { id: 301, commenter: "Tom Wilson", rating: 4, text: "Loved the setting. The mystery kept me guessing.", likes: 2, likedBy: ["Jennifer","Sarah"] }
        ]
      }
    ]);

    /*************
     * Auth flows
     *************/
    const requireUser = () => {
      if(!currentUser){
        showToast('Please log in first.');
        return false;
      }
      return true;
    };

    const initUserIfNeeded = (name) => {
      if(!userData[name]){
        userData[name] = { readList:[], wishList:[], currentReading:[] };
      }
    };

    const login = (name) => {
      currentUser = name.trim();
      initUserIfNeeded(currentUser);
      $('#login-section').style.display = 'none';
      $('#main-app').style.display = 'block';
      $('#user-info').style.display = 'flex';
      $('#current-user-name').textContent = currentUser;
      saveState();
      updateStats();
      renderBooks();
      renderMyLists();
    };

    const logout = () => {
      currentUser = '';
      saveState();
      $('#login-section').style.display = 'block';
      $('#main-app').style.display = 'none';
      $('#user-info').style.display = 'none';
      $('#username-input').value = '';
    };

    /**********************
     * Navigation & Sections
     **********************/
    const showSection = (id, buttonEl) => {
      $$('.section').forEach(s => s.classList.remove('active'));
      $$('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      buttonEl.classList.add('active');

      if(id === 'my-books') renderMyLists();
      if(id === 'professional') renderProfessionalBooks();
    };

    /*****************
     * Rating (form)
     *****************/
    const updateFormStarDisplay = () => {
      const stars = $$('#rating-stars .star');
      stars.forEach((btn, i) => {
        const filled = i < currentRating;
        btn.classList.toggle('filled', filled);
        btn.setAttribute('aria-pressed', String(filled && i === currentRating-1));
      });
    };

    /*****************
     * Stats & Helpers
     *****************/
    const formatStars = (n) => '‚òÖ'.repeat(n) + '‚òÜ'.repeat(5-n);

    const getCurrentUserData = () =>
      userData[currentUser] || { readList:[], wishList:[], currentReading:[] };

    const updateStats = () => {
      const totalBooks = books.length;
      const totalComments = books.reduce((s,b)=> s + (b.comments?.length||0), 0);
      const avg = totalBooks ? (books.reduce((s,b)=> s + (b.rating||0), 0) / totalBooks) : 0;
      const readCount = getCurrentUserData().readList.length;
      $('#total-books').textContent = String(totalBooks);
      $('#total-reviews').textContent = String(totalComments);
      $('#avg-rating').textContent = avg.toFixed(1);
      $('#books-read').textContent = String(readCount);
    };

    /******************
     * Render functions
     ******************/
    const bookCoverBlock = (book) => {
      // Render both img and placeholder; swap to placeholder on error.
      return `
        ${book.image ? `
          <img class="book-cover" loading="lazy" alt="Cover of ${escapeHtml(book.title)}" src="${escapeAttr(book.image)}" />
          <div class="book-cover-placeholder" style="display:none" aria-hidden="true">No Cover</div>
        ` : `<div class="book-cover-placeholder" aria-hidden="true">No Cover</div>`}
      `;
    };

    const escapeHtml = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    const escapeAttr = (s='') => escapeHtml(s).replaceAll('"','&quot;');

    const bookCard = (book) => {
      const liked = currentUser && book.postLikedBy.includes(currentUser);
      return `
        <article class="book-post" data-id="${book.id}">
          <div class="post-header">
            ${bookCoverBlock(book)}
            <div class="book-info">
              <div class="book-genre">${escapeHtml(book.genre)}</div>
              <h3 class="book-title">${escapeHtml(book.title)}</h3>
              <div class="book-author">by ${escapeHtml(book.author)}</div>
              <div class="book-recommender">Recommended by ${escapeHtml(book.recommender)}</div>
              <div class="book-rating">
                <div class="stars" aria-label="Average rating">${formatStars(book.rating)}</div>
                <span>(${book.rating}/5)</span>
              </div>
            </div>
          </div>

          <p class="book-description">${escapeHtml(book.description)}</p>

          <div class="post-actions">
            <button class="action-btn ${liked ? 'active':''}" type="button" data-action="like" data-id="${book.id}">
              üëç <span data-like-count>${book.postLikes}</span> Likes
            </button>
            <button class="action-btn" type="button" data-action="wish" data-id="${book.id}">
              üìö Want to Read
            </button>
            <button class="action-btn" type="button" data-action="reading" data-id="${book.id}">
              üìñ Currently Reading
            </button>
            <button class="action-btn" type="button" data-action="read" data-id="${book.id}">
              ‚úÖ Mark as Read
            </button>
          </div>

          <div class="comments-section">
            <strong>Comments (${book.comments.length}):</strong>
            ${book.comments.map(c => `
              <div class="comment" data-comment-id="${c.id}">
                <div class="comment-header">
                  <span class="commenter-name">${escapeHtml(c.commenter)}</span>
                  <span class="comment-rating">${formatStars(c.rating)}</span>
                </div>
                <div class="comment-text">${escapeHtml(c.text)}</div>
                <div class="comment-actions">
                  <button class="like-comment-btn ${currentUser && c.likedBy.includes(currentUser) ? 'liked':''}" type="button" data-action="like-comment" data-id="${book.id}" data-cid="${c.id}">
                    üëç ${c.likes}
                  </button>
                </div>
              </div>
            `).join('')}

            <div class="add-comment">
              <div class="comment-form" data-id="${book.id}">
                <div class="comment-input-row">
                  <input type="text" placeholder="Your name" class="comment-input" data-field="name" />
                  <div class="stars comment-stars" role="radiogroup" aria-label="Comment rating" data-role="comment-stars" data-id="${book.id}">
                    ${[1,2,3,4,5].map(n => `<button class="star ${n<= (commentRatings.get(book.id) || 5) ? 'filled':''}" type="button" data-action="comment-rating" data-id="${book.id}" data-rating="${n}" aria-label="${n} star">‚òÖ</button>`).join('')}
                  </div>
                </div>
                <textarea placeholder="Write your comment..." class="comment-textarea" data-field="text"></textarea>
                <button class="btn btn-small" type="button" data-action="add-comment" data-id="${book.id}">Add Comment</button>
              </div>
            </div>
          </div>
        </article>
      `;
    };

    const attachImageFallbacks = (rootEl) => {
      $$('.book-cover', rootEl).forEach(img => {
        img.addEventListener('error', () => {
          const ph = img.nextElementSibling;
          if(ph && ph.classList.contains('book-cover-placeholder')){
            ph.style.display = 'flex';
          }
          img.remove();
        }, { once:true });
      });
    };

    const renderBooks = () => {
      const container = $('#books-feed');
      if(!currentBooks.length){
        container.innerHTML = `
          <div class="empty-state">
            <h3>No books found</h3>
            <p>Try adjusting your search or add a new recommendation!</p>
          </div>`;
        return;
      }
      container.innerHTML = currentBooks.map(bookCard).join('');
      // default comment rating to 5 for visible books
      currentBooks.forEach(b => commentRatings.set(b.id, 5));
      attachImageFallbacks(container);
    };

    const renderProfessionalBooks = () => {
      const list = books.filter(b => b.genre === 'professional');
      const container = $('#professional-books');
      if(!list.length){
        container.innerHTML = `
          <div class="empty-state">
            <h3>No professional books yet</h3>
            <p>Be the first to recommend a professional development book!</p>
          </div>`;
        return;
      }
      container.innerHTML = list.map(bookCard).join('');
      list.forEach(b => commentRatings.set(b.id, 5));
      attachImageFallbacks(container);
    };

    const renderMyLists = () => {
      const data = getCurrentUserData();

      const renderList = (arr, actions) => {
        if(!arr.length) return `<p style="color:#999;font-style:italic">Nothing here yet</p>`;
        return arr.map(book => `
          <div class="list-item" data-id="${book.id}">
            <div>
              <strong>${escapeHtml(book.title)}</strong> by ${escapeHtml(book.author)}
              <div style="color:#666;font-size:.9rem">Recommended by ${escapeHtml(book.recommender)}</div>
            </div>
            <div>
              ${actions(book)}
            </div>
          </div>
        `).join('');
      };

      $('#current-reading').innerHTML = renderList(data.currentReading, (b)=>`
        <button class="btn btn-small" type="button" data-action="read" data-id="${b.id}">Mark as Read</button>
        <button class="btn btn-small btn-danger" type="button" data-action="remove-current" data-id="${b.id}">Remove</button>
      `);

      $('#wish-list').innerHTML = renderList(data.wishList, (b)=>`
        <button class="btn btn-small" type="button" data-action="reading" data-id="${b.id}">Start Reading</button>
        <button class="btn btn-small btn-danger" type="button" data-action="remove-wish" data-id="${b.id}">Remove</button>
      `);

      $('#read-list').innerHTML = renderList(data.readList, (b)=>`
        <button class="btn btn-small btn-danger" type="button" data-action="remove-read" data-id="${b.id}">Remove</button>
      `);
    };

    /***********************
     * CRUD-like operations
     ***********************/
    const addBook = (payload) => {
      const newBook = {
        id: Date.now(),
        title: payload.title,
        author: payload.author,
        genre: payload.genre,
        recommender: payload.recommender,
        description: payload.description,
        rating: payload.rating,
        image: payload.image || "",
        postLikes: 0,
        postLikedBy: [],
        comments: []
      };
      books.unshift(newBook);
      saveState();
      updateStats();
      filterBooks(); // respect current search/filter
      showSection('feed', $('#feed-btn'));
      showToast('Book shared!');
    };

    const togglePostLike = (bookId) => {
      if(!requireUser()) return;
      const book = books.find(b => b.id === bookId);
      if(!book) return;
      const idx = book.postLikedBy.indexOf(currentUser);
      if(idx >= 0){
        book.postLikedBy.splice(idx,1);
        book.postLikes = Math.max(0, book.postLikes - 1);
      } else {
        book.postLikedBy.push(currentUser);
        book.postLikes += 1;
      }
      saveState();
      filterBooks(); // re-render current view
    };

    const toggleCommentLike = (bookId, commentId) => {
      if(!requireUser()) return;
      const book = books.find(b => b.id === bookId);
      if(!book) return;
      const c = book.comments.find(c => c.id === commentId);
      if(!c) return;
      const i = c.likedBy.indexOf(currentUser);
      if(i >= 0){ c.likedBy.splice(i,1); c.likes = Math.max(0,c.likes-1); }
      else { c.likedBy.push(currentUser); c.likes += 1; }
      saveState();
      filterBooks();
    };

    const addComment = (bookId, name, text, rating) => {
      if(!requireUser()) return;
      const book = books.find(b => b.id === bookId);
      if(!book) return;
      if(!name || !text){ showToast('Enter your name and comment'); return; }
      book.comments.push({
        id: Date.now(),
        commenter: name.trim(),
        rating: rating || 5,
        text: text.trim(),
        likes: 0,
        likedBy: []
      });
      saveState();
      updateStats();
      filterBooks();
      showToast('Comment added!');
    };

    // User lists
    const addToWishList = (bookId) => {
      if(!requireUser()) return;
      const book = books.find(b => b.id === bookId);
      const data = getCurrentUserData();
      if(!data.wishList.find(i => i.id === bookId)){
        data.wishList.push(book);
        saveState();
        showToast(`"${book.title}" added to Wish List`);
      } else showToast('Already in Wish List');
    };

    const addToCurrentReading = (bookId) => {
      if(!requireUser()) return;
      const book = books.find(b => b.id === bookId);
      const data = getCurrentUserData();
      if(!data.currentReading.find(i => i.id === bookId)){
        data.currentReading.push(book);
        data.wishList = data.wishList.filter(i => i.id !== bookId);
        saveState();
        renderMyLists();
        showToast(`"${book.title}" added to Currently Reading`);
      } else showToast('Already in Currently Reading');
    };

    const markAsRead = (bookId) => {
      if(!requireUser()) return;
      const book = books.find(b => b.id === bookId);
      const data = getCurrentUserData();
      if(!data.readList.find(i => i.id === bookId)){
        data.readList.push(book);
        data.wishList = data.wishList.filter(i => i.id !== bookId);
        data.currentReading = data.currentReading.filter(i => i.id !== bookId);
        saveState();
        updateStats();
        renderMyLists();
        showToast(`Marked "${book.title}" as read`);
      } else showToast('Already marked as read');
    };

    const removeFromList = (listName, bookId) => {
      if(!requireUser()) return;
      const data = getCurrentUserData();
      data[listName] = data[listName].filter(i => i.id !== bookId);
      saveState();
      if(listName === 'readList') updateStats();
      renderMyLists();
    };

    /*****************
     * Search & Filter
     *****************/
    const filterBooks = () => {
      const term = $('#search-input').value.trim().toLowerCase();
      const cat = $('#category-filter').value;
      currentBooks = books.filter(b => {
        const inSearch = !term || [b.title,b.author,b.recommender].some(x => x.toLowerCase().includes(term));
        const inCat = !cat || b.genre === cat;
        return inSearch && inCat;
      });
      renderBooks();
    };

    /*****************
     * Event Listeners
     *****************/
    document.addEventListener('DOMContentLoaded', () => {
      // Boot
      books = seedBooks();
      loadState();
      if(!books || !books.length){ books = seedBooks(); }
      currentBooks = books.slice();

      // Restore session
      if(currentUser){
        initUserIfNeeded(currentUser);
        $('#login-section').style.display = 'none';
        $('#main-app').style.display = 'block';
        $('#user-info').style.display = 'flex';
        $('#current-user-name').textContent = currentUser;
      }

      // Initial renders
      updateStats();
      renderBooks();
      updateFormStarDisplay();

      // Auth handlers
      $('#login-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = $('#username-input').value;
        if(!name.trim()){ showToast('Enter your first name'); return; }
        login(name);
      });
      $('#logout-btn').addEventListener('click', logout);

      // Nav
      $('#feed-btn').addEventListener('click', (e)=> showSection('feed', e.currentTarget));
      $('#add-btn').addEventListener('click', (e)=> showSection('add', e.currentTarget));
      $('#my-books-btn').addEventListener('click', (e)=> {
        if(!requireUser()) return;
        showSection('my-books', e.currentTarget);
      });
      $('#professional-btn').addEventListener('click', (e)=> showSection('professional', e.currentTarget));

      // Search/filter
      $('#search-input').addEventListener('input', filterBooks);
      $('#category-filter').addEventListener('change', filterBooks);

      // Add Book: rating stars
      $('#rating-stars').addEventListener('click', (e)=>{
        const btn = e.target.closest('.star');
        if(!btn) return;
        currentRating = parseInt(btn.dataset.rating,10);
        updateFormStarDisplay();
      });

      // Add Book: submit
      $('#book-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        if(!requireUser()) return;
        const payload = {
          title: $('#title').value.trim(),
          author: $('#author').value.trim(),
          genre: $('#genre').value,
          recommender: $('#recommender').value.trim(),
          description: $('#description').value.trim(),
          image: $('#book-image').value.trim(),
          rating: currentRating
        };
        if(!payload.title || !payload.author || !payload.recommender || !payload.description){
          showToast('Please fill in all required fields.');
          return;
        }
        addBook(payload);
        e.target.reset();
        currentRating = 5;
        updateFormStarDisplay();
      });

      // Feed actions (event delegation): likes, wish/reading/read, comments, comment likes, comment rating
      const handleFeedClick = (e) => {
        const btn = e.target.closest('[data-action]');
        if(!btn) return;

        const action = btn.dataset.action;
        const id = parseInt(btn.dataset.id,10);

        if(action === 'like'){ togglePostLike(id); return; }
        if(action === 'wish'){ addToWishList(id); return; }
        if(action === 'reading'){ addToCurrentReading(id); return; }
        if(action === 'read'){ markAsRead(id); return; }
        if(action === 'like-comment'){
          const cid = parseInt(btn.dataset.cid,10);
          toggleCommentLike(id, cid);
          return;
        }
        if(action === 'add-comment'){
          const form = btn.closest('.comment-form');
          const name = $('[data-field="name"]', form).value;
          const text = $('[data-field="text"]', form).value;
          const rating = commentRatings.get(id) || 5;
          addComment(id, name, text, rating);
          return;
        }
        if(action === 'comment-rating'){
          const rating = parseInt(btn.dataset.rating,10);
          const bookId = parseInt(btn.dataset.id,10);
          commentRatings.set(bookId, rating);
          // update visual inside that comment star group only
          const group = btn.closest('[data-role="comment-stars"]');
          $$('.star', group).forEach(s => s.classList.toggle('filled', parseInt(s.dataset.rating,10) <= rating));
          return;
        }
      };
      $('#books-feed').addEventListener('click', handleFeedClick);
      $('#professional-books').addEventListener('click', handleFeedClick);
      $('#my-books').addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn) return;
        const id = parseInt(btn.dataset.id,10);
        const action = btn.dataset.action;
        if(action === 'reading'){ addToCurrentReading(id); }
        else if(action === 'read'){ markAsRead(id); }
        else if(action === 'remove-current'){ removeFromList('currentReading', id); }
        else if(action === 'remove-wish'){ removeFromList('wishList', id); }
        else if(action === 'remove-read'){ removeFromList('readList', id); }
      });
    });
  </script>
</body>
</html>
